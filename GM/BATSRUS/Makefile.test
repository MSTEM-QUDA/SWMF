#^CFG FILE TESTING

### TESTS FOR STAND-ALONE BATSRUS ###

test:	test_func test_titan
	ls -l *.diff

# All tests are done in this directory:
TESTDIR = run_test

# Reference solution is put into this directory when needed:
REFDIR = run_test_ref

### FUNCTIONALITY TEST SUITE ###

test_func:
	make test_func_compile
	make test_func_run
	make test_func_check

test_func_compile:
	make clean
	Options.pl -u=Default -e=Mhd
	GridSize.pl -g=8,8,8,400,100
	make BATSRUS PIDL PSPH

test_func_run:
	rm -rf ${TESTDIR}
	make rundir RUNDIR=${TESTDIR} STANDALONE=GM GMDIR=`pwd`
	./TestSuite.pl -d=${TESTDIR} func

test_func_check:
	rm -rf ${REFDIR}; mkdir ${REFDIR}
	cd ${REFDIR}; tar -xzf ../Param/TESTSUITE/TEST.tgz
	./TestCompare.pl -q -v -o=1e-12 ${TESTDIR} ${REFDIR} > test_func.diff
	./TestCompare.pl -speed ${TESTDIR} ${REFDIR} > test_func.speed
	ls -l test_func.diff test_func.speed

### TESTS FOR MODELING TITAN ###

test_titan:
	make test_titan_start
	make test_titan_restart

test_titan_start:
	make test_titan_compile
	make test_titan_rundir
	make test_titan_run
	make test_titan_check

test_titan_compile:
	make clean
	Options.pl -u=Titan -e=MhdTitan
	GridSize.pl -g=4,4,4,2000,200
	make
	make PIDL

test_titan_rundir:
	rm -rf ${TESTDIR}
	make rundir RUNDIR=${TESTDIR} STANDALONE=GM GMDIR=`pwd`
	cd ${TESTDIR}; \
		cp GM/Param/TITAN/PARAM.in .; \
		tar xzf GM/Param/TITAN/TitanInput.tgz
	#./TestParam.pl -n=1 ${TESTDIR}/PARAM.in

test_titan_run:
	cd ${TESTDIR}; ./BATSRUS.exe > runlog
	cd ${TESTDIR}; rm -rf TitanTest
	cd ${TESTDIR}; PostProc.pl -M -o TitanTest

test_titan_check:
	${SCRIPTDIR}/DiffNum.pl -t -a=1e-15 \
		Param/TITAN/TestOutput/log_n000001.log \
		${TESTDIR}/TitanTest/GM/log_n000001.log > test_titan.diff
	ls -l test_titan.diff

test_titan_restart:
	make test_titan_restart_save
	make test_titan_restart_read
	make test_titan_restart_check

test_titan_restart_save:
	cd ${TESTDIR}; cp GM/Param/TITAN/PARAM.in.restartsave PARAM.in
	#./TestParam.pl -n=1 ${TESTDIR}/PARAM.in
	cd ${TESTDIR};	./BATSRUS.exe > runlog
	cd ${TESTDIR}; rm -rf TitanTest/RestartSave RESTART_titan
	cd ${TESTDIR}; PostProc.pl -M -o TitanTest/RestartSave
	cd ${TESTDIR}; Restart.pl -o RESTART_titan; 

test_titan_restart_read:
	cd ${TESTDIR}; cp GM/Param/TITAN/PARAM.in.restartread PARAM.in
	#./TestParam.pl -n=1 ${TESTDIR}/PARAM.in
	cd ${TESTDIR}; Restart.pl -i RESTART_titan
	cd ${TESTDIR}; ./BATSRUS.exe > runlog
	cd ${TESTDIR}; rm -rf TitanTest/RestartRead
	cd ${TESTDIR}; PostProc.pl -M -o TitanTest/RestartRead

test_titan_restart_check:
	cd ${TESTDIR}/TitanTest; \
		cp RestartSave/GM/log_n000001.log log_all.log; \
		tail -25 RestartRead/GM/log_n000026.log >> log_all.log
	${SCRIPTDIR}/DiffNum.pl -t -a=1e-15 \
		Param/TITAN/TestOutput/log_n000001.log \
		${TESTDIR}/TitanTest/log_all.log > test_titan_restart.diff
	ls -l test_titan_restart.diff
