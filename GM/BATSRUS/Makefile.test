#^CFG FILE TESTING

### TESTS FOR THE STAND-ALONE BATSRUS ###

test: 
	@rm -f *.diff
	-@(make test_shocktube)
	-@(make test_multifluid)
	-@(make test_multiion)
	-@(make test_corona)
	-@(make test_titan)
	-@(make test_mars)
	-@(make test_venus)
	-@(make test_func)
	@ls -l *.diff

# All tests are done in this directory:
TESTDIR = run_test

# Reference solution is put into this directory when needed:
REFDIR = run_test_ref

# Tests are done either parallel or serial. Default:
MPIRUN = mpirun -np 2

test_help:
	@echo "    test                       (run all tests with ${MPIRUN})"
	@echo "    test MPIRUN=               (run all tests serially)"
	@echo "    test MPIRUN='mpirun -np 3' (run test with mpirun -np 3)"
	@echo "    test MPIRUN='mprun -np 2'  (run test with mprun -np 2)"
	@echo "    test_shocktube             (run shocktube test only)"
	@echo "    test_multifluid            (run multi-fluid test only)"
	@echo "    test_multiion              (run multi-ion test only)"
	@echo "    test_corona                (run Solar Corona test only)"
	@echo "    test_mars                  (run Mars test only)"
	@echo "    test_venus                 (run Venus test only)"
	@echo "    test_titan                 (run titan tests only)"
	@echo "    test_titan_start           (run first titan test only)"
	@echo "    test_titan_restart         (run titan restart test only)"
	@echo "    test_func                  (run functionality tests only)"

test_rundir:
	rm -rf ${TESTDIR}
	make rundir RUNDIR=${TESTDIR} STANDALONE=YES GMDIR=`pwd`


### SHOCK TUBE TEST ###

test_shocktube:
	@echo "test_shocktube_compile..." > test_shocktube.diff
	make test_shocktube_compile
	@echo "test_shocktube_rundir..." >> test_shocktube.diff
	make test_shocktube_rundir
	@echo "test_shocktube_run..." >> test_shocktube.diff
	make test_shocktube_run
	@echo "test_shocktube_check..." >> test_shocktube.diff
	make test_shocktube_check

test_shocktube_compile:
	./Config.pl -u=Default -e=Mhd -g=256,4,4,10,1
	make
	make PIDL

test_shocktube_rundir: test_rundir
	cd ${TESTDIR}; cp Param/SHOCKTUBE/PARAM.in .

test_shocktube_run:
	cd ${TESTDIR}; ${MPIRUN} ./BATSRUS.exe > runlog

test_shocktube_check:
	cat ${TESTDIR}/GM/IO2/cut_raw_2_t00000025_n0000358_pe*.idl \
		> ${TESTDIR}/GM/IO2/cut_25.idl
	${SCRIPTDIR}/DiffNum.pl -t -r=1e-5 -a=1e-13 \
	  Param/SHOCKTUBE/TestOutput/cut_25.idl \
	  ${TESTDIR}/GM/IO2/cut_25.idl > test_shocktube.diff
	ls -l test_shocktube.diff

### MULTI FLUID TEST ###

test_multifluid:
	@echo "test_multifluid_compile..." > test_multifluid.diff
	make test_multifluid_compile
	@echo "test_multifluid_rundir..." >> test_multifluid.diff
	make test_multifluid_rundir
	@echo "test_multifluid_run..." >> test_multifluid.diff
	make test_multifluid_run
	@echo "test_multifluid_check..." >> test_multifluid.diff
	make test_multifluid_check

test_multifluid_compile:
	./Config.pl -u=Default -e=MhdHd -g=256,4,4,10,1
	make
	make PIDL

test_multifluid_rundir: test_rundir
	cd ${TESTDIR}; cp Param/MULTIFLUID/PARAM.in .

test_multifluid_run:
	cd ${TESTDIR}; ${MPIRUN} ./BATSRUS.exe > runlog

test_multifluid_check:
	@echo 'Brio and Sod tests' > ${TESTDIR}/GM/IO2/cut_25.idl
	@echo 'dx x y z Rho Mx My Mz Bx By Bz e NeuRho NeuMx NeuMy NeuMz NeuE p b1x b1y b1z' >> ${TESTDIR}/GM/IO2/cut_25.idl
	cat ${TESTDIR}/GM/IO2/cut_raw_2_t00000025_n*_pe*.idl \
		>> ${TESTDIR}/GM/IO2/cut_25.idl
	${SCRIPTDIR}/DiffNum.pl -t -r=1e-5 -a=1e-12 \
	  Param/MULTIFLUID/TestOutput/cut_25.idl \
	  ${TESTDIR}/GM/IO2/cut_25.idl > test_multifluid.diff
	ls -l test_multifluid.diff

### MULTI ION TEST ###

test_multiion:
	@echo "test_multiion_compile..." > test_multiion.diff
	make test_multiion_compile
	@echo "test_multiion_rundir..." >> test_multiion.diff
	make test_multiion_rundir
	@echo "test_multiion_run..." >> test_multiion.diff
	make test_multiion_run
	@echo "test_multiion_check..." >> test_multiion.diff
	make test_multiion_check

test_multiion_compile:
	./Config.pl -u=Default -e=MultiIon -g=256,4,4,10,1
	make
	make PIDL

test_multiion_rundir: test_rundir
	cd ${TESTDIR}; cp Param/MULTIION/PARAM.in .

test_multiion_run:
	cd ${TESTDIR}; ${MPIRUN} ./BATSRUS.exe > runlog

test_multiion_check:
	cat ${TESTDIR}/GM/IO2/cut_raw_2_t00000002_n0000182_pe*.idl \
		> ${TESTDIR}/GM/IO2/cut_t2.idl
	${SCRIPTDIR}/DiffNum.pl -t -r=1e-5 -a=1e-12 \
		Param/MULTIION/TestOutput/cut_t2.idl \
		${TESTDIR}/GM/IO2/cut_t2.idl > test_multiion.diff
	ls -l test_multiion.diff

### STANDALONE SOLAR CORONA TEST ###

test_corona:
	@echo "test_corona_compile..." > test_corona.diff
	make test_corona_compile
	@echo "test_corona_rundir..." >> test_corona.diff
	make test_corona_rundir
	@echo "test_corona_run..." >> test_corona.diff
	make test_corona_run
	@echo "test_corona_check..." >> test_corona.diff
	make test_corona_check

test_corona_compile:
	./Config.pl -u=Sc -e=MhdCorona -g=4,4,4,3000,1
	make BATSRUS PIDL

test_corona_rundir:
	rm -rf ${TESTDIR}
	make rundir RUNDIR=${TESTDIR} COMPONENT=SC STANDALONE=YES GMDIR=`pwd`
	cd ${TESTDIR}; cp Param/CORONA/PARAM.in .
	cd ${TESTDIR}; cp Param/CORONA/CR1935_WSO.dat .

test_corona_run:
	cd ${TESTDIR}; ${MPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M RESULTS

test_corona_check:
	${SCRIPTDIR}/DiffNum.pl -t -r=1e-5 \
		Param/CORONA/TestOutput/log_n000001.log \
		${TESTDIR}/RESULTS/SC/log_n000001.log > test_corona.diff
	ls -l test_corona.diff

### FUNCTIONALITY TEST SUITE ###

test_func:
	@echo "test_func_compile..." > test_func.diff
	make test_func_compile
	@echo "test_func_run..." >> test_func.diff
	make test_func_run
	@echo "test_func_check..." >> test_func.diff
	make test_func_check

test_func_compile:
	./Config.pl -u=Default -e=Mhd -g=8,8,8,720,70
	make BATSRUS PIDL PSPH

test_func_run: test_rundir
	./TestSuite.pl -r='${MPIRUN} ' -d=${TESTDIR} func

test_func_check:
	rm -rf ${REFDIR}; mkdir ${REFDIR}
	cd ${REFDIR}; tar -xzf ../Param/TESTSUITE/TEST.tgz; 
	./TestCompare.pl -q -v -o=1e-8 ${REFDIR} ${TESTDIR} > test_func.diff
	./TestCompare.pl -speed ${REFDIR} ${TESTDIR} > test_func.speed
	ls -l test_func.diff test_func.speed

### TESTS FOR MODELING TITAN ###

test_titan:
	-@(make test_titan_start)
	-@(make test_titan_restart)

test_titan_start:
	@echo "test_titan_compile..." > test_titan.diff
	make test_titan_compile
	@echo "test_titan_rundir..." >> test_titan.diff
	make test_titan_rundir
	@echo "test_titan_run..." >> test_titan.diff
	make test_titan_run
	@echo "test_titan_check..." >> test_titan.diff
	make test_titan_check

test_titan_compile:
	./Config.pl -u=Titan -e=MhdTitan -g=6,6,6,1000,200
	make
	make PIDL

test_titan_rundir: test_rundir
	cd ${TESTDIR}; \
		cp Param/TITAN/PARAM.in .; \
		tar xzf Param/TITAN/TitanInput.tgz
	#./TestParam.pl -n=1 ${TESTDIR}/PARAM.in

test_titan_run:
	cd ${TESTDIR}; ${MPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; rm -rf TitanTest
	cd ${TESTDIR}; ./PostProc.pl -M -o TitanTest

test_titan_check:
	${SCRIPTDIR}/DiffNum.pl -t -r=1e-5 -a=1e-15 \
		Param/TITAN/TestOutput/log_n000001.log \
		${TESTDIR}/TitanTest/GM/log_n000001.log > test_titan.diff
	ls -l test_titan.diff

test_titan_restart:
	@echo "test_titan_restart_save..." > test_titan_restart.diff
	make test_titan_restart_save
	@echo "test_titan_restart_read..." >> test_titan_restart.diff
	make test_titan_restart_read
	@echo "test_titan_restart_check..." >> test_titan_restart.diff
	make test_titan_restart_check

test_titan_restart_save:
	cd ${TESTDIR}; cp Param/TITAN/PARAM.in.restartsave PARAM.in
	#./TestParam.pl -n=1 ${TESTDIR}/PARAM.in
	cd ${TESTDIR}; ${MPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; rm -rf TitanTest/RestartSave RESTART_titan
	cd ${TESTDIR}; ./PostProc.pl -M -o TitanTest/RestartSave
	cd ${TESTDIR}; ./Restart.pl -o RESTART_titan; 

test_titan_restart_read:
	cd ${TESTDIR}; cp Param/TITAN/PARAM.in.restartread PARAM.in
	#./TestParam.pl -n=1 ${TESTDIR}/PARAM.in
	cd ${TESTDIR}; ./Restart.pl -i RESTART_titan
	cd ${TESTDIR}; ${MPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; rm -rf TitanTest/RestartRead
	cd ${TESTDIR}; ./PostProc.pl -M -o TitanTest/RestartRead

test_titan_restart_check:
	cd ${TESTDIR}/TitanTest; \
		cp RestartSave/GM/log_n000001.log log_all.log; \
		tail -25 RestartRead/GM/log_n000026.log >> log_all.log
	${SCRIPTDIR}/DiffNum.pl -t -r=1e-5 -a=1e-15 \
		Param/TITAN/TestOutput/log_n000001.log \
		${TESTDIR}/TitanTest/log_all.log > test_titan_restart.diff
	ls -l test_titan*.diff

### TESTS FOR MODELING MARS ###

test_mars:
	-@(make test_mars_start)

test_mars_start:
	@echo "test_mars_compile..." > test_mars.diff
	make test_mars_compile
	@echo "test_mars_rundir..." >> test_mars.diff
	make test_mars_rundir
	@echo "test_mars_run..." >> test_mars.diff
	make test_mars_run
	@echo "test_mars_check..." >> test_mars.diff
	make test_mars_check

test_mars_compile:
	./Config.pl -u=Mars -e=MhdMars -g=4,4,4,2000,200
	make
	make PIDL

test_mars_rundir: test_rundir
	cd ${TESTDIR}; \
		cp Param/MARS/PARAM.in .; \
		cp Param/MARS/marsmgsp.txt .
	#./TestParam.pl -n=1 ${TESTDIR}/PARAM.in

test_mars_run:
	cd ${TESTDIR}; ${MPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; rm -rf MarsTest
	cd ${TESTDIR}; ./PostProc.pl -M -o MarsTest

test_mars_check:
	${SCRIPTDIR}/DiffNum.pl -b -r=1e-5 \
		Param/MARS/TestOutput/log_n000001.log \
		${TESTDIR}/MarsTest/GM/log_n000001.log > test_mars.diff
	ls -l test_mars.diff

### TESTS FOR MODELING VENUS ###

test_venus:
	-@(make test_venus_start)

test_venus_start:
	@echo "test_venus_compile..." > test_venus.diff
	make test_venus_compile
	@echo "test_venus_rundir..." >> test_venus.diff
	make test_venus_rundir
	@echo "test_venus_run..." >> test_venus.diff
	make test_venus_run
	@echo "test_venus_check..." >> test_venus.diff
	make test_venus_check

test_venus_compile:
	./Config.pl -u=Venus -e=MhdMars -g=6,6,6,1000,200
	make
	make PIDL

test_venus_rundir: test_rundir
	cd ${TESTDIR}; \
		cp Param/VENUS/PARAM.in .; \
	#./TestParam.pl -n=1 ${TESTDIR}/PARAM.in

test_venus_run:
	cd ${TESTDIR}; ${MPIRUN} ./BATSRUS.exe > runlog
	cd ${TESTDIR}; rm -rf VenusTest
	cd ${TESTDIR}; ./PostProc.pl -M -o VenusTest

test_venus_check:
	${SCRIPTDIR}/DiffNum.pl -b -r=1e-5 -a=1e-17 \
		Param/VENUS/TestOutput/log_n000001.log \
		${TESTDIR}/VenusTest/GM/log_n000001.log > test_venus.diff
	ls -l test_venus.diff

