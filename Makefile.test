
#^CMP COPYRIGHT UM
#^CMP FILE TESTING

TESTDIR = ${DIR}/run_test

MPIRUN = mpirun -np 2

TESTMACHINE = `hostname | sed -e 's/\..*//; s/[0-9]*$$//'`

test_help:
	@echo "    test                       (run all tests with ${MPIRUN})"
	@echo "    test MPIRUN=               (run all tests serially)"
	@echo "    test MPIRUN='mpirun -np 3' (run test with mpirun -np 3)"
	@echo "    test MPIRUN='mprun -np 2'  (run test with mprun -np 2)"
	@echo "    test_share_library         (run test share/Library only)"
	@echo "    test_comp                  (run component tests only)"
	@echo "    test_lc                    (run LC/BATSRUS only)"
	@echo "    test_pw                    (run PW/PWOM test only)"
	@echo "    test_rb                    (run RB/RBE test only)"
	@echo "    test_esmf                  (run ESMF_SWMF test only)"
	@echo "    test_ccmc                  (run CCMC test only)"
	@echo "    test1                      (run GM-IE-PW test only)"
	@echo "    test2                      (run SC-IH test only )"
	@echo "    test3                      (run GM-IE-IM test only)"
	@echo "    test4                      (run GM-IE-HEIDI test only)"
	@echo "    test6                      (run GM-IE-CRCM test only)"

test:
	@rm -f *.diff
	-@(make test_share_library)
	-@(make test_comp)
	-@(make test_lc)
	-@(make test_pw)
	-@(make test_rb)
	-@(make test_esmf)
	-@(make test1)
	-@(make test2)
	-@(make test3)
	-@(make test4)
	-@(make test6)
	-@(make test_check)

test_check:
	-@ls -ltr share/Library/test/*.diff ??/*/*.diff *.diff > test_swmf.res
	@cat test_swmf.res
	@echo '=============================================================='\
		>> test_swmf.res
	-@head -100 share/Library/test/*.diff ??/*/*.diff *.diff \
		>> test_swmf.res
	@echo ' '
	@echo 'See test_swmf.res and test_swmf.log for more detail...'
	@echo ' '
	@echo '=============================================================='\
		>> test_swmf.res
	-@cat GM/BATSRUS/test_func.speed >> test_swmf.res

### Unit tests of the share/Library

test_share_library:
	rm -f share/Library/test/*.diff
	cd share/Library/src; make LIB
	cd share/Library/test; make test
	ls -l share/Library/test/*.diff

### Component tests ###

test_comp:
	for i in `ls -d [A-Z][A-Z]/*/ | grep -v /CVS/ | grep -v /Empty/`; \
		do ( cd $$i; make test; ); done
	ls -ltr [A-Z][A-Z]/*/*.diff

### SWMF tests ###

#### Polarwind test ###
#
test_pw:
	@echo "starting..." > test_pw.diff
	@echo "test_pw_compile..." >> test_pw.diff
	make test_pw_compile
	@echo "test_pw_rundir..." >> test_pw.diff
	make test_pw_rundir
	@echo "test_pw_run..." >> test_pw.diff
	make test_pw_run
	@echo "test_pw_check..." >> test_pw.diff

	make test_pw_check

test_pw_compile:
	./Config.pl -v=Empty,PW/PWOM -o=PW:Earth
	make SWMF PIDL

test_pw_rundir:
	rm -rf ${TESTDIR}
	make rundir RUNDIR=${TESTDIR}
	cp Param/PARAM.in.test.PW ${TESTDIR}/PARAM.in
	cp Param/LAYOUT.in.test.PW ${TESTDIR}/LAYOUT.in

test_pw_run:
	cd ${TESTDIR}/PW; rm -f log.out restartOUT/* plots/*
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog

test_pw_check:
	-@(${SCRIPTDIR}/DiffNum.pl -b -r=1e-8 \
		${TESTDIR}/PW/plots/north_plots_iline0001.out \
		${PWDIR}/data/output/Earth/north_plots_iline0001.out \
		> test_pw.diff)
	ls -ltr test_pw*.diff

#### Radiation belt model test ###
#
test_rb:
	@echo "starting..." > test_rb.diff
	@echo "test_rb_compile..." >> test_rb.diff
	make test_rb_compile
	@echo "test_rb_rundir..." >> test_rb.diff
	make test_rb_rundir
	@echo "test_rb_run..." >> test_rb.diff
	make test_rb_run
	@echo "test_rb_check..." >> test_rb.diff
	make test_rb_check

test_rb_compile:
	./Config.pl -v=Empty,RB/RBE,GM/BATSRUS
	./Config.pl -g=GM:8,8,8,770,1 -o=GM:e=Mhd,u=Default
	make SWMF PIDL

test_rb_rundir:
	rm -rf ${TESTDIR}
	make rundir RUNDIR=${TESTDIR}
	cp Param/PARAM.in.test.RB ${TESTDIR}/PARAM.in
	cp Param/LAYOUT.in.test.RB ${TESTDIR}/LAYOUT.in
	cd ${TESTDIR}/RB/; ln -s ${RBDIR}/input/2002_296* .
test_rb_run:
	cd ${TESTDIR}/RB; rm -f 2002f296_e.fls
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog

test_rb_check:
	gunzip -c ${RBDIR}/data/output/2002f296_e.fls.gz \
		> ${TESTDIR}/2002f296_e.fls.ref
	${SCRIPTDIR}/DiffNum.pl -r=0.001 -a=1e-10 \
		${TESTDIR}/RB/plots/2002f296_e.fls \
		${TESTDIR}/2002f296_e.fls.ref \
		> test_rb.diff
	ls -l test_rb.diff

### Test1: PW+IE+GM ###

test1:
	@echo "test1_compile..." > test1_gm.diff
	@echo "test1_compile..." > test1_ie.diff
	@echo "test1_compile..." > test1_pw.diff
	make test1_compile
	@echo "test1_rundir..." >> test1_gm.diff
	@echo "test1_rundir..." >> test1_ie.diff
	@echo "test1_rundir..." >> test1_pw.diff
	make test1_rundir
	@echo "test1_run..." >> test1_gm.diff
	@echo "test1_run..." >> test1_ie.diff
	@echo "test1_run..." >> test1_pw.diff
	make test1_run
	@echo "test1_check..." >> test1_gm.diff
	@echo "test1_check..." >> test1_ie.diff
	@echo "test1_check..." >> test1_pw.diff
	make test1_check

test1_compile:
	./Config.pl -v=Empty,GM/BATSRUS,IE/Ridley_serial,PW/PWOM
	./Config.pl -g=GM:8,8,8,400,100 -o=GM:u=Default,e=Mhd,PW:Earth
	make SWMF PIDL

test1_rundir:
	rm -rf ${TESTDIR}
	make rundir RUNDIR=${TESTDIR}
	cp Param/PARAM.in.test.GMIEPW ${TESTDIR}/PARAM.in
	cp Param/LAYOUT.in.test.GMIEPW ${TESTDIR}/LAYOUT.in

test1_run:
	cd ${TESTDIR}/PW; rm -f log.out restartOUT/* plots/*
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M RESULTS

test1_check:
	-@(${SCRIPTDIR}/DiffNum.pl -b -r=1e-7 \
		${TESTDIR}/RESULTS/PW/north_plots_iline0001.out \
		output/test1/PW_north_plots_iline0001.out \
		> test1_pw.diff)
	-@(${SCRIPTDIR}/DiffNum.pl -b -r=1e-7 \
		${TESTDIR}/RESULTS/PW/north_plots_iline0002.out \
		output/test1/PW_north_plots_iline0002.out \
		>> test1_pw.diff)
	-@(${SCRIPTDIR}/DiffNum.pl -b -r=1e-7 \
		${TESTDIR}/RESULTS/PW/north_plots_iline0003.out \
		output/test1/PW_north_plots_iline0003.out \
		>> test1_pw.diff)
	-@(${SCRIPTDIR}/DiffNum.pl -b -r=1e-7 \
		${TESTDIR}/RESULTS/PW/north_plots_iline0004.out \
		output/test1/PW_north_plots_iline0004.out \
		>> test1_pw.diff)
	-@(${SCRIPTDIR}/DiffNum.pl -b -r=1e-3 -a=1e-8 \
		${TESTDIR}/RESULTS/GM/log_n000001.log \
		output/test1/GM_log_n000001.log \
		> test1_gm.diff)
	-@(${SCRIPTDIR}/DiffNum.pl -b -t -r=1e-6 \
		${TESTDIR}/RESULTS/IE/IE.log \
		output/test1/IE.log \
		> test1_ie.diff)
	-@(${SCRIPTDIR}/DiffNum.pl -b -r=1e-4 -a=1e-8 \
		${TESTDIR}/RESULTS/IE/it000321_104510_000.idl \
		output/test1/IE_it000321_104510_000.idl \
		>> test1_ie.diff)
	ls -l test1*.diff

### test2: SC+IH test ###

test2:
	@echo "test2_compile..." > test2_sc.diff
	@echo "test2_compile..." > test2_ih.diff
	make test2_compile
	@echo "test2_rundir..." >> test2_sc.diff
	@echo "test2_rundir..." >> test2_ih.diff
	make test2_rundir
	@echo "test2_run..." >> test2_sc.diff
	@echo "test2_run..." >> test2_ih.diff
	make test2_run
	@echo "test2_check..." >> test2_sc.diff
	@echo "test2_check..." >> test2_ih.diff
	make test2_check

test2_compile:
	./Config.pl -v=Empty,SC/BATSRUS,IH/BATSRUS
	./Config.pl -g=SC:4,4,4,3000,1,IH:8,8,8,400,1
	cd SC/BATSRUS; ./Config.pl -dynamic; cd ../..
	cd IH/BATSRUS; ./Config.pl -dynamic; cd ../..
	make SWMF PIDL EARTH_TRAJ

test2_rundir:
	rm -rf ${TESTDIR}
	make rundir RUNDIR=${TESTDIR}
	cp Param/PARAM.in.test.SCIH ${TESTDIR}/PARAM.in
	cp Param/LAYOUT.in.test.SCIH ${TESTDIR}/LAYOUT.in
	cd ${TESTDIR}/IH; cp Param/EARTH_TRAJ.in .; \
		${BINDIR}/EARTH_TRAJ.exe > earth_traj.dat

test2_run:
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M RESULTS

test2_check:
	-(${SCRIPTDIR}/DiffNum.pl -b -r=1e-5 \
		${TESTDIR}/RESULTS/SC/log_n000001.log \
		output/test2/SC_log_n000001.log \
		> test2_sc.diff)
	-(${SCRIPTDIR}/DiffNum.pl -b -r=1e-5 \
		${TESTDIR}/RESULTS/IH/log_n000001.log \
		output/test2/IH_log_n000001.log \
		> test2_ih.diff)
	-(${SCRIPTDIR}/DiffNum.pl -b -r=1e-5 \
		${TESTDIR}/RESULTS/IH/sat_earth_traj_n000000.sat \
		output/test2/IH_sat_earth_traj_n000000.sat \
		>> test2_ih.diff)
	ls -l test2*.diff

### Test3: GM+IE+IM ###

test3:
	@echo "test3_compile..." > test3_gm.diff
	@echo "test3_compile..." > test3_ie.diff
	@echo "test3_compile..." > test3_im_rcm.diff
	make test3_compile
	@echo "test3_rundir..." >> test3_gm.diff
	@echo "test3_rundir..." >> test3_ie.diff
	@echo "test3_rundir..." >> test3_im_rcm.diff
	make test3_rundir
	@echo "test3_run..." >> test3_gm.diff
	@echo "test3_run..." >> test3_ie.diff
	@echo "test3_run..." >> test3_im_rcm.diff
	make test3_run
	@echo "test3_restart..." >> test3_gm.diff
	@echo "test3_restart..." >> test3_ie.diff
	@echo "test3_restart..." >> test3_im_rcm.diff
	make test3_restart
	@echo "test3_check..." >> test3_gm.diff
	@echo "test3_check..." >> test3_ie.diff
	@echo "test3_check..." >> test3_im_rcm.diff
	make test3_check

test3_compile:
	./Config.pl -v=Empty,GM/BATSRUS,IE/Ridley_serial,IM/RCM2
	./Config.pl -g=GM:8,8,8,400,100 -o=GM:u=Default,e=Mhd
	make SWMF PIDL

test3_rundir:
	rm -rf ${TESTDIR}
	make rundir RUNDIR=${TESTDIR}
	cp Param/PARAM.in.test.GMIEIM ${TESTDIR}/PARAM.in
	cp Param/LAYOUT.in.test.GMIEIM ${TESTDIR}/LAYOUT.in

#	cp Param/midn_05.dat ${TESTDIR}/midn_05.dat
#	cp Param/noon_05.dat ${TESTDIR}/noon_05.dat

test3_run:
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog
	cd ${TESTDIR}; Restart.pl
	cd ${TESTDIR}/IE/ionosphere; mv IE.log IE_all.log

# Note: The RCM .dat file is copied to .txt to avoid conversion to .plt
test3_restart:
	cd ${TESTDIR}; cp Param/PARAM.in.test.restart.GMIEIM PARAM.in
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog_restart
	cd ${TESTDIR}/IM/plots/; cp 2d__max_t00000020.dat t20.txt
	cd ${TESTDIR}/IE/ionosphere; tail -3 IE.log >> IE_all.log
	cd ${TESTDIR}; ./PostProc.pl -M -cat RESULTS; mv runlog_restart RESULTS

test3_check:
	-@(${SCRIPTDIR}/DiffNum.pl -b -r=1e-5 -a=1e-8 \
		${TESTDIR}/RESULTS/GM/log_n000001.log \
		output/test3/GM_log_n000001.log \
		> test3_gm.diff)
	-@(${SCRIPTDIR}/DiffNum.pl -b -r=1e-5 \
		${TESTDIR}/RESULTS/IE/IE_all.log \
		output/test3/IE.log \
		> test3_ie.diff)
	gunzip -c output/test3/IM_2d__max_t00000020.dat.gz \
		> ${TESTDIR}/RESULTS/IM/t20.dat
# Remove date stamp from tecplot files
	cd ${TESTDIR}/RESULTS/IM; \
		perl -pi -e 's/AUXDATA SAVEDATE=.*//' t20.dat t20.txt
	-@(${SCRIPTDIR}/DiffNum.pl -b -r=1e-3 -a=1e-8 \
		${TESTDIR}/RESULTS/IM/t20.txt \
		${TESTDIR}/RESULTS/IM/t20.dat \
		> test3_im_rcm.diff)
	ls -l test3*.diff

### Test4: GM+IE+HEIDI ###############

test4:
	@echo "test4_compile..." > test4_gm.diff
	@echo "test4_compile..." > test4_ie.diff
	@echo "test4_compile..." > test4_im_heidi.diff
	make test4_compile
	@echo "test4_rundir..." >> test4_gm.diff
	@echo "test4_rundir..." >> test4_ie.diff
	@echo "test4_rundir..." >> test4_im_heidi.diff
	make test4_rundir
	@echo "test4_run..." >> test4_gm.diff
	@echo "test4_run..." >> test4_ie.diff
	@echo "test4_run..." >> test4_im_heidi.diff
	make test4_run
	@echo "test4_check..." >> test4_gm.diff
	@echo "test4_check..." >> test4_ie.diff
	@echo "test4_check..." >> test4_im_heidi.diff
	make test4_check

test4_compile:
	./Config.pl -v=Empty,GM/BATSRUS,IE/Ridley_serial,IM/HEIDI
	./Config.pl -g=GM:8,8,8,400,100 -o=GM:u=Default,e=Mhd
	make SWMF PIDL

test4_rundir:
	rm -rf ${TESTDIR}
	make rundir RUNDIR=${TESTDIR}
	cp Param/PARAM.in.test.GMIEHEIDI ${TESTDIR}/PARAM.in
	cp Param/LAYOUT.in.test.GMIEHEIDI ${TESTDIR}/LAYOUT.in

test4_run:
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M RESULTS

test4_check:
	-@(${SCRIPTDIR}/DiffNum.pl -b -r=1e-3 -a=1e-8 \
		${TESTDIR}/RESULTS/GM/log_n000001.log \
		output/test4/GM_log_n000001.log \
		> test4_gm.diff)
	-@(${SCRIPTDIR}/DiffNum.pl -b -t -r=1e-6 \
		${TESTDIR}/RESULTS/IE/IE.log \
		output/test4/IE.log \
		> test4_ie.diff)
	-@(${SCRIPTDIR}/DiffNum.pl -b -t -a=1e-8 -r=1e-30 \
                ${TESTDIR}/RESULTS/IM/hydrogen/test1_h_prs.002 \
                output/test4/IM_test1_h_prs.002\
                > test4_im_heidi.diff)
	ls -l test4*.diff

### test5: Lower Corona test to be extended to LC+SC+IH###
test5:
	@echo "test5_compile..." > test5.diff
	make test5_compile
	@echo "test_rundir..." >> test5.diff
	make test5_rundir
	@echo "test5_run..." >> test5.diff
	make test5_run
	@echo "test5_check..." >> test5.diff
	make test5_check

test5_compile:
	./Config.pl -v=Empty,LC/BATSRUS
	cd LC/BATSRUS; ./Config.pl -u=Lc -e=MhdWaves -setvar=nWave=2
	./Config.pl -g=LC:6,4,4,3000,1
	cd LC/BATSRUS; ./Config.pl -dynamic; cd ../..
	make SWMF PIDL

test5_rundir:
	rm -rf ${TESTDIR}
	make rundir RUNDIR=${TESTDIR}
	cp Param/PARAM.in.test.LCSCIH ${TESTDIR}/PARAM.in
	cp Param/LAYOUT.in.test.LC ${TESTDIR}/LAYOUT.in

test5_run:
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M RESULTS

test5_check:
	-(${SCRIPTDIR}/DiffNum.pl -b -r=1e-5 \
		${TESTDIR}/RESULTS/LC/log_n000001.log \
		output/test_lc/LC_log_n000001.log \
		> test5.diff)
	ls -l test5.diff

### Test6: GM+IE+IM=CRCM ###

test6:
	@echo "test6_compile..." > test6_gm.diff
	@echo "test6_compile..." > test6_ie.diff
	@echo "test6_compile..." > test6_im_crcm.diff
	make test6_compile
	@echo "test6_rundir..." >> test6_gm.diff
	@echo "test6_rundir..." >> test6_ie.diff
	@echo "test6_rundir..." >> test6_im_crcm.diff
	make test6_rundir
	@echo "test6_run..." >> test6_gm.diff
	@echo "test6_run..." >> test6_ie.diff
	@echo "test6_run..." >> test6_im_crcm.diff
	make test6_run
	@echo "test6_restart..." >> test6_gm.diff
	@echo "test6_restart..." >> test6_ie.diff
	@echo "test6_restart..." >> test6_im_crcm.diff
	make test6_restart
	@echo "test6_check..." >> test6_gm.diff
	@echo "test6_check..." >> test6_ie.diff
	@echo "test6_check..." >> test6_im_crcm.diff
	make test6_check

test6_compile:
	./Config.pl -v=Empty,GM/BATSRUS,IE/Ridley_serial,IM/CRCM
	./Config.pl -g=GM:8,8,8,400,100 -o=GM:u=Default,e=Mhd,IM:EarthHO
	make SWMF PIDL

test6_rundir:
	rm -rf ${TESTDIR}
	make rundir RUNDIR=${TESTDIR}
	cp Param/PARAM.in.test.GMIEIMCRCM ${TESTDIR}/PARAM.in
	cp Param/LAYOUT.in.test.GMIEIM ${TESTDIR}/LAYOUT.in

test6_run:
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog
	cd ${TESTDIR}; Restart.pl
	cd ${TESTDIR}/IE/ionosphere; mv IE.log IE_all.log

test6_restart:
	cd ${TESTDIR}; cp Param/PARAM.in.test.restart.GMIEIMCRCM PARAM.in
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog_restart
	cd ${TESTDIR}/IE/ionosphere; tail -6 IE.log >> IE_all.log
	cd ${TESTDIR}; ./PostProc.pl -M -cat RESULTS; mv runlog_restart RESULTS

# check last snapshot from CRCM output
test6_check:
	-@(${SCRIPTDIR}/DiffNum.pl -b -r=1e-5 -a=1e-8 \
		${TESTDIR}/RESULTS/GM/log_n000001.log \
		output/test6/GM.log \
		> test6_gm.diff)
	-@(${SCRIPTDIR}/DiffNum.pl -b -r=1e-5 \
		${TESTDIR}/RESULTS/IE/IE_all.log \
		output/test6/IE.log \
		> test6_ie.diff)
	tail -2504 ${TESTDIR}/RESULTS/IM/CRCMeq.outs \
		> ${TESTDIR}/RESULTS/IM/CRCMeq.out
	gunzip -c output/test6/IM_eq.out.gz \
		> ${TESTDIR}/RESULTS/IM/CRCMeq_ref.out
	-@(${SCRIPTDIR}/DiffNum.pl -b -r=1e-5 -a=1e-8 \
		${TESTDIR}/RESULTS/IM/CRCMeq.out \
		${TESTDIR}/RESULTS/IM/CRCMeq_ref.out \
		> test6_im_crcm.diff)
	ls -l test6*.diff

### test_lc: Lower Corona test ###

test_lc:
	@echo "test_lc_compile..." > test_lc.diff
	make test_lc_compile
	@echo "test_lc_rundir..." >> test_lc.diff
	make test_lc_rundir
	@echo "test_lc_run..." >> test_lc.diff
	make test_lc_run
	@echo "test_lc_check..." >> test_lc.diff
	make test_lc_check

test_lc_compile:
	./Config.pl -v=Empty,LC/BATSRUS
	cd LC/BATSRUS; ./Config.pl -u=Lc -e=Mhd
	./Config.pl -g=LC:6,4,4,3000,1
	cd LC/BATSRUS; ./Config.pl -dynamic; cd ../..
	make SWMF PIDL

test_lc_rundir:
	rm -rf ${TESTDIR}
	make rundir RUNDIR=${TESTDIR}
	cp Param/PARAM.in.test.LC ${TESTDIR}/PARAM.in
	cp Param/LAYOUT.in.test.LC ${TESTDIR}/LAYOUT.in

test_lc_run:
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M RESULTS

test_lc_check:
	-(${SCRIPTDIR}/DiffNum.pl -b -r=1e-5 \
		${TESTDIR}/RESULTS/LC/log_n000001.log \
		output/test_lc/LC_log_n000001.log \
		> test_lc.diff)
	ls -l test_lc.diff

### test_sc_wave: Solar Corona with Alfven wave spectrum test ###

test_sc_waves:
	@echo "test_sc_waves_compile..." > test_sc_waves.diff
	make test_sc_waves_compile
	@echo "test_sc_rundir..." >> test_sc_waves.diff
	make test_sc_waves_rundir

test_sc_waves_compile:
	rm -f SC/BATSRUS/src/Makefile
	./Config.pl -v=Empty,SC/BATSRUS 
	./Config.pl -o=SC:u=ScWaves,e=MhdWaves,nWave=40
	./Config.pl -g=SC:4,4,4,2000,1
	make

test_sc_waves_rundir:
	rm -rf ${TESTDIR}
	make rundir RUNDIR=${TESTDIR}
	cp Param/PARAM.in.test.SC.waves ${TESTDIR}/PARAM.in
	cp GM/BATSRUS/Param/CORONA/CR2077_MDI_180.dat ${TESTDIR}/CR2077_MDI_180.dat
	cp Param/LAYOUT.in.test.SC ${TESTDIR}/LAYOUT.in

### ESMF test ###
#
#       Targets for the ESMF compatible executable
#

test_esmf:
	@echo "test_esmf_compile..." > test_esmf.diff
	make test_esmf_compile
	@echo "test_esmf_rundir..." >> test_esmf.diff
	make test_esmf_rundir
	@echo "test_esmf_run..." >> test_esmf.diff
	make test_esmf_run
	@echo "test_esmf_check..." >> test_esmf.diff
	make test_esmf_check

test_esmf_compile:
	./Config.pl -v=Empty,GM/BATSRUS,IE/Ridley_serial
	./Config.pl -g=GM:8,8,8,400,100,IE:91,181 -o=GM:u=Default,e=Mhd
	make ESMF_SWMF

test_esmf_rundir:
	rm -rf ${TESTDIR};
	make rundir RUNDIR=${TESTDIR}
	cd ESMF/ESMF_SWMF; make rundir RUNDIR=${TESTDIR}

test_esmf_run: 
	@cd ${TESTDIR}; rm -f PET*ESMF_LogFile
	@cd ${TESTDIR}; ${MPIRUN} ESMF_SWMF.exe > runlog
	@cd ${TESTDIR}; ./PostProc.pl -M RESULTS

test_esmf_check:
	perl -ne 'print if /error/i' ${TESTDIR}/PET*.ESMF_LogFile \
		> test_esmf.diff
	${SCRIPTDIR}/DiffNum.pl -b -r=1e-5 \
		${TESTDIR}/RESULTS/GM/log_n000001.log \
		ESMF/ESMF_SWMF/output/log_n000001.log \
		>> test_esmf.diff
	gunzip -c ESMF/ESMF_SWMF/output/it000321_104510_000.idl.gz \
		> ${TESTDIR}/it000321_104510_000.idl.ref
	${SCRIPTDIR}/DiffNum.pl -b -r=1e-4 \
		${TESTDIR}/RESULTS/IE/it000321_104510_000.idl \
		${TESTDIR}/it000321_104510_000.idl.ref \
		>> test_esmf.diff
	ls -l test_esmf.diff

#### FOR CCMC ONLY #######################
# CCMC instalation, compiling, and  PostIDL.exe	 generation
# Use "Config.pl -install" before "make ccmc_compile" or "make test_ccmc"
# Public version. Specific job scripts are to be substituted for generic mpirun
#
# This version of the test works only with the SWMF versions after May 2009 
# Use Config.pl -install -compiler=pgf90
# Modify the line in test_ccmc_run (see below) 

test_ccmc:
	@echo "test_ccmc_compile..." > test_ccmc.diff
	make ccmc_compile
	@echo "test_ccmc_rundir..." >> test_ccmc.diff
	make test_ccmc_rundir
	@echo "test_ccmc_run..." >> test_ccmc.diff
	make test_ccmc_run
	@echo "test_ccmc_restart_rundir..." >> test_ccmc.diff
	make test_ccmc_restart_rundir
	@echo "test_ccmc_run..." >> test_ccmc.diff
	make test_ccmc_run
	@echo "test_ccmc_check..." >> test_ccmc.diff
	make test_ccmc_check

ccmc_compile: 
	./Config.pl -v=Empty,GM/BATSRUS,IE/Ridley_serial,IM/RCM2,RB/RBE
	./Config.pl -g=GM:6,6,6,3800,1
	cd GM/BATSRUS; Config.pl -u=CCMC
	make SWMF PIDL
	
test_ccmc_rundir:
	rm -rf ${TESTDIR}
	make rundir RUNDIR=${TESTDIR}
	cp -r Param/CCMC ${TESTDIR}/Param_ccmc
	cd ${TESTDIR}; \
		cp -f Param_ccmc/LAYOUT.in_v8.01_init LAYOUT.in; \
		cp -f Param_ccmc/PARAM.in_v8.01_init PARAM.in; \
		${SCRIPTDIR}/replace_amrinit.pl; \
		cp SWMF.exe SWMF_run_test.exe; \
		rm -f SWMF.exe

test_ccmc_run:
	cd ${TESTDIR}; \
		${MPIRUN} ./SWMF_run_test.exe > runlog_`date +%y%m%d%H%M`
	cd ${TESTDIR}/GM; pIDL -ccmc; cd ../IE; pION

# FOR CCMC instead of the line with ${MPIRUN} should be the
# "tab" ${TESTMACHINE}.bat;"space"\"Enter":
# The job scripts shortened(hostname}.bat should be added to share/JobScripts,
# for all machines to be used.
# Here shortened(hostname) is the hostname with deleted number figures (no 0-9)
# For example: for lanai1 this would be lanai.bat

test_ccmc_restart_rundir:
	cd ${TESTDIR}; \
		cp -f Param_ccmc/LAYOUT.in_v8.01_RBE_restart LAYOUT.in; \
		cp -f Param_ccmc/PARAM.in_v8.01_RBE_restart PARAM.in; \
		${SCRIPTDIR}/replace_amrinit.pl; \
		./Restart.pl 

test_ccmc_check:
	${SCRIPTDIR}/DiffNum.pl -b -r=1.0e-5 \
		${TESTDIR}/GM/IO2/log_n002000.log \
		Param/CCMC/test_GM.log > test_ccmc.diff
	ls -l test_ccmc.diff

### test_ramscb: GM+IE+IM/RAMSCB ###

test_ramscb:
	@echo "test_ramscb_compile..." > test_ramscb_gm.diff
	@echo "test_ramscb_compile..." > test_ramscb_ie.diff
	@echo "test_ramscb_compile..." > test_ramscb_im.diff
	make test_ramscb_compile
	@echo "test_ramscb_rundir..." >> test_ramscb_gm.diff
	@echo "test_ramscb_rundir..." >> test_ramscb_ie.diff
	@echo "test_ramscb_rundir..." >> test_ramscb_im.diff
	make test_ramscb_rundir
	@echo "test_ramscb_run..." >> test_ramscb_gm.diff
	@echo "test_ramscb_run..." >> test_ramscb_ie.diff
	@echo "test_ramscb_run..." >> test_ramscb_im.diff
	make test_ramscb_run
	@echo "test_ramscb_check..." >> test_ramscb_gm.diff
	@echo "test_ramscb_check..." >> test_ramscb_ie.diff
	@echo "test_ramscb_check..." >> test_ramscb_im.diff
	make test_ramscb_check

test_ramscb_compile:
	./Config.pl -v=Empty,GM/BATSRUS,IE/Ridley_serial,IM/RAM_SCB
	./Config.pl -g=GM:8,8,8,400,100 -o=GM:u=Default,e=Mhd
	make SWMF PIDL

test_ramscb_rundir:
	rm -rf ${TESTDIR}
	make rundir RUNDIR=${TESTDIR}
	cp ${IMDIR}/input/PARAM.in.test.gmieim.simple ${TESTDIR}/PARAM.in
	cp ${IMDIR}/input/LAYOUT.in.test.gmieim.simple ${TESTDIR}/LAYOUT.in

# Note: The RCM .dat file is copied to .txt to avoid conversion to .plt
test_ramscb_run:
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M RESULTS

test_ramscb_check:
	-@(${SCRIPTDIR}/DiffNum.pl -b -r=1e-3 -a=1e-8 \
		${TESTDIR}/RESULTS/GM/log_n000001.log \
		${IMDIR}/output/test9/GM_log_n000001.log \
		> test_ramscb_gm.diff)
	-@(${SCRIPTDIR}/DiffNum.pl -b -r=1e-3 -a=1e-8 \
		${TESTDIR}/RESULTS/IM/ram/log_n000001.log \
		${IMDIR}/output/test9/IM_log_n000001.log \
		> test_ramscb_im.diff)
	-@(${SCRIPTDIR}/DiffNum.pl -b -r=1e-6 \
		${TESTDIR}/RESULTS/IE/IE.log \
		${IMDIR}/output/test9/IE.log \
		> test_ramscb_ie.diff)
	ls -l test_ramscb*.diff

test_lp:
	@echo "test_lp..." > test_ramscb_gm.diff
	make test_lp_compile
	@echo "test_p_rundir..." >> test_ramscb_gm.diff
	make test_lp_rundir

test_lp_compile:
	Config.pl -v=Empty,GM/BATSRUS
	cd GM/BATSRUS;Config.pl -g=4,4,1,1000,1000 -nMaterial=5
	make CRASH

test_lp_rundir:
	rm -rf ${TESTDIR}
	make rundir RUNDIR=${TESTDIR}
	cp -f ${GMDIR}/Param/CRASH/PARAM.in.LASPACK ${TESTDIR}/PARAM.in
	cp -f ${GMDIR}/Param/CRASH/LAYOUT.in.LASPACK ${TESTDIR}/LAYOUT.in