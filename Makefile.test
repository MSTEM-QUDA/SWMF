#  Copyright (C) 2002 Regents of the University of Michigan, 
#  portions used with permission 
#  For more information, see http://csem.engin.umich.edu/tools/swmf
#^CMP FILE TESTING

TESTDIR = ${DIR}/run_test

MPIRUN = mpirun -np 2

TESTMACHINE = `hostname | sed -e 's/\..*//; s/[0-9]*$$//'`

test_help:
	@echo "    test                       (run all tests with ${MPIRUN})"
	@echo "    test MPIRUN=               (run tests serially)"
	@echo "    test KEEP=y                (run tests and keep run directories)"
	@echo "    test MPIRUN='mpirun -np 3' (run tests with mpirun -np 3)"
	@echo "    test MPIRUN='mpiexec'      (run tests with mpiexec)"
	@echo "    test_share_library         (run share/Library tests)"
	@echo "    test_comp                  (run component tests)"
	@echo "    test_pw                    (run PW/PWOM test)"
	@echo "    test_ps                    (run PS/DGCPM test)"
	@echo "    test_rb                    (run RB/RBE test)"
	@echo "    test_esmf                  (run ESMF_SWMF test)"
	@echo "    test_ccmc                  (run CCMC test)"
	@echo "    test_ccmc_small            (run small version of CCMC test)"
	@echo "    test1                      (run GM-IE-PW test)"
	@echo "    test2                      (run SC-IH + IH-GM test )"
	@echo "    test3                      (run GM-IE-IM test)"
	@echo "    test4                      (run GM-IE-HEIDI test)"
	@echo "    test5                      (run EE-SC test)"
	@echo "    test6                      (run GM-IE-CRCM test)"
	@echo "    test7                      (run IH-OH test)"
	@echo "    test8                      (run multifluid GM-IM coupling test)"
	@echo "    test9                      (run Chromo SC-IH coupling test)"
	@echo "    test10                     (run 3T solar wind test)"
	@echo "    test11                     (run GM-PT coupler test)"
	@echo "    test12                     (run GM-PC tests)"
	@echo "    test13                     (run GM-PT test: Europa)"
	@echo "    test_pic                   (run GM-IPIC3D test)"
	@echo "    test_pic2                  (run GM-PC test)"
	@echo "    test_check                 (collect test results into test_swmf.res)"

test:
	@rm -f *.diff
	-@(${MAKE} test_share_library)
	-@(${MAKE} test_comp)
	-@(${MAKE} test_pw)
	-@(${MAKE} test_rb)
	-@(${MAKE} test_ps)
	-@(${MAKE} test_esmf)
	-@(${MAKE} test_ccmc_small)
	-@(${MAKE} test1)
	-@(${MAKE} test2)
	-@(${MAKE} test3)
	-@(${MAKE} test4)
	-@(${MAKE} test5)
	-@(${MAKE} test6)
	-@(${MAKE} test7)
	-@(${MAKE} test8)
	-@(${MAKE} test9)
	-@(${MAKE} test10)
	-@(${MAKE} test11)
	-@(${MAKE} test12)
	-@(${MAKE} test13)
	-@(${MAKE} test_check)

# Note: the "cat ... > /dev/null" makes sure that file size are correct on nyx
test_check:
	@cat share/Library/test/*.diff ??/*/*.diff *.diff > /dev/null
	-@ls -ltr share/Library/test/*.diff ??/*/*.diff *.diff > test_swmf.res
	@cat test_swmf.res
	@echo '=============================================================='\
		>> test_swmf.res
	-@head -100 share/Library/test/*.diff ??/*/*.diff *.diff \
		>> test_swmf.res
	@echo ' '
	@echo 'See test_swmf.res and test_swmf.log for more detail...'
	@echo ' '
	@echo '=============================================================='\
		>> test_swmf.res
	-@cat GM/BATSRUS/test_func.speed >> test_swmf.res

### Unit tests of the share/Library

test_share_library:
	rm -f share/Library/test/*.diff
	cd share/Library/src; ${MAKE} LIB
	cd share/Library/test; make test
	ls -l share/Library/test/*.diff

### Component tests ###

test_comp:
	for i in `ls -d [A-Z][A-Z]/*/ | grep -v /CVS/ | grep -v /Empty/`; \
		do ( cd $$i; ${MAKE} test; ); done
	ls -ltr [A-Z][A-Z]/*/*.diff

### SWMF tests ###

#### Convection Zone model: FSAM test ####

test_cz:
	@echo "starting..."        >  test_cz.diff
	@echo "test_cz_compile..." >> test_cz.diff
	${MAKE} test_cz_compile
	@echo "test_cz_rundir..."  >> test_cz.diff
	${MAKE} test_cz_rundir
	@echo "test_cz_run..."     >> test_cz.diff
	${MAKE} test_cz_run
	@echo "test_cz_check..."   >> test_cz.diff
	${MAKE} test_cz_check
	@if([ "${KEEP}" ]); then rm -f run_$@; mv ${TESTDIR} run_$@; fi

test_cz_compile:
	./Config.pl -v=Empty,CZ/FSAM -fishpak
	cp CZ/FSAM/srcProblem/ModUserSetup.SWMF.f90 CZ/FSAM/src/ModUserSetup.f90
	cp CZ/FSAM/srcProblem/ModPar.SWMF.f90 CZ/FSAM/src/ModPar.f90
	${MAKE} SWMF

test_cz_rundir:
	rm -rf ${TESTDIR}
	${MAKE} rundir RUNDIR=${TESTDIR}
	cp Param/PARAM.in.test.CZ ${TESTDIR}/PARAM.in
	cp Param/LAYOUT.in.test.CZ ${TESTDIR}/LAYOUT.in
	cp ${CZDIR}/input/gong.l4b.14 ${TESTDIR}/

test_cz_run:
	cd ${TESTDIR}; mpirun -n 6 ./SWMF.exe > runlog

test_cz_check:
	-@(${SCRIPTDIR}/DiffNum.pl -b -a=1e-13 -r=1e-10 \
		${TESTDIR}/eng_1_n00000000 \
		${CZDIR}/output/eng_1_n00000000 \
		> test_cz.diff)
	ls -ltr test_cz.diff

#### Polarwind test ###
#
test_pw:
	@echo "starting..." > test_pw.diff
	@echo "test_pw_compile..." >> test_pw.diff
	${MAKE} test_pw_compile
	@echo "test_pw_rundir..." >> test_pw.diff
	${MAKE} test_pw_rundir
	@echo "test_pw_run..." >> test_pw.diff
	${MAKE} test_pw_run
	@echo "test_pw_check..." >> test_pw.diff
	${MAKE} test_pw_check
	@if([ "${KEEP}" ]); then rm -rf run_$@; mv ${TESTDIR} run_$@; fi

test_pw_compile:
	./Config.pl -v=Empty,PW/PWOM -o=PW:Earth
	${MAKE} SWMF
	make PIDL

test_pw_rundir:
	rm -rf ${TESTDIR}
	${MAKE} rundir RUNDIR=${TESTDIR}
	cp Param/PARAM.in.test.PW ${TESTDIR}/PARAM.in
	cp Param/LAYOUT.in.test.PW ${TESTDIR}/LAYOUT.in

test_pw_run:
	cd ${TESTDIR}/PW; rm -f log.out restartOUT/* plots/*
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog

test_pw_check:
	-@(${SCRIPTDIR}/DiffNum.pl -b -r=1e-8 \
		${TESTDIR}/PW/plots/north_plots_iline0001.out \
		${PWDIR}/data/output/Earth/north_plots_iline0001.out \
		> test_pw.diff)
	ls -ltr test_pw*.diff


#### Plasmasphere model: DGCPM test ###
#
test_ps:
	@echo "starting..." > test_ps.diff
	@echo "test_ps_compile..." >> test_ps.diff
	${MAKE} test_ps_compile
	@echo "test_ps_rundir..." >> test_ps.diff
	${MAKE} test_ps_rundir
	@echo "test_ps_run..." >> test_ps.diff
	${MAKE} test_ps_run
	@echo "test_ps_check..." >> test_ps.diff
	${MAKE} test_ps_check	
	@if([ "${KEEP}" ]); then rm -rf run_$@; mv ${TESTDIR} run_$@; fi

test_ps_compile:
	./Config.pl -v=Empty,PS/DGCPM
	${MAKE} SWMF
	
test_ps_rundir:
	rm -rf ${TESTDIR}
	${MAKE} rundir RUNDIR=${TESTDIR}
	cp Param/PARAM.in.test.PS ${TESTDIR}/PARAM.in
	cp Param/LAYOUT.in.test.PS ${TESTDIR}/LAYOUT.in
	cp ${PSDIR}/Input/a1001_dgcpm.in ${TESTDIR}/PS/Input/
	cp ${PSDIR}/Input/a1001_kp.in ${TESTDIR}/PS/Input/

test_ps_run:
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog

test_ps_check:
	-@(${SCRIPTDIR}/DiffNum.pl -t -r=1e-8 \
		${TESTDIR}/PS/Output/a1001_dgcpm_dynamic_00003.dat \
		${PSDIR}/Output/a1001_dgcpm_dynamic_00003.ref \
		> test_ps.diff)
	ls -ltr test_ps*.diff


#### Radiation belt model test ###
#
test_rb:
	@echo "starting..." > test_rb.diff
	@echo "test_rb_compile..." >> test_rb.diff
	${MAKE} test_rb_compile
	@echo "test_rb_rundir..." >> test_rb.diff
	${MAKE} test_rb_rundir
	@echo "test_rb_run..." >> test_rb.diff
	${MAKE} test_rb_run
	@echo "test_rb_check..." >> test_rb.diff
	${MAKE} test_rb_check
	@if([ "${KEEP}" ]); then rm -rf run_$@; mv ${TESTDIR} run_$@; fi

test_rb_compile:
	./Config.pl -v=Empty,RB/RBE,GM/BATSRUS
	./Config.pl -g=GM:8,8,8,770,1 -o=GM:e=Mhd,u=Default
	${MAKE} SWMF
	make PIDL

test_rb_rundir:
	rm -rf ${TESTDIR}
	${MAKE} rundir RUNDIR=${TESTDIR}
	cp Param/PARAM.in.test.RB ${TESTDIR}/PARAM.in
	cp Param/LAYOUT.in.test.RB ${TESTDIR}/LAYOUT.in
	cd ${TESTDIR}/RB/; ln -s ${RBDIR}/input/2002_296* .
test_rb_run:
	cd ${TESTDIR}/RB; rm -f 2002f296_e.fls
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog

test_rb_check:
	gunzip -c ${RBDIR}/data/output/2002f296_e.fls.gz \
		> ${TESTDIR}/2002f296_e.fls.ref
	-@(${SCRIPTDIR}/DiffNum.pl -r=0.001 -a=1e-10 \
		${TESTDIR}/RB/plots/2002f296_e.fls \
		${TESTDIR}/2002f296_e.fls.ref \
		> test_rb.diff)
	ls -l test_rb.diff

### Test1: PW+IE+GM ###
#
test1:
	@echo "test1_compile..." > test1_gm.diff
	@echo "test1_compile..." > test1_ie.diff
	@echo "test1_compile..." > test1_pw.diff
	${MAKE} test1_compile
	@echo "test1_rundir..." >> test1_gm.diff
	@echo "test1_rundir..." >> test1_ie.diff
	@echo "test1_rundir..." >> test1_pw.diff
	${MAKE} test1_rundir
	@echo "test1_run..." >> test1_gm.diff
	@echo "test1_run..." >> test1_ie.diff
	@echo "test1_run..." >> test1_pw.diff
	${MAKE} test1_run
	@echo "test1_check..." >> test1_gm.diff
	@echo "test1_check..." >> test1_ie.diff
	@echo "test1_check..." >> test1_pw.diff
	${MAKE} test1_check
	@if([ "${KEEP}" ]); then rm -rf run_$@; mv ${TESTDIR} run_$@; fi

test1_compile:
	./Config.pl -v=Empty,GM/BATSRUS,IE/Ridley_serial,PW/PWOM
	./Config.pl -g=GM:8,8,8,700,100 -o=GM:u=Default,e=Mhd,PW:Earth
	${MAKE} SWMF
	make PIDL

test1_rundir:
	rm -rf ${TESTDIR}
	${MAKE} rundir RUNDIR=${TESTDIR}
	cp Param/PARAM.in.test.GMIEPW ${TESTDIR}/PARAM.in
	cp Param/LAYOUT.in.test.GMIEPW ${TESTDIR}/LAYOUT.in

test1_run:
	cd ${TESTDIR}/PW; rm -f log.out restartOUT/* plots/*
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M RESULTS

test1_check:
	-@(${SCRIPTDIR}/DiffNum.pl -b -r=1e-7 \
		${TESTDIR}/RESULTS/PW/north_plots_iline0001.out \
		PW/PWOM/data/output/Earth/PW_north_plots_iline0001.out \
		> test1_pw.diff)
	-@(${SCRIPTDIR}/DiffNum.pl -b -a=1e-20 -r=1e-7 \
		${TESTDIR}/RESULTS/PW/north_plots_iline0002.out \
		PW/PWOM/data/output/Earth/PW_north_plots_iline0002.out \
		>> test1_pw.diff)
	-@(${SCRIPTDIR}/DiffNum.pl -b -r=1e-7 \
		${TESTDIR}/RESULTS/PW/north_plots_iline0003.out \
		PW/PWOM/data/output/Earth/PW_north_plots_iline0003.out \
		>> test1_pw.diff)
	-@(${SCRIPTDIR}/DiffNum.pl -b -r=1e-7 \
		${TESTDIR}/RESULTS/PW/north_plots_iline0004.out \
		PW/PWOM/data/output/Earth/PW_north_plots_iline0004.out \
		>> test1_pw.diff)
	-@(${SCRIPTDIR}/DiffNum.pl -b -r=1e-3 -a=1e-8 \
		${TESTDIR}/RESULTS/GM/log_n000001.log \
		output/test1/GM_log_n000001.log \
		> test1_gm.diff)
	-@(${SCRIPTDIR}/DiffNum.pl -b -t -r=1e-5 \
		${TESTDIR}/RESULTS/IE/IE*.log \
		output/test1/IE.log \
		> test1_ie.diff)
	-@(${SCRIPTDIR}/DiffNum.pl -b -r=1e-4 -a=6e-5 \
		${TESTDIR}/RESULTS/IE/it000321_104510_000.idl \
		output/test1/IE_it000321_104510_000.idl \
		>> test1_ie.diff)
	ls -l test1_*.diff

### test2: SC+IH test ###

test2:
	@echo "test2_compile..." > test2_sc.diff
	@echo "test2_compile..." > test2_ih.diff
	${MAKE} test2_compile
	@echo "test2_rundir..." >> test2_sc.diff
	@echo "test2_rundir..." >> test2_ih.diff
	${MAKE} test2_rundir
	@echo "test2_run..." >> test2_sc.diff
	@echo "test2_run..." >> test2_ih.diff
	${MAKE} test2_run
	@echo "test2_check..." >> test2_sc.diff
	@echo "test2_check..." >> test2_ih.diff
	${MAKE} test2_check
	@if([ "${KEEP}" ]); then rm -rf run_$@; mv ${TESTDIR} run_$@; fi

test2_compile:
	./Config.pl -v=Empty,SC/BATSRUS,IH/BATSRUS,GM/BATSRUS
	./Config.pl -o=SC:u=Sc,e=MhdCorona,IH:u=Ih,e=Mhd,GM:u=Default,e=Mhd
	./Config.pl -g=SC:4,4,4,6200,1,IH:8,8,8,400,1,GM:8,8,8,700,1
	${MAKE} SWMF
	make PIDL EARTH_TRAJ

test2_rundir:
	rm -rf ${TESTDIR}
	${MAKE} rundir RUNDIR=${TESTDIR}
	cp Param/PARAM.in.test.SCIH ${TESTDIR}/PARAM.in
	cp Param/LAYOUT.in.test.SCIH ${TESTDIR}/LAYOUT.in
	cd ${TESTDIR}/IH; cp Param/EARTH_TRAJ.in .; \
		${BINDIR}/EARTH_TRAJ.exe > earth_traj.dat

test2_run:
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog
	cd ${TESTDIR}; ./Restart.pl
	cd ${TESTDIR}; ./PostProc.pl -M RESULTS/start
	cp Param/PARAM.in.test.IHGM ${TESTDIR}/PARAM.in
	cp Param/LAYOUT.in.test.IHGM ${TESTDIR}/LAYOUT.in
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M RESULTS/restart

test2_check:
	-(${SCRIPTDIR}/DiffNum.pl -b -r=1e-5 \
		${TESTDIR}/RESULTS/start/SC/log_n000001.log \
		output/test2/SC_log_n000001.log \
		> test2_sc.diff)
	-(${SCRIPTDIR}/DiffNum.pl -b -r=1e-5 \
		${TESTDIR}/RESULTS/start/IH/log_n000001.log \
		output/test2/IH_log_n000001.log \
		> test2_ih.diff)
	-(${SCRIPTDIR}/DiffNum.pl -b -r=1e-5 \
		${TESTDIR}/RESULTS/start/IH/sat_earth_traj_n000000.sat \
		output/test2/IH_sat_earth_traj_n000000.sat \
		>> test2_ih.diff)
	-(${SCRIPTDIR}/DiffNum.pl -b -r=1e-5 \
		${TESTDIR}/RESULTS/restart/GM/log_n000001.log \
		output/test2/GM_log_n000001.log \
		> test2_gm.diff)
	ls -l test2_*.diff

### Test3: GM+IE+IM ###

test3:
	@echo "test3_compile..." > test3_gm.diff
	@echo "test3_compile..." > test3_ie.diff
	@echo "test3_compile..." > test3_im_rcm.diff
	${MAKE} test3_compile
	@echo "test3_rundir..." >> test3_gm.diff
	@echo "test3_rundir..." >> test3_ie.diff
	@echo "test3_rundir..." >> test3_im_rcm.diff
	${MAKE} test3_rundir
	@echo "test3_run..." >> test3_gm.diff
	@echo "test3_run..." >> test3_ie.diff
	@echo "test3_run..." >> test3_im_rcm.diff
	${MAKE} test3_run
	@echo "test3_restart..." >> test3_gm.diff
	@echo "test3_restart..." >> test3_ie.diff
	@echo "test3_restart..." >> test3_im_rcm.diff
	${MAKE} test3_restart
	@echo "test3_check..." >> test3_gm.diff
	@echo "test3_check..." >> test3_ie.diff
	@echo "test3_check..." >> test3_im_rcm.diff
	${MAKE} test3_check
	@if([ "${KEEP}" ]); then rm -rf run_$@; mv ${TESTDIR} run_$@; fi

test3_compile:
	./Config.pl -v=Empty,GM/BATSRUS,IE/Ridley_serial,IM/RCM2
	./Config.pl -g=GM:8,8,8,400,100 -o=GM:u=Default,e=Mhd
	${MAKE} SWMF
	make PIDL

test3_rundir:
	rm -rf ${TESTDIR}
	${MAKE} rundir RUNDIR=${TESTDIR}
	cp Param/PARAM.in.test.GMIEIM ${TESTDIR}/PARAM.in
	cp Param/LAYOUT.in.test.GMIEIM ${TESTDIR}/LAYOUT.in

test3_run:
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog
	cd ${TESTDIR}; ./Restart.pl

# Note: The RCM .dat file is copied to .txt to avoid conversion to .plt
test3_restart:
	cd ${TESTDIR}; cp Param/PARAM.in.test.restart.GMIEIM PARAM.in
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog_restart
	cd ${TESTDIR}/IM/plots/; cp 2d__max_t00000020.dat t20.txt
	cd ${TESTDIR}; ./PostProc.pl -M -cat RESULTS; \
		mv runlog_restart RESULTS

test3_check:
	-@(${SCRIPTDIR}/DiffNum.pl -b -r=1e-5 -a=1e-8 \
		${TESTDIR}/RESULTS/GM/log_n000001.log \
		output/test3/GM_log_n000001.log \
		> test3_gm.diff)
	-@(${SCRIPTDIR}/DiffNum.pl -b -r=1e-5 -a=1e-8 \
		${TESTDIR}/RESULTS/GM/GM_mag_n00000000.mag \
		output/test3/GM_mag_n00000000.mag \
		>> test3_gm.diff)
	-@(${SCRIPTDIR}/DiffNum.pl -b -r=1e-5 -a=1e-8 \
		${TESTDIR}/RESULTS/GM/geoindex_n00000005.log \
		output/test3/GM_geoindex.log \
		>> test3_gm.diff)
	-@(${SCRIPTDIR}/DiffNum.pl -b -r=1e-5 -a=1e-4 \
		${TESTDIR}/RESULTS/RESTART/GM/x_geoindex.rst \
		output/test3/GM_restart_geoindex.txt \
		>> test3_gm.diff)
	-@(${SCRIPTDIR}/DiffNum.pl -b -r=1e-5 \
		${TESTDIR}/RESULTS/IE/IE_t000321_104500.log \
		output/test3/IE.log \
		> test3_ie.diff)
	-@(${SCRIPTDIR}/DiffNum.pl -b -r=1e-5 -a=3e-5 \
		${TESTDIR}/RESULTS/IE/IE_mag_t000321_104500.mag \
		output/test3/IE.mag \
		>> test3_ie.diff)
	gunzip -c output/test3/IM_2d__max_t00000020.dat.gz \
		> ${TESTDIR}/RESULTS/IM/t20.dat
# Remove date stamp from tecplot files
	cd ${TESTDIR}/RESULTS/IM; \
		perl -pi -e 's/AUXDATA SAVEDATE=.*//' t20.dat t20.txt
	-@(${SCRIPTDIR}/DiffNum.pl -b -r=1e-3 -a=1e-8 \
		${TESTDIR}/RESULTS/IM/t20.txt \
		${TESTDIR}/RESULTS/IM/t20.dat \
		> test3_im_rcm.diff)
	ls -l test3_*.diff

### Test4: GM+IE+HEIDI ###############

test4:
	@echo "test4_compile..." > test4_gm.diff
	@echo "test4_compile..." > test4_ie.diff
	@echo "test4_compile..." > test4_im_heidi.diff
	${MAKE} test4_compile
	@echo "test4_rundir..." >> test4_gm.diff
	@echo "test4_rundir..." >> test4_ie.diff
	@echo "test4_rundir..." >> test4_im_heidi.diff
	${MAKE} test4_rundir
	@echo "test4_run..." >> test4_gm.diff
	@echo "test4_run..." >> test4_ie.diff
	@echo "test4_run..." >> test4_im_heidi.diff
	${MAKE} test4_run
	@echo "test4_check..." >> test4_gm.diff
	@echo "test4_check..." >> test4_ie.diff
	@echo "test4_check..." >> test4_im_heidi.diff
	${MAKE} test4_check
	@if([ "${KEEP}" ]); then rm -rf run_$@; mv ${TESTDIR} run_$@; fi

test4_compile:
	./Config.pl -v=Empty,GM/BATSRUS,IE/Ridley_serial,IM/HEIDI
	./Config.pl -g=GM:8,8,8,600,1 -o=GM:u=Default,e=Mhd
	${MAKE} SWMF
	make PIDL

test4_rundir:
	rm -rf ${TESTDIR}
	${MAKE} rundir RUNDIR=${TESTDIR}
	cp Param/PARAM.in.test.GMIEHEIDI ${TESTDIR}/PARAM.in
	cp Param/LAYOUT.in.test.GMIEHEIDI ${TESTDIR}/LAYOUT.in

test4_run:
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M RESULTS

test4_check:
	-@(${SCRIPTDIR}/DiffNum.pl -b -r=1e-3 -a=1e-8 \
		${TESTDIR}/RESULTS/GM/log_n000000.log \
		output/test4/GM_log_n000000.log \
		> test4_gm.diff)
	-@(${SCRIPTDIR}/DiffNum.pl -b -t -r=1e-5 \
		${TESTDIR}/RESULTS/IE/IE*.log \
		output/test4/IE.log \
		> test4_ie.diff)
	-@(${SCRIPTDIR}/DiffNum.pl -b -t -a=re-3 -a=1e-30 \
                ${TESTDIR}/RESULTS/IM/hydrogen/test1_h_prs.002 \
                output/test4/IM_test1_h_prs.002\
                > test4_im_heidi.diff)
	ls -l test4_*.diff

### test5: Eruptive Event generator coupled to the corona ###
test5:
	@echo "test5_compile..." > test5_ee.diff
	${MAKE} test5_compile
	@echo "test_rundir..." >> test5_ee.diff
	${MAKE} test5_rundir
	@echo "test5_run..." >> test5_ee.diff
	${MAKE} test5_run
	@echo "test5_check..." >> test5_ee.diff
	${MAKE} test5_check
	@if([ "${KEEP}" ]); then rm -rf run_$@; mv ${TESTDIR} run_$@; fi

test5_compile:
	./Config.pl -v=Empty,EE/BATSRUS
	./Config.pl -g=EE:10,10,10,500,1
	${MAKE} SWMF
	make PIDL

test5_rundir:
	rm -rf ${TESTDIR}
	${MAKE} rundir RUNDIR=${TESTDIR}
	cp Param/LAYOUT.in.test.EE ${TESTDIR}/LAYOUT.in
	cd ${TESTDIR}; cp ../GM/BATSRUS/data/FLUXEMERGENCE/*.dat* .
	cd ${TESTDIR}; cp ../GM/BATSRUS/Param/FLUXEMERGENCE/Grid.* .
	cd ${TESTDIR}; gunzip *.gz

test5_run:
	cd ${TESTDIR}; cp Param/PARAM.in.test.EE.1D PARAM.in
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog_1d
	cd ${TESTDIR}; ./PostProc.pl -M -cat RESULTS/run_1d
	cd ${TESTDIR}; cp Param/PARAM.in.test.EE.3D PARAM.in
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog_3d
	cd ${TESTDIR}; ./Restart.pl
	cd ${TESTDIR}; ./PostProc.pl -M -cat RESULTS/run_3d
	cd ${TESTDIR}; cp Param/PARAM.in.test.EE PARAM.in
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog_restart
	cd ${TESTDIR}; ./PostProc.pl -M -cat RESULTS/run_restart; \
	   	       		mv runlog_restart RESULTS/run_restart

test5_check:
	-(${SCRIPTDIR}/DiffNum.pl -b \
		${TESTDIR}/RESULTS/run_restart/EE/log_n000011.log \
		output/test5/EE_log_n000011.log \
		> test5_ee.diff)
	ls -l test5_ee.diff

### Test6: GM+IE+IM=CRCM ###

test6:
	@echo "test6_compile..." > test6_gm.diff
	@echo "test6_compile..." > test6_ie.diff
	@echo "test6_compile..." > test6_im_crcm.diff
	${MAKE} test6_compile
	@echo "test6_rundir..." >> test6_gm.diff
	@echo "test6_rundir..." >> test6_ie.diff
	@echo "test6_rundir..." >> test6_im_crcm.diff
	${MAKE} test6_rundir
	@echo "test6_run..." >> test6_gm.diff
	@echo "test6_run..." >> test6_ie.diff
	@echo "test6_run..." >> test6_im_crcm.diff
	${MAKE} test6_run
	@echo "test6_restart..." >> test6_gm.diff
	@echo "test6_restart..." >> test6_ie.diff
	@echo "test6_restart..." >> test6_im_crcm.diff
	${MAKE} test6_restart
	@echo "test6_check..." >> test6_gm.diff
	@echo "test6_check..." >> test6_ie.diff
	@echo "test6_check..." >> test6_im_crcm.diff
	${MAKE} test6_check
	@if([ "${KEEP}" ]); then rm -rf run_$@; mv ${TESTDIR} run_$@; fi

test6_compile:
	./Config.pl -v=Empty,GM/BATSRUS,IE/Ridley_serial,IM/CRCM
	./Config.pl -g=GM:8,8,8,400,100 -o=GM:u=Default,e=Mhd,IM:EarthHO
	${MAKE} SWMF
	make PIDL

test6_rundir:
	rm -rf ${TESTDIR}
	${MAKE} rundir RUNDIR=${TESTDIR}
	cp Param/PARAM.in.test.GMIEIMCRCM ${TESTDIR}/PARAM.in
	cp Param/LAYOUT.in.test.GMIEIMCRCM ${TESTDIR}/LAYOUT.in

test6_run:
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog
	cd ${TESTDIR}; ./Restart.pl

test6_restart:
	cd ${TESTDIR}; cp Param/PARAM.in.test.restart.GMIEIMCRCM PARAM.in
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog_restart
	cd ${TESTDIR}; ./PostProc.pl -M -cat RESULTS; mv runlog_restart RESULTS

# check last snapshot from CRCM output
test6_check:
	-@(${SCRIPTDIR}/DiffNum.pl -b -r=1e-5 -a=1e-8 \
		${TESTDIR}/RESULTS/GM/log_n000001.log \
		output/test6/GM.log \
		> test6_gm.diff)
	-@(${SCRIPTDIR}/DiffNum.pl -b -r=1e-5 \
		${TESTDIR}/RESULTS/IE/IE*.log \
		output/test6/IE.log \
		> test6_ie.diff)
	tail -2504 ${TESTDIR}/RESULTS/IM/CRCMeq.outs \
		> ${TESTDIR}/RESULTS/IM/CRCMeq.out
	gunzip -c output/test6/IM_eq.out.gz \
		> ${TESTDIR}/RESULTS/IM/CRCMeq_ref.out
	-@(${SCRIPTDIR}/DiffNum.pl -b -r=1e-5 -a=1e-8 \
		${TESTDIR}/RESULTS/IM/CRCMeq.out \
		${TESTDIR}/RESULTS/IM/CRCMeq_ref.out \
		> test6_im_crcm.diff)
	-@(${SCRIPTDIR}/DiffNum.pl -b -r=1e-5 \
		${TESTDIR}/RESULTS/IM/CRCM.log \
		output/test6/IM.log \
		> test6_im_crcm_log.diff)
	ls -l test6_*.diff

### test7: IH+OH test ###

test7:
	@echo "test7_compile..." > test7_ih.diff
	@echo "test7_compile..." > test7_oh.diff
	${MAKE} test7_compile
	@echo "test7_rundir..." >> test7_ih.diff
	@echo "test7_rundir..." >> test7_oh.diff
	${MAKE} test7_rundir
	@echo "test7_run..." >> test7_ih.diff
	@echo "test7_run..." >> test7_oh.diff
	${MAKE} test7_run
	@echo "test7_check..." >> test7_ih.diff
	@echo "test7_check..." >> test7_oh.diff
	${MAKE} test7_check
	@if([ "${KEEP}" ]); then rm -rf run_$@; mv ${TESTDIR} run_$@; fi

test7_compile:
	./Config.pl -v=Empty,IH/BATSRUS,OH/BATSRUS
	./Config.pl -g=IH:4,4,4,3000,1,OH:4,4,4,3000,1
	./Config.pl -o=IH:u=Waves,e=Mhd -o=OH:u=Waves,e=Mhd
	${MAKE} SWMF
	make PIDL

test7_rundir:
	rm -rf ${TESTDIR}
	${MAKE} rundir RUNDIR=${TESTDIR}
	cp Param/PARAM.in.test.IHOH.CoupleSphToXyz ${TESTDIR}/PARAM.in
	cp Param/LAYOUT.in.test.IHOH ${TESTDIR}/LAYOUT.in

test7_run:
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M RESULTS

test7_check:
	-(${SCRIPTDIR}/DiffNum.pl -b -r=1e-5 -a=1e-29\
		${TESTDIR}/RESULTS/IH/log_n000000.log \
		output/test7/Sph_IH_log_n000000.log \
		> test7_ih.diff)
	-(${SCRIPTDIR}/DiffNum.pl -b -r=1e-5 -a=1e-29\
		${TESTDIR}/RESULTS/OH/log_n000000.log \
		output/test7/Xyz_OH_log_n000000.log \
		> test7_oh.diff)
	ls -l test7_*.diff


### Test8: GM+IE+RCM with multifluid GM-IM coupling ###

test8:  
	@echo "test8_compile..." > test8_gm_multi.diff
	@echo "test8_compile..." > test8_ie.diff	
	@echo "test8_compile..." > test8_im_rcm_multi.diff
	${MAKE} test8_compile
	@echo "test8_rundir..." >> test8_gm_multi.diff
	@echo "test8_rundir..." >> test8_ie.diff
	@echo "test8_rundir..." >> test8_im_rcm_multi.diff
	${MAKE} test8_rundir
	@echo "test8_run..." >> test8_gm_multi.diff
	@echo "test8_run..." >> test8_ie.diff
	@echo "test8_run..." >> test8_im_rcm_multi.diff
	${MAKE} test8_run
	@echo "test8_restart..." >> test8_gm_multi.diff
	@echo "test8_restart..." >> test8_ie.diff
	@echo "test8_restart..." >> test8_im_rcm_multi.diff
	${MAKE} test8_restart
	@echo "test8_check..." >> test8_gm_multi.diff
	@echo "test8_check..." >> test8_ie.diff
	@echo "test8_check..." >> test8_im_rcm_multi.diff
	${MAKE} test8_check
	@if([ "${KEEP}" ]); then rm -rf run_$@; mv ${TESTDIR} run_$@; fi

test8_compile:
	./Config.pl -v=Empty,GM/BATSRUS,IE/Ridley_serial,IM/RCM2
	./Config.pl -g=GM:8,8,8,400,100 -o=GM:u=Default,e=MhdIons
	${MAKE} SWMF
	make PIDL

test8_rundir:
	rm -rf ${TESTDIR}
	${MAKE} rundir RUNDIR=${TESTDIR}
	cp Param/PARAM.in.test.GMIERCM_Multi ${TESTDIR}/PARAM.in
	cp Param/LAYOUT.in.test.GMIEIM ${TESTDIR}/LAYOUT.in

test8_run:
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog
	cd ${TESTDIR}; ./Restart.pl

test8_restart:
	cd ${TESTDIR}; cp Param/PARAM.in.test.restart.GMIERCM_Multi PARAM.in
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog_restart
	cd ${TESTDIR}/IM/plots/; cp 2d__max_t00000020.dat t20.txt
	cd ${TESTDIR}; ./PostProc.pl -M -cat RESULTS; \
		mv runlog_restart RESULTS

test8_check:
	-@(${SCRIPTDIR}/DiffNum.pl -b -r=1e-5 -a=1e-8 \
		${TESTDIR}/RESULTS/GM/log_n000001.log \
		output/test8/GM_log_n000001.log \
		> test8_gm_multi.diff)
	-@(${SCRIPTDIR}/DiffNum.pl -b -r=1e-5 -a=1e-8 \
		${TESTDIR}/RESULTS/GM/GM_mag_n00000000.mag \
		output/test8/GM_mag_n00000000.mag \
		>> test8_gm_multi.diff)
	-@(${SCRIPTDIR}/DiffNum.pl -b -r=1e-5 -a=1e-8 \
		${TESTDIR}/RESULTS/GM/geoindex_n00000005.log \
		output/test8/GM_geoindex.log \
		>> test8_gm_multi.diff)
	-@(${SCRIPTDIR}/DiffNum.pl -b -r=1e-5 -a=1e-4 \
		${TESTDIR}/RESULTS/RESTART/GM/x_geoindex.rst \
		output/test8/GM_restart_geoindex.txt \
		>> test8_gm_multi.diff)
	-@(${SCRIPTDIR}/DiffNum.pl -b -r=1e-5 \
		${TESTDIR}/RESULTS/IE/IE_t000321_104500.log \
		output/test8/IE.log \
		> test8_ie.diff) 
	-@(${SCRIPTDIR}/DiffNum.pl -b -r=1e-5 -a=3e-5 \
		${TESTDIR}/RESULTS/IE/IE_mag_t000321_104500.mag \
		output/test8/IE.mag \
		>> test8_ie.diff)
	gunzip -c output/test8/IM_2d__max_t00000020.dat.gz \
		> ${TESTDIR}/RESULTS/IM/t20.dat
	cd ${TESTDIR}/RESULTS/IM;\
		perl -pi -e 's/AUXDATA SAVEDATE=.*//' t20.dat t20.txt
	-@(${SCRIPTDIR}/DiffNum.pl -b -r=1e-3 -a=1e-8 \
		${TESTDIR}/RESULTS/IM/t20.txt \
		${TESTDIR}/RESULTS/IM/t20.dat \
		> test8_im_rcm_multi.diff)
	ls -l test8_*.diff

### test9: Chromospheric SC + IH with Alfven waves test ###

test9:
	@echo "test9_compile..." > test9_sc_chromo.diff
	@echo "test9_compile..." > test9_ih.diff
	${MAKE} test9_compile
	@echo "test9_rundir..." >> test9_sc_chromo.diff
	@echo "test9_rundir..." >> test9_ih.diff
	${MAKE} test9_rundir
	@echo "test9_run..." >> test9_sc_chromo.diff
	@echo "test9_run..." >> test9_ih.diff
	${MAKE} test9_run
	@echo "test9_restart..." >> test9_sc_chromo.diff
	@echo "test9_restart..." >> test9_ih.diff
	${MAKE} test9_restart
	@echo "test9_check..." >> test9_sc_chromo.diff
	@echo "test9_check..." >> test9_ih.diff
	${MAKE} test9_check
	@if([ "${KEEP}" ]); then rm -rf run_$@; mv ${TESTDIR} run_$@; fi

test9_compile:
	./Config.pl -v=Empty,SC/BATSRUS,IH/BATSRUS
	./Config.pl -o=SC:u=ScChromo,e=MhdWavesPe
	./Config.pl -o=IH:u=ScChromo,e=MhdWavesPeSignB
	./Config.pl -g=SC:6,4,4,1200,1,IH:4,4,4,6800,1
	${MAKE} SWMF
	make PIDL

test9_rundir:
	rm -rf ${TESTDIR}
	${MAKE} rundir RUNDIR=${TESTDIR}
	cp Param/PARAM.in.test.start.ChromoIH ${TESTDIR}/PARAM.in
	cp Param/LAYOUT.in.test.SCIH ${TESTDIR}/LAYOUT.in
	cp GM/BATSRUS/Param/CORONA/RadCoolCorona.dat ${TESTDIR}/RadCoolCorona.dat

test9_run:
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog
	cd ${TESTDIR}; ./Restart.pl

test9_restart:
	cd ${TESTDIR}; cp Param/PARAM.in.test.restart.ChromoIH PARAM.in
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog_restart
	cd ${TESTDIR}; ./PostProc.pl -M -cat RESULTS

test9_check:
	-(${SCRIPTDIR}/DiffNum.pl -b -r=1e-5 -a=1e-27 \
		${TESTDIR}/RESULTS/SC/log_n000000.log \
		output/test9/SC_log_n000000.log \
		> test9_sc_chromo.diff)
	-(${SCRIPTDIR}/DiffNum.pl -b -r=1e-5 \
		${TESTDIR}/RESULTS/IH/log_n000000.log \
		output/test9/IH_log_n000000.log \
		> test9_ih.diff)
	ls -l test9_*.diff

### test10: Global Solar Wind Model with three temperatures and Alfven waves

test10:
	@echo "test10_compile..." > test10_sc.diff
	@echo "test10_compile..." > test10_ih.diff
	${MAKE} test10_compile
	@echo "test10_rundir..." >> test10_sc.diff
	@echo "test10_rundir..." >> test10_ih.diff
	${MAKE} test10_rundir
	@echo "test10_run..." >> test10_sc.diff
	@echo "test10_run..." >> test10_ih.diff
	${MAKE} test10_run
	@echo "test10_check..." >> test10_sc.diff
	@echo "test10_check..." >> test10_ih.diff
	${MAKE} test10_check
	@if([ "${KEEP}" ]); then rm -rf run_$@; mv ${TESTDIR} run_$@; fi

test10_compile:
	./Config.pl -v=Empty,SC/BATSRUS,IH/BATSRUS
	./Config.pl -o=SC:u=ScChromo,e=MhdWavesPeAnisoPi
	./Config.pl -o=IH:u=ScChromo,e=MhdWavesPeAnisoPiSignB
	./Config.pl -g=SC:6,4,4,1200,1,IH:4,4,4,6800,1
	${MAKE} SWMF
	make PIDL

test10_rundir:
	rm -rf ${TESTDIR}
	${MAKE} rundir RUNDIR=${TESTDIR}
	cp Param/PARAM.in.test.SCIH_3T ${TESTDIR}/PARAM.in
	cp Param/LAYOUT.in.test.SCIH ${TESTDIR}/LAYOUT.in

test10_run:
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M RESULTS


test10_check:
	-(${SCRIPTDIR}/DiffNum.pl -b -a=1e-27 \
	        ${TESTDIR}/RESULTS/SC/log_n000000.log \
		output/test10/SC_log_n000000.log \
		> test10_sc.diff)
	-(${SCRIPTDIR}/DiffNum.pl -b \
	        ${TESTDIR}/RESULTS/IH/log_n000000.log \
		output/test10/IH_log_n000000.log \
                > test10_ih.diff)
		ls -l test10*.diff

### test11: Dipole field with solar wind coupled with an exosphere model, to test the GM/PT coupler

test11:
	@echo "test11_compile..." > test11_gm.diff
	@echo "test11_compile..." > test11_pt.diff
	${MAKE} test11_compile
	@echo "test11_rundir..." >> test11_gm.diff
	@echo "test11_rundir..." >> test11_pt.diff
	${MAKE} test11_rundir
	@echo "test11_run..." >> test11_gm.diff
	@echo "test11_run..." >> test11_pt.diff
	${MAKE} test11_run
	@echo "test11_check..." >> test11_gm.diff
	@echo "test11_check..." >> test11_pt.diff
	${MAKE} test11_check
	@if([ "${KEEP}" ]); then rm -rf run_$@; mv ${TESTDIR} run_$@; fi

test11_compile:
	./Config.pl -v=Empty,GM/BATSRUS,PT/AMPS
	./Config.pl -g=GM:8,8,8,700,1 -o=GM:u=Default,e=Mhd
	./Config.pl -o=PT:spice-path=nospice,application=coupler-test
	${MAKE} SWMF
	make PIDL

test11_rundir:
	rm -rf ${TESTDIR}
	${MAKE} rundir RUNDIR=${TESTDIR}
	cp Param/PARAM.in.test.GMPT ${TESTDIR}/PARAM.in
	cp Param/LAYOUT.in.test.GMPT ${TESTDIR}/LAYOUT.in

test11_run:
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M RESULTS

# Note: skip columns that depend on number of processors
#       multiply density column by 1e20 to make it order unity
test11_check:
	-(${SCRIPTDIR}/DiffNum.pl -b -a=1e-27 \
	        ${TESTDIR}/RESULTS/GM/log_n000001.log \
		output/test11/log_n000001.log \
		> test11_gm.diff)
	gunzip -c output/test11/pic.NA.s=0.out=19.dat.gz \
	       	> ${TESTDIR}/RESULTS/PT/pic.NA.ref
	cd ${TESTDIR}/RESULTS/PT; \
	        cp -f pic.NA.s=0.out=19.dat pic.NA.dat; \
	        perl -ai -ne 'print "@F[0..3] @F[6..14] ",1e20*$$F[15]," @F[16..$$#F]\n"' \
			pic.NA.ref pic.NA.dat 
	-(${SCRIPTDIR}/DiffNum.pl -a=1e-19 -r=1e-6 -b \
	        ${TESTDIR}/RESULTS/PT/pic.NA.dat \
		${TESTDIR}/RESULTS/PT/pic.NA.ref \
                > test11_pt.diff)
		ls -l test11*.diff

### test13: Europa's exosphere model with coupled Gm and PT components

test13:
	@echo "test13_compile..." > test13_pt.diff
	${MAKE} test13_compile
	@echo "test13_rundir..." >> test13_pt.diff
	${MAKE} test13_rundir
	@echo "test13_run..." >> test13_pt.diff
	${MAKE} test13_run
	@echo "test13_check..." >> test13_pt.diff
	${MAKE} test13_check
	@if([ "${KEEP}" ]); then rm -rf run_$@; mv ${TESTDIR} run_$@; fi

test13_compile:
	./Config.pl -v=Empty,GM/BATSRUS,PT/AMPS
	./Config.pl -g=GM:8,8,8,700,1 -o=GM:u=EuropaSingleMHDPe,e=MhdPe
	./Config.pl -o=PT:spice-path=nospice,spice-kernels=nospice,application=europa-test
	${MAKE} SWMF

test13_rundir:
	rm -rf ${TESTDIR}
	${MAKE} rundir RUNDIR=${TESTDIR}
	cp Param/PARAM.in.test.GMPT.Europa ${TESTDIR}/PARAM.in
	cp Param/LAYOUT.in.test.GMPT.Europa ${TESTDIR}/LAYOUT.in
	cp -r PT/AMPS/data/input/Europa/TestCase/RESTART_n003000 ${TESTDIR}/

test13_run:
	cd ${TESTDIR}; ./Restart.pl -i RESTART_n003000
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog

test13_check:
	cp output/test13/amps.ref_np`ls ${TESTDIR}/PT/thread* | wc -l | tr -d ' '` \
	${TESTDIR}/PT/plots/amps.ref
	-(${SCRIPTDIR}/DiffNum.pl -b \
		${TESTDIR}/PT/plots/amps.dat \
		${TESTDIR}/PT/plots/amps.ref \
		> test13_pt.diff)
		ls -l test13*.diff

### ESMF test ###
#
#       Targets for the ESMF compatible executable
#

test_esmf:
	@echo "test_esmf_compile..." > test_esmf.diff
	${MAKE} test_esmf_compile
	@echo "test_esmf_rundir..." >> test_esmf.diff
	${MAKE} test_esmf_rundir
	@echo "test_esmf_run..." >> test_esmf.diff
	${MAKE} test_esmf_run
	@echo "test_esmf_check..." >> test_esmf.diff
	${MAKE} test_esmf_check
	@if([ "${KEEP}" ]); then rm -rf run_$@; mv ${TESTDIR} run_$@; fi

test_esmf_compile:
	./Config.pl -v=Empty,GM/BATSRUS,IE/Ridley_serial
	./Config.pl -g=GM:8,8,8,400,100,IE:91,181 -o=GM:u=Default,e=Mhd
	${MAKE} ESMF_SWMF

test_esmf_rundir:
	rm -rf ${TESTDIR};
	${MAKE} rundir RUNDIR=${TESTDIR}
	cd ESMF/ESMF_SWMF; ${MAKE} rundir RUNDIR=${TESTDIR}

test_esmf_run: 
	@cd ${TESTDIR}; rm -f PET*ESMF_LogFile
	@cd ${TESTDIR}; ${MPIRUN} ESMF_SWMF.exe > runlog
	@cd ${TESTDIR}; ./PostProc.pl -M RESULTS

test_esmf_check:
	perl -ne 'print if /error/i' ${TESTDIR}/PET*.ESMF_LogFile \
		> test_esmf.diff
	-(${SCRIPTDIR}/DiffNum.pl -b -r=1e-5 -a=1e-12 \
		${TESTDIR}/RESULTS/GM/log_n000001.log \
		ESMF/ESMF_SWMF/output/log_n000001.log \
		>> test_esmf.diff)
	gunzip -c ESMF/ESMF_SWMF/output/it000321_104510_000.idl.gz \
		> ${TESTDIR}/it000321_104510_000.idl.ref
	-(${SCRIPTDIR}/DiffNum.pl -b -r=1e-4 -a=1e-4 \
		${TESTDIR}/RESULTS/IE/it000321_104510_000.idl \
		${TESTDIR}/it000321_104510_000.idl.ref \
		>> test_esmf.diff)
	ls -l test_esmf.diff

#### FOR CCMC ONLY #######################
# CCMC instalation, compiling, and  PostIDL.exe	 generation
# Use "Config.pl -install" before "${MAKE} ccmc_compile" or "make test_ccmc"
# Public version. Specific job scripts are to be substituted for generic mpirun
#
# This version of the test works only with the SWMF versions after May 2009 
# Use Config.pl -install -compiler=pgf90
# Modify the line in test_ccmc_run (see below) 

test_ccmc:
	@echo "test_ccmc_compile..." > test_ccmc.diff
	${MAKE} ccmc_compile
	@echo "test_ccmc_rundir..." >> test_ccmc.diff
	${MAKE} test_ccmc_rundir
	@echo "test_ccmc_run..." >> test_ccmc.diff
	${MAKE} test_ccmc_run
	@echo "test_ccmc_restart_rundir..." >> test_ccmc.diff
	${MAKE} test_ccmc_restart_rundir
	@echo "test_ccmc_run..." >> test_ccmc.diff
	${MAKE} test_ccmc_run
	@echo "test_ccmc_check..." >> test_ccmc.diff
	${MAKE} test_ccmc_check
	@if([ "${KEEP}" ]); then rm -rf run_$@; mv ${TESTDIR} run_$@; fi

ccmc_compile: 
	./Config.pl -v=Empty,GM/BATSRUS,IE/Ridley_serial,IM/RCM2,RB/RBE
	./Config.pl -g=GM:6,6,6,3800,1
	cd GM/BATSRUS; Config.pl -u=CCMC -e=Mhd
	${MAKE} SWMF
	make PIDL

	
test_ccmc_rundir:
	rm -rf ${TESTDIR}
	${MAKE} rundir RUNDIR=${TESTDIR}
	cp -r Param/CCMC ${TESTDIR}/Param_ccmc
	cd ${TESTDIR}; \
		cp -f Param_ccmc/LAYOUT.in_v8.01_init LAYOUT.in; \
		cp -f Param_ccmc/PARAM.in_v8.01_init PARAM.in; \
		${SCRIPTDIR}/replace_amrinit.pl; \
		cp SWMF.exe SWMF_run_test.exe; \
		rm -f SWMF.exe

test_ccmc_run:
	cd ${TESTDIR}; \
		${MPIRUN} ./SWMF_run_test.exe > runlog_`date +%y%m%d%H%M`
	cd ${TESTDIR}/GM; pIDL -ccmc; cd ../IE; pION

# FOR CCMC instead of the line with ${MPIRUN} should be the
# "tab" ${TESTMACHINE}.bat;"space"\"Enter":
# The job scripts shortened(hostname}.bat should be added to share/JobScripts,
# for all machines to be used.
# Here shortened(hostname) is the hostname with deleted number figures (no 0-9)
# For example: for lanai1 this would be lanai.bat


test_ccmc_restart_rundir:
	cd ${TESTDIR}; \
		cp -f Param_ccmc/LAYOUT.in_v8.01_RBE_restart LAYOUT.in; \
		cp -f Param_ccmc/PARAM.in_v8.01_RBE_restart PARAM.in; \
		${SCRIPTDIR}/replace_amrinit.pl; \
		./Restart.pl 

test_ccmc_check:
	${SCRIPTDIR}/DiffNum.pl -b -r=1.0e-5 \
		${TESTDIR}/GM/IO2/log_n002000.log \
		Param/CCMC/test_GM.log > test_ccmc.diff
	ls -l test_ccmc.diff



#### ccmc_small #######
test_ccmc_small:
	@echo "test_ccmc_small_compile..." > test_ccmc_small.diff
	${MAKE} test_ccmc_small_compile
	@echo "test_ccmc_small_rundir..." >> test_ccmc_small.diff
	${MAKE} test_ccmc_small_rundir
	@echo "test_ccmc_small_run..." >> test_ccmc_small.diff
	${MAKE} test_ccmc_small_run
	@echo "test_ccmc_small_restart_rundir..." >> test_ccmc_small.diff
	${MAKE} test_ccmc_small_restart_rundir
	@echo "test_ccmc_small_run..." >> test_ccmc_small.diff
	${MAKE} test_ccmc_small_run
	@echo "test_ccmc_small_check..." >> test_ccmc_small.diff
	${MAKE} test_ccmc_small_check
	@if([ "${KEEP}" ]); then rm -rf run_$@; mv ${TESTDIR} run_$@; fi

test_ccmc_small_compile: 
	./Config.pl -v=Empty,GM/BATSRUS,IE/Ridley_serial,IM/RCM2,RB/RBE
	./Config.pl -g=GM:6,6,6,800,1
	cd GM/BATSRUS; Config.pl -u=CCMC -e=Mhd
	${MAKE} SWMF
	make PIDL


test_ccmc_small_rundir:
	rm -rf ${TESTDIR}
	${MAKE} rundir RUNDIR=${TESTDIR}
	cp -r Param/CCMC ${TESTDIR}/Param_ccmc
	cd ${TESTDIR}; \
		cp -f Param_ccmc/LAYOUT.in_v8.01_init LAYOUT.in; \
		cp -f Param_ccmc/PARAM.in_v8.01_init_small PARAM.in; \
		${SCRIPTDIR}/replace_amrinit.pl; \
		cp SWMF.exe SWMF_run_test.exe; \
		rm -f SWMF.exe

test_ccmc_small_restart_rundir:
	cd ${TESTDIR}; \
		cp -f Param_ccmc/LAYOUT.in_v8.01_RBE_restart LAYOUT.in; \
		cp -f Param_ccmc/PARAM.in_v8.01_RBE_restart_small PARAM.in; \
		${SCRIPTDIR}/replace_amrinit.pl; \
		./Restart.pl 

test_ccmc_small_run:
	$(MAKE)  test_ccmc_run

test_ccmc_small_check:
	-(${SCRIPTDIR}/DiffNum.pl -b -r=1.0e-5 \
		${TESTDIR}/GM/IO2/log_n000400.log \
		Param/CCMC/test_GM_small.log > test_ccmc_small.diff)
	ls -l test_ccmc_small.diff


### test_ramscb: GM+IE+IM/RAMSCB ###

test_ramscb:
	@echo "test_ramscb_compile..." > test_ramscb_gm.diff
	@echo "test_ramscb_compile..." > test_ramscb_ie.diff
	@echo "test_ramscb_compile..." > test_ramscb_im.diff
	${MAKE} test_ramscb_compile
	@echo "test_ramscb_rundir..." >> test_ramscb_gm.diff
	@echo "test_ramscb_rundir..." >> test_ramscb_ie.diff
	@echo "test_ramscb_rundir..." >> test_ramscb_im.diff
	${MAKE} test_ramscb_rundir
	@echo "test_ramscb_run..." >> test_ramscb_gm.diff
	@echo "test_ramscb_run..." >> test_ramscb_ie.diff
	@echo "test_ramscb_run..." >> test_ramscb_im.diff
	${MAKE} test_ramscb_run
	@echo "test_ramscb_check..." >> test_ramscb_gm.diff
	@echo "test_ramscb_check..." >> test_ramscb_ie.diff
	@echo "test_ramscb_check..." >> test_ramscb_im.diff
	${MAKE} test_ramscb_check
	@if([ "${KEEP}" ]); then rm -rf run_$@; mv ${TESTDIR} run_$@; fi

test_ramscb_compile:
	./Config.pl -v=Empty,GM/BATSRUS,IE/Ridley_serial,IM/RAM_SCB
	./Config.pl -g=GM:8,8,8,400,100 -o=GM:u=Default,e=Mhd
	${MAKE} SWMF
	make PIDL

test_ramscb_rundir:
	rm -rf ${TESTDIR}
	${MAKE} rundir RUNDIR=${TESTDIR}
	cp ${IMDIR}/input/PARAM.in.test.gmieim.simple ${TESTDIR}/PARAM.in
	cp ${IMDIR}/input/LAYOUT.in.test.gmieim.simple ${TESTDIR}/LAYOUT.in

# Note: The RCM .dat file is copied to .txt to avoid conversion to .plt
test_ramscb_run:
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M RESULTS

test_ramscb_check:
	-@(${SCRIPTDIR}/DiffNum.pl -b -r=1e-3 -a=1e-8 \
		${TESTDIR}/RESULTS/GM/log_n000001.log \
		${IMDIR}/output/test9/GM_log_n000001.log \
		> test_ramscb_gm.diff)
	-@(${SCRIPTDIR}/DiffNum.pl -b -r=1e-3 -a=1e-8 \
		${TESTDIR}/RESULTS/IM/ram/log_n000001.log \
		${IMDIR}/output/test9/IM_log_n000001.log \
		> test_ramscb_im.diff)
	-@(${SCRIPTDIR}/DiffNum.pl -b -r=1e-6 \
		${TESTDIR}/RESULTS/IE/IE*.log \
		${IMDIR}/output/test9/IE.log \
		> test_ramscb_ie.diff)
	ls -l test_ramscb*.diff

######## test ipic3d stand alone in SWMF  ###############

test12_old:
	@echo "test12_old_compile..." > test12_old.diff
	$(MAKE) test12_old_compile
	@echo "test12_old_rundir..." > test12_old.diff
	$(MAKE) test12_old_rundir
	@echo "test12_old_run..." > test12_old.diff
	$(MAKE) test12_old_run
	@echo "test12_old_check..." > test12_old.diff
	$(MAKE) test12_old_check
	@if([ "${KEEP}" ]); then rm -rf run_$@; mv ${TESTDIR} run_$@; fi

test12_old_compile:
	./Config.pl -hdf5 -v=Empty,PC/IPIC3D 
	./Config.pl -o=PC:npx=2,npy=2,npz=1,periodicX=true,periodicY=false,periodicZ=true,pseudrand=true
	$(MAKE) SWMF
	$(MAKE) PIDL

test12_old_rundir:
	rm -rf ${TESTDIR}
	$(MAKE) rundir RUNDIR=${TESTDIR}
	cp PC/IPIC3D/input/GEM.inp  ${TESTDIR}/IPIC.in
	cp PC/IPIC3D/input/PARAM.in.PC_only  ${TESTDIR}/PARAM.in
	cp PC/IPIC3D/input/LAYOUT.in.PC_only  ${TESTDIR}/LAYOUT.in

test12_old_run:
	@if [ "$(MPIRUN)" = "mpiexec" ]; then \
		cd ${TESTDIR}; mpiexec -np 4 ./SWMF.exe > runlog; \
	else \
		cd ${TESTDIR}; mpirun -np 4 ./SWMF.exe > runlog; \
	fi;

test12_old_check:
	-@(${SCRIPTDIR}/DiffNum.pl -b -a=2.e-13 -r=1e-7 \
		${TESTDIR}/PC/plots/ConservedQuantities.txt \
		PC/IPIC3D/output/ConservedQuantities.txt-GEM-PSEUDRAND\
		> test12_old.diff)
	-@(ls -l test12_old.diff)

######## test ipic3d stand alone in SWMF  ###############

test12_old_2:
	@echo "test12_old_2_compile..." > test12_old_2.diff
	$(MAKE) test12_old_2_compile
	@echo "test12_old_2_rundir..." > test12_old_2.diff
	$(MAKE) test12_old_2_rundir
	@echo "test12_old_2_run..." > test12_old_2.diff
	$(MAKE) test12_old_2_run
	@echo "test12_old_2_check..." > test12_old_2.diff
	$(MAKE) test12_old_2_check
	@if([ "${KEEP}" ]); then rm -rf run_$@; mv ${TESTDIR} run_$@; fi

test12_old_2_compile:
	./Config.pl -hdf5 -v=Empty,PC/IPIC3D 
	./Config.pl -o=PC:npx=2,npy=2,npz=1,periodicX=true,periodicY=false,periodicZ=true,pseudrand=true
	$(MAKE) SWMF
	$(MAKE) PIDL

test12_old_2_rundir:
	rm -rf ${TESTDIR}
	$(MAKE) rundir RUNDIR=${TESTDIR}
	cp PC/IPIC3D/input/PARAM.in.PC_only_new  ${TESTDIR}/PARAM.in
	cp PC/IPIC3D/input/LAYOUT.in.PC_only  ${TESTDIR}/LAYOUT.in

test12_old_2_run:
	@if [ "$(MPIRUN)" = "mpiexec" ]; then \
		cd ${TESTDIR}; mpiexec -np 4 ./SWMF.exe > runlog; \
	else \
		cd ${TESTDIR}; mpirun -np 4 ./SWMF.exe > runlog; \
	fi;

test12_old_2_check:
	-@(${SCRIPTDIR}/DiffNum.pl -b -a=2.e-13 -r=1e-7 \
		${TESTDIR}/PC/plots/ConservedQuantities.txt \
		PC/IPIC3D/output/ConservedQuantities.txt-GEM-PSEUDRAND\
		> test12_old_2.diff)
	-@(ls -l test12_old_2.diff)

######## test IPIC3D coupled with BATSRUS both inside the SWMF #########

test12:
	$(MAKE) test12_aniso
	$(MAKE) test12_iso

# Run on 4 procs with mpirun or mpiexec
test12_run1:
	@if [ "$(MPIRUN)" = "mpiexec" ]; then \
		cd ${TESTDIR}; mpiexec -np 4 ./SWMF.exe < /dev/null | tee runlog; \
	else \
		cd ${TESTDIR}; mpirun -np 4 ./SWMF.exe < /dev/null | tee runlog; \
	fi;

test12_aniso:
	@echo "test12_aniso_compile..." > test12_gmpc_aniso.diff
	$(MAKE) test12_aniso_compile
	@echo "test12_aniso_rundir..." > test12_gmpc_aniso.diff
	$(MAKE) test12_aniso_rundir
	@echo "test12_aniso_run..." > test12_gmpc_aniso.diff
	$(MAKE) test12_aniso_run
	@echo "test12_aniso_check..." > test12_gmpc_aniso.diff
	$(MAKE) test12_aniso_check
	@if([ "${KEEP}" ]); then rm -rf run_$@; mv ${TESTDIR} run_$@; fi

test12_aniso_compile:
	./Config.pl -v=Empty,PC/IPIC3D,GM/BATSRUS -hdf5
	./Config.pl -o=PC:npx=2,npy=2,npz=1,periodicx=false,periodicy=false,periodicZ=true,ng=1,pseudrand=true,h5hut=false
	./Config.pl -g=GM:8,8,1,800,800 -o=GM:u=Waves,e=MhdAnisoP
	$(MAKE) SWMF
	$(MAKE) PIDL
	
test12_aniso_rundir:
	rm -rf ${TESTDIR}
	$(MAKE) rundir RUNDIR=${TESTDIR} COMPDIR=GM,PC
	cp Param/PARAM.in.test.GMPC.start.aniso  ${TESTDIR}/PARAM.in
	cp Param/LAYOUT.in.test.GMPC  ${TESTDIR}/LAYOUT.in

test12_aniso_run:
	$(MAKE) test12_run1
	cd ${TESTDIR}; ./PostProc.pl -m RESULTS/4step
	cp Param/PARAM.in.test.GMPC.start.2step.aniso ${TESTDIR}/PARAM.in
	$(MAKE) test12_run1
	cd ${TESTDIR}; ./PostProc.pl -m RESULTS/2step
	cd ${TESTDIR}; Restart.pl -v -i RESULTS/2step/RESTART
	cp Param/PARAM.in.test.GMPC.restart.2step.aniso ${TESTDIR}/PARAM.in
	$(MAKE) test12_run1
	cd ${TESTDIR}; ./PostProc.pl -m RESULTS/2restart	

test12_aniso_check:
	-@(${SCRIPTDIR}/DiffNum.pl -b -r=1e-10 \
		${TESTDIR}/RESULTS/4step/GM/z=0_var_1_t00000005_n00000004.out \
		output/test12/z=0_var.out.ref.aniso \
		> test12_gmpc_aniso.diff)
	-@(${SCRIPTDIR}/DiffNum.pl -b -r=1e-7 -a=1e-8 \
		${TESTDIR}/RESULTS/4step/GM/z=0_var_1_t00000002_n00000002.out \
		${TESTDIR}/RESULTS/2step/GM/z=0_var_1_t00000002_n00000002.out\
		> test12_gmpc_restart_aniso.diff)
	-@(${SCRIPTDIR}/DiffNum.pl -b -r=1e-7 -a=1e-8 \
		${TESTDIR}/RESULTS/4step/GM/z=0_var_1_t00000005_n00000004.out \
		${TESTDIR}/RESULTS/2restart/GM/z=0_var_1_t00000005_n00000004.out\
		>> test12_gmpc_restart_aniso.diff)
	ls -l test12_gmpc_aniso.diff test12_gmpc_restart_aniso.diff

######## test IPIC3D.exe coupled with SWMF using GM/BATSRUS #########

test12_iso:
	@echo "test12_iso_compile..." > test12_gmpc_iso.diff
	$(MAKE) test12_iso_compile
	@echo "test12_iso_rundir..." > test12_gmpc_iso.diff
	$(MAKE) test12_iso_rundir
	@echo "test12_iso_run..." > test12_gmpc_iso.diff
	$(MAKE) test12_iso_run
	@echo "test12_iso_check..." > test12_gmpc_iso.diff
	$(MAKE) test12_iso_check
	@if([ "${KEEP}" ]); then rm -rf run_$@; mv ${TESTDIR} run_$@; fi

test12_iso_compile:
	./Config.pl -v=Empty,PC/IPIC3D,GM/BATSRUS -hdf5
	./Config.pl -o=PC:npx=2,npy=2,npz=1,periodicx=false,periodicy=false,periodicZ=true,ng=1,pseudrand=true,h5hut=false
	./Config.pl -g=GM:8,8,1,800,800 -o=GM:u=Waves,e=Mhd
	$(MAKE) SWMF
	$(MAKE) PIDL
	
test12_iso_rundir:
	rm -rf ${TESTDIR}
	$(MAKE) rundir RUNDIR=${TESTDIR} COMPDIR=GM,PC
	cp Param/PARAM.in.test.GMPC.start  ${TESTDIR}/PARAM.in
	cp Param/LAYOUT.in.test.GMPC  ${TESTDIR}/LAYOUT.in

test12_iso_run:
	$(MAKE) test12_run1
	cd ${TESTDIR}; ./PostProc.pl RESULTS/4step

test12_iso_check:
	-@(${SCRIPTDIR}/DiffNum.pl -b -a=1e-4 \
		${TESTDIR}/RESULTS/4step/GM/z=0_all_1_t00000004_n00000005.out \
		 output/test12/z=0_all.out.ref.iso\
		> test12_gmpc_iso.diff)
	ls -l test12_gmpc_iso.diff

######## test IPIC3D.exe coupled with SWMF using GM/BATSRUS #########

test_pic:
	$(MAKE) test_pic_compile
	$(MAKE) test_pic_rundir
	$(MAKE) test_pic_run
	$(MAKE) test_pic_check
	$(MAKE) test_pic_2step_run
	$(MAKE) test_pic_2step_check
	$(MAKE) test_pic_restart_setup
	$(MAKE) test_pic_restart_run
	$(MAKE) test_pic_restart_check

test_pic_compile:
	./Config.pl -v=Empty,GM/BATSRUS
	./Config.pl -g=GM:8,8,1,1024,1024 -o=GM:u=Waves,e=MhdAnisoP
	$(MAKE) SWMF
	$(MAKE) PIDL
	cd PC/IPIC3D; ./Config.pl -npx=2 -npy=2 -npz=1 -periodicX=false -periodicY=false -periodicZ=true -ng=1 -pseudrand=true -h5hut=false
	cd PC/IPIC3D; $(MAKE) IPIC3D;
	
test_pic_rundir:
	rm -rf ${TESTDIR}
	$(MAKE) rundir RUNDIR=${TESTDIR}
	cd ${TESTDIR}; ln -s ${BINDIR}/IPIC3D.exe ./
	cp PC/IPIC3D/input/PARAM.in.start_4step  ${TESTDIR}/PARAM.in
	cp PC/IPIC3D/input/IPIC.in.start_4step  ${TESTDIR}/IPIC.in
	cp PC/IPIC3D/input/LAYOUT.in  ${TESTDIR}/LAYOUT.in

test_pic_run:
	cd ${TESTDIR}; mpirun -n 2 ./SWMF.exe < /dev/null | tee runlog.bats &
	cd ${TESTDIR}; mpirun -n 4 ./IPIC3D.exe | tee runlog.ipic #./IPIC.in | tee runlog.ipic
	sleep 5
	cd ${TESTDIR}; ./PostProc.pl RESULTS/4step

test_pic_check:
	-@(${SCRIPTDIR}/DiffNum.pl -b -r=1e-8 \
		${TESTDIR}/RESULTS/4step/GM/z=0_ipic3d_n00000004.out \
		 PC/IPIC3D/input/z=0_ipic3d_n00000004.out.ref \
		> test_pic_4step.diff)

test_pic_2step_run:
	cp PC/IPIC3D/input/PARAM.in.start_2step  ${TESTDIR}/PARAM.in
	cp PC/IPIC3D/input/IPIC.in.start_2step  ${TESTDIR}/IPIC.in
	cd ${TESTDIR}; mpirun -n 2 ./SWMF.exe < /dev/null | tee runlog.bats &
	cd ${TESTDIR}; mpirun -n 4 ./IPIC3D.exe | tee runlog.ipic #./IPIC.in | tee runlog.ipic
	sleep 5
	cd ${TESTDIR}; ./PostProc.pl RESULTS/2step

test_pic_2step_check:
	-@(diff \
		${TESTDIR}/RESULTS/2step/GM/z=0_ipic3d_n00000002.out \
		${TESTDIR}/RESULTS/4step/GM/z=0_ipic3d_n00000002.out \
		> test_pic_2step.diff)

test_pic_restart_setup:
	cd ${TESTDIR}; ./Restart.pl -i -v RESULTS/2step/RESTART
	mkdir -p ${TESTDIR}/RESTART
	cp ${TESTDIR}/RESULTS/2step/GM/restart*hdf ${TESTDIR}/RESTART/
	cp ${TESTDIR}/RESULTS/2step/GM/settings.hdf ${TESTDIR}/RESTART/
	cp PC/IPIC3D/input/PARAM.in.restart_2step  ${TESTDIR}/PARAM.in
	cp PC/IPIC3D/input/IPIC.in.restart_2step  ${TESTDIR}/IPIC.in

test_pic_restart_run:
	cd ${TESTDIR}; mpirun -n 2 ./SWMF.exe < /dev/null | tee runlog.bats &
	cd ${TESTDIR}; mpirun -n 4 ./IPIC3D.exe | tee runlog.ipic #restart ./IPIC.in |tee runlog.ipic 
	sleep 5
	cd ${TESTDIR}; ./PostProc.pl RESULTS/2restartstep

test_pic_restart_check:
	-@(diff ${TESTDIR}/RESULTS/4step/GM/z=0_ipic3d_n00000004.out \
		${TESTDIR}/RESULTS/2restartstep/GM/z=0_ipic3d_n00000004.out \
		> test_pic_restart.diff)
	ls -l test_pic*.diff

######## test IPIC3D coupled with BATSRUS both inside the SWMF #########

test_pic2:
	$(MAKE) test_pic2_compile
	$(MAKE) test_pic2_rundir
	$(MAKE) test_pic2_run
	$(MAKE) test_pic2_check
	$(MAKE) test_pic2_2step_run
	$(MAKE) test_pic2_2step_check
	$(MAKE) test_pic2_restart_setup
	$(MAKE) test_pic2_restart_run
	$(MAKE) test_pic2_restart_check

test_pic2_compile:
	./Config.pl -v=Empty,PC/IPIC3D,GM/BATSRUS -hdf5
	./Config.pl -o=PC:npx=2,npy=2,npz=1,periodicx=false,periodicy=false,periodicZ=true,ng=1,pseudrand=true,h5hut=false
	./Config.pl -g=GM:8,8,1,1024,1024 -o=GM:u=Waves,e=MhdAnisoP
	$(MAKE) SWMF
	$(MAKE) PIDL
	
test_pic2_rundir:
	rm -rf ${TESTDIR}
	$(MAKE) rundir RUNDIR=${TESTDIR} COMPDIR=GM,PC
	cp PC/IPIC3D/input/PARAM.in.start_4step  ${TESTDIR}/PARAM.in
	cp PC/IPIC3D/input/IPIC.in.start_4step  ${TESTDIR}/IPIC.in
	cp PC/IPIC3D/input/LAYOUT.in.GM_PC  ${TESTDIR}/LAYOUT.in

test_pic2_run:
	cp PC/IPIC3D/input/PARAM.in.start_4step_BATSRUS  ${TESTDIR}/PARAM.in
	cd ${TESTDIR}; mpirun -n 2 ./SWMF.exe < /dev/null | tee runlog.bats &
	sleep 5
	cp PC/IPIC3D/input/PARAM.in.start_4step_PC  ${TESTDIR}/PARAM.in
	cd ${TESTDIR}; mpirun -n 4 ./SWMF.exe | tee runlog.ipic #./IPIC.in | tee runlog.ipic
	sleep 5
	cd ${TESTDIR}; ./PostProc.pl  RESULTS/4step

test_pic2_check:
	-@(${SCRIPTDIR}/DiffNum.pl -b -r=1e-8 \
		${TESTDIR}/RESULTS/4step/GM/z=0_ipic3d_n00000004.out \
		 PC/IPIC3D/input/z=0_ipic3d_n00000004.out.ref \
		> test_pic2_4step.diff)
	ls -l test_pic2_4step.diff

test_pic2_2step_run:
	cp PC/IPIC3D/input/IPIC.in.start_2step  ${TESTDIR}/IPIC.in
	cp PC/IPIC3D/input/PARAM.in.start_2step_BATSRUS  ${TESTDIR}/PARAM.in
	cd ${TESTDIR}; mpirun -n 2 ./SWMF.exe < /dev/null | tee runlog.bats &
	sleep 5
	cp PC/IPIC3D/input/PARAM.in.start_2step_PC  ${TESTDIR}/PARAM.in
	cd ${TESTDIR}; mpirun -n 4 ./SWMF.exe | tee runlog.ipic #./IPIC.in | tee runlog.ipic
	sleep 5
	cd ${TESTDIR}; ./PostProc.pl RESULTS/2step

test_pic2_2step_check:
	-@(${SCRIPTDIR}/DiffNum.pl \
		${TESTDIR}/RESULTS/2step/GM/z=0_ipic3d_n00000002.out \
		${TESTDIR}/RESULTS/4step/GM/z=0_ipic3d_n00000002.out \
		> test_pic2_2step.diff)
	ls -l test_pic2_2step.diff

test_pic2_restart_setup:
	cd ${TESTDIR}; ./Restart.pl -i -v RESULTS/2step/RESTART
	mkdir -p ${TESTDIR}/RESTART
	cp ${TESTDIR}/RESULTS/2step/GM/restart*hdf ${TESTDIR}/RESTART/
	cp ${TESTDIR}/RESULTS/2step/GM/settings.hdf ${TESTDIR}/RESTART/
	cp PC/IPIC3D/input/IPIC.in.restart_2step  ${TESTDIR}/IPIC.in

test_pic2_restart_run:
	cp PC/IPIC3D/input/PARAM.in.restart_2step_BATSRUS  ${TESTDIR}/PARAM.in
	cd ${TESTDIR}; mpirun -n 2 ./SWMF.exe < /dev/null | tee runlog.bats &
	sleep 5
	cp PC/IPIC3D/input/PARAM.in.restart_2step_PC  ${TESTDIR}/PARAM.in
	cd ${TESTDIR}; mpirun -n 4 ./SWMF.exe | tee runlog.ipic #restart ./IPIC.in |tee runlog.ipic 
	sleep 5
	cd ${TESTDIR}; ./PostProc.pl RESULTS/2restartstep

test_pic2_restart_check:
	-@(${SCRIPTDIR}/DiffNum${SCRIPTDIR}/DiffNum.pl ${TESTDIR}/RESULTS/4step/GM/z=0_ipic3d_n00000004.out \
		${TESTDIR}/RESULTS/2restartstep/GM/z=0_ipic3d_n00000004.out \
		> test_pic2_restart.diff)
	ls -l test_pic2_*.diff
