#  Copyright (C) 2002 Regents of the University of Michigan, 
#  portions used with permission 
#  For more information, see http://csem.engin.umich.edu/tools/swmf
#^CMP FILE TESTING

TESTDIR = run_test

TESTMACHINE = `hostname | sed -e 's/\..*//; s/[0-9]*$$//'`

test_help:
	@echo "    test                       (run all tests with ${MPIRUN})"
	@echo "    test MPIRUN=               (run tests serially)"
	@echo "    test NPFLAG=-n NP=3        (run tests with ${PARALLEL} -n 3)"
	@echo "    test PARALLEL='mpiexec'    (run tests with mpiexec)"
	@echo "    test_share_library         (run share/Library tests)"
	@echo "    test_util                  (run util/ tests)"
	@echo "    test_batl                  (run BATL tests if BATL/ is present)"
	@echo "    test_comp                  (run component tests)"
	@echo "    test_pw                    (run PW/PWOM test)"
	@echo "    test_pw BLESS=YES          (update test_pw reference solution)"
	@echo "    test_ps                    (run PS/DGCPM test)"
	@echo "    test_swpc                  (run GM-IE-IM test as used by SWPC)"
	@echo "    test_swpc_build            (create SWPC_build and run test_swpc)"
	@echo "    test_swpc_multiion         (run multiion GM-IE-IM test for SWPC)"
	@echo "    test_swpc_multispecies     (run multispecies GM-IE-IM test for SWPC)"
	@echo "    test_swpc_cimi             (run anisotropic GM-IE-IM/CIMI test for SWPC)"
	@echo "    test1 TESTDIR=run_test01   (run GM-IE-PW test in run_test01 directory)"
	@echo "    test4                      (run GM-IE-HEIDI test)"
	@echo "    test5                      (run EE-SC test)"
	@echo "    test7                      (run IH-OH test)"
	@echo "    test8                      (run Thread SC-IH coupling test)"
	@echo "    test9                      (run SC-IH coupling test with SC restart)"
	@echo "    test10                     (run 3T solar wind test)"
	@echo "    test11                     (run GM-PT coupler test)"
	@echo "    test12                     (run GM-PC tests)"
	@echo "    test13                     (run GM-PT test: Europa)"
	@echo "    test14                     (run OH-PT test)"
	@echo "    test14pui                  (run OH-PT test with PUI)"
	@echo "    test15                     (run SC-IH-SP test)"
	@echo "    test15_build               (configure SC-IH-SP, run test)"
	@echo "    test16                     (run GM-FLEKS test: FLEKS uses periodic boundary condition)"	
	@echo "    test17                     (run GM-FLEKS test: 2D Alfven wave)"
	@echo "    test18                     (run GM-FLEKS test: 3D reconnection)"		
	@echo "    test_check                 (collect test results into test_swmf.res)"

.NOTPARALLEL: test

test:
	@rm -f *.diff
	-@(${MAKE} test_share_library)
	-@(${MAKE} test_util)
	-@(${MAKE} test_batl)
	-@(${MAKE} test_comp)
	-@(${MAKE} test_ps TESTDIR=run_test_ps)
	-@(${MAKE} test_swpc TESTDIR=run_test_swpc)
	-@(${MAKE} test_swpc_multiion TESTDIR=run_test_swpc_multiion)
	-@(${MAKE} test_swpc_multispecies TESTDIR=run_test_swpc_multispecies)
	-@(${MAKE} test_swpc_cimi TESTDIR=run_test_swpc_cimi)
	-@(${MAKE} test1 TESTDIR=run_test01)
	-@(${MAKE} test4 TESTDIR=run_test04)
	-@(${MAKE} test5 TESTDIR=run_test05)
	-@(${MAKE} test7 TESTDIR=run_test07)
	-@(${MAKE} test8 TESTDIR=run_test08)
	-@(${MAKE} test9 TESTDIR=run_test09)
	-@(${MAKE} test10 TESTDIR=run_test10)
	-@(${MAKE} test12)
	-@(${MAKE} test13 TESTDIR=run_test13)
	-@(${MAKE} test14 TESTDIR=run_test14)
	-@(${MAKE} test14pui TESTDIR=run_test14pui)
	-@(${MAKE} test15 TESTDIR=run_test15)
	-@(${MAKE} test16 TESTDIR=run_test16)
	-@(${MAKE} test17 TESTDIR=run_test17)
	-@(${MAKE} test18 TESTDIR=run_test18)
	-@(${MAKE} test_check)

# Note: the "cat ... > /dev/null" makes sure that file sizes are correct on nyx

# Setting BLESS=YES or Y will copy the solution into the reference solution
BLESS=NO

DIFFNUM = ${SCRIPTDIR}/DiffNum.pl -BLESS=${BLESS}

DIFF_FILES = share/Library/test/*.diff util/*/src*/*.diff BATL/*.diff ??/*/*.diff *.diff

test_check:
	-@cat ${DIFF_FILES} > /dev/null
	-@ls -ltr  ${DIFF_FILES} > test_swmf.res
	@cat test_swmf.res
	@echo '=============================================================='\
		>> test_swmf.res
	-@head -100 ${DIFF_FILES} >> test_swmf.res
	@echo ' '
	@echo 'See test_swmf.res and test_swmf.log for more detail...'
	@echo ' '
	@echo '=============================================================='\
		>> test_swmf.res
	-@cat GM/BATSRUS/test_func.speed >> test_swmf.res

### Unit tests of the share/Library

test_share_library:
	rm -f share/Library/test/*.diff
	cd share/Library/src; ${MAKE} LIB
	cd share/Library/test; make test
	ls -l share/Library/test/*.diff

### Unit tests of the utilities

test_util:
	cd util; make test

### Unit tests of the BATL library

test_batl:
	@if([ -d BATL ]); then \
		cd BATL; ${MAKE} test; \
	fi

### Component tests ###

test_comp:
	for i in `ls -d [A-Z][A-Z]/*/ | grep -v /Empty/`; \
		do ( cd $$i; ${MAKE} test; ); done
	ls -ltr [A-Z][A-Z]/*/*.diff

### SWMF tests ###

#### Convection Zone model: FSAM test ####

test_cz:
	@echo "starting..."        >  test_cz.diff
	@echo "test_cz_compile..." >> test_cz.diff
	${MAKE} test_cz_compile
	@echo "test_cz_rundir..."  >> test_cz.diff
	${MAKE} test_cz_rundir
	@echo "test_cz_run..."     >> test_cz.diff
	${MAKE} test_cz_run
	@echo "test_cz_check..."   >> test_cz.diff
	${MAKE} test_cz_check

test_cz_compile:
	./Config.pl -v=Empty,CZ/FSAM -fishpak
	cp CZ/FSAM/srcProblem/ModUserSetup.SWMF.f90 CZ/FSAM/src/ModUserSetup.f90
	cp CZ/FSAM/srcProblem/ModPar.SWMF.f90 CZ/FSAM/src/ModPar.f90
	${MAKE} SWMF

test_cz_rundir:
	rm -rf ${TESTDIR}
	${MAKE} rundir RUNDIR=${DIR}/${TESTDIR}
	cp Param/PARAM.in.test.CZ ${TESTDIR}/PARAM.in
	cp ${CZDIR}/input/gong.l4b.14 ${TESTDIR}/

test_cz_run:
	cd ${TESTDIR}; ${PARALLEL} ${NPFLAG} 6 ./SWMF.exe > runlog

test_cz_check:
	-${DIFFNUM} -a=1e-5 -t -p="grep 'ref error='" \
		${TESTDIR}/runlog \
		${CZDIR}/output/runlog.ref \
		> test_cz.diff
	ls -ltr test_cz.diff

#### Polarwind test ###

test_pw:
	@echo "starting..." > test_pw.diff
	@echo "test_pw_compile..." >> test_pw.diff
	${MAKE} test_pw_compile
	@echo "test_pw_rundir..." >> test_pw.diff
	${MAKE} test_pw_rundir
	@echo "test_pw_run..." >> test_pw.diff
	${MAKE} test_pw_run
	@echo "test_pw_check..." >> test_pw.diff
	${MAKE} test_pw_check

test_pw_compile:
	./Config.pl -v=Empty,PW/PWOM -o=PW:Earth
	${MAKE} SWMF
	make PIDL

test_pw_rundir:
	rm -rf ${TESTDIR}
	${MAKE} rundir RUNDIR=${DIR}/${TESTDIR}
	cp Param/PARAM.in.test.PW ${TESTDIR}/PARAM.in

test_pw_run:
	cd ${TESTDIR}/PW; rm -f log.out restartOUT/* plots/*
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog

test_pw_check:
	-@(${DIFFNUM} -b -r=1e-8 \
		${TESTDIR}/PW/plots/north_plots_iline0001.out \
		${PWDIR}/data/output/Earth/north_plots_iline0001.out \
		> test_pw.diff)
	ls -ltr test_pw*.diff


#### Plasmasphere model: DGCPM test ###

test_ps:
	@echo "starting..." > test_ps.diff
	@echo "test_ps_compile..." >> test_ps.diff
	${MAKE} test_ps_compile
	@echo "test_ps_rundir..." >> test_ps.diff
	${MAKE} test_ps_rundir
	@echo "test_ps_run..." >> test_ps.diff
	${MAKE} test_ps_run
	@echo "test_ps_check..." >> test_ps.diff
	${MAKE} test_ps_check	

test_ps_compile:
	./Config.pl -v=Empty,PS/DGCPM
	${MAKE} SWMF
	
test_ps_rundir:
	rm -rf ${TESTDIR}
	${MAKE} rundir RUNDIR=${DIR}/${TESTDIR}
	cp Param/PARAM.in.test.PS ${TESTDIR}/PARAM.in
	cp ${PSDIR}/Input/kp_test.dat ${TESTDIR}/PS/Input/

test_ps_run:
	cd ${TESTDIR}; ${PARALLEL} ${NPFLAG} 1 ./SWMF.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M RESULTS

test_ps_check:
	-@(${DIFFNUM} -t -r=1e-8 \
		${TESTDIR}/RESULTS/PS/dgcpm_t20011021_010000_000.dat \
		${PSDIR}/Output/dgcpm_t20011021_010000_000.ref \
		> test_ps.diff)
	-@(${DIFFNUM} -t -r=1e-8 \
		${TESTDIR}/RESULTS/PS/PS_t20011021_000000_000.log \
		${PSDIR}/Output/PS_t20011021_000000_000.ref \
		>> test_ps.diff)
	-@(${DIFFNUM} -t -r=1e-8 \
		${TESTDIR}/RESULTS/PS/slice_L6p60_t20011021_000000_000.dat \
		${PSDIR}/Output/slice_L6p60_t20011021_000000_000.ref \
		>> test_ps.diff)
	ls -ltr test_ps*.diff


#### Plasmasphere-Ionosphere Coupling: PS-IE/DGCPM-RIM ###

test_psie:
	@echo "starting..." > test_psie.diff
	@echo "test_psie_compile..." >> test_psie.diff
	${MAKE} test_psie_compile
	@echo "test_psie_rundir..." >> test_psie.diff
	${MAKE} test_psie_rundir
	@echo "test_psie_run..." >> test_psie.diff
	${MAKE} test_psie_run
	@echo "test_psie_check..." >> test_psie.diff
	${MAKE} test_psie_check	

test_psie_compile:
	./Config.pl -v=Empty,PS/DGCPM,IE/RIM
	${MAKE} SWMF

test_psie_rundir:
	rm -rf ${TESTDIR}
	${MAKE} rundir RUNDIR=${DIR}/${TESTDIR}
	cp Param/PARAM.in.test.PSIE  ${TESTDIR}/PARAM.in
	cp ${PSDIR}/Input/IMF_NSturning_10nT.dat ${TESTDIR}/

test_psie_run:
	cd ${TESTDIR}; ${PARALLEL} ${NPFLAG} 1 ./SWMF.exe > runlog
	cd ${TESTDIR}/IE; ./pIE
	cd ${TESTDIR}; ./PostProc.pl -M RESULTS

test_psie_check:
	-@(${DIFFNUM} -t -r=1e-8                        \
	        ${TESTDIR}/RESULTS/IE/IE.log                         \
		${PSDIR}/Output/IE_test_psie.ref                     \
		> test_psie.diff)
	-@(${DIFFNUM} -t -r=1e-8                        \
	        ${TESTDIR}/RESULTS/PS/PS_t20000321_104500_000.log    \
		${PSDIR}/Output/PS_test_psie.ref                     \
		>> test_psie.diff)
	-@(${DIFFNUM} -t -r=1e-8                        \
	        ${TESTDIR}/RESULTS/PS/dgcpm_t20000321_105500_000.dat \
		${PSDIR}/Output/dgcpm_testpsie.ref                   \
		>> test_psie.diff)
	ls -ltr test_psie*.diff
	
### Test1: PW+IE+GM ###

test1:
	@echo "test1_compile..." > test01_gm.diff
	@echo "test1_compile..." > test01_ie.diff
	@echo "test1_compile..." > test01_pw.diff
	${MAKE} test1_compile
	@echo "test1_rundir..." >> test01_gm.diff
	@echo "test1_rundir..." >> test01_ie.diff
	@echo "test1_rundir..." >> test01_pw.diff
	${MAKE} test1_rundir
	@echo "test1_run..." >> test01_gm.diff
	@echo "test1_run..." >> test01_ie.diff
	@echo "test1_run..." >> test01_pw.diff
	${MAKE} test1_run
	@echo "test1_check..." >> test01_gm.diff
	@echo "test1_check..." >> test01_ie.diff
	@echo "test1_check..." >> test01_pw.diff
	${MAKE} test1_check

test1_compile:
	./Config.pl -v=Empty,GM/BATSRUS,IE/Ridley_serial,PW/PWOM
	./Config.pl -g=GM:8,8,8,IE:91,181 -o=GM:u=Default,e=Mhd,ng=2,PW:Earth
	${MAKE} SWMF
	make PIDL

test1_rundir:
	rm -rf ${TESTDIR}
	${MAKE} rundir RUNDIR=${DIR}/${TESTDIR}
	cp Param/PARAM.in.test.GMIEPW ${TESTDIR}/PARAM.in

test1_run:
	cd ${TESTDIR}/PW; rm -f log.out restartOUT/* plots/*
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M RESULTS

test1_check:
	-@(${DIFFNUM} -b -r=1e-7 \
		${TESTDIR}/RESULTS/PW/north_plots_iline0001.out \
		PW/PWOM/data/output/Earth/PW_north_plots_iline0001.out \
		> test01_pw.diff)
	-@(${DIFFNUM} -b -a=1e-20 -r=1e-7 \
		${TESTDIR}/RESULTS/PW/north_plots_iline0002.out \
		PW/PWOM/data/output/Earth/PW_north_plots_iline0002.out \
		>> test01_pw.diff)
	-@(${DIFFNUM} -b -r=1e-7 \
		${TESTDIR}/RESULTS/PW/north_plots_iline0003.out \
		PW/PWOM/data/output/Earth/PW_north_plots_iline0003.out \
		>> test01_pw.diff)
	-@(${DIFFNUM} -b -r=1e-7 \
		${TESTDIR}/RESULTS/PW/north_plots_iline0004.out \
		PW/PWOM/data/output/Earth/PW_north_plots_iline0004.out \
		>> test01_pw.diff)
	-@(${DIFFNUM} -b -r=1e-3 -a=1e-8 \
		${TESTDIR}/RESULTS/GM/log_n000001.log \
		output/test1/GM_log_n000001.log \
		> test01_gm.diff)
	-@(${DIFFNUM} -b -t -r=1e-5 \
		${TESTDIR}/RESULTS/IE/IE*.log \
		output/test1/IE.log \
		> test01_ie.diff)
	-@(${DIFFNUM} -b -r=1e-4 -a=6e-5 \
		${TESTDIR}/RESULTS/IE/it000321_104510_000.idl \
		output/test1/IE*.idl.gz \
		>> test01_ie.diff)
	ls -l test01_*.diff

### Test2: GM+IE+RCM with multifluid GM-IM coupling ###

test2:  
	@echo "test2_compile..." > test02_gm_multi.diff
	@echo "test2_compile..." > test02_ie.diff	
	@echo "test2_compile..." > test02_im_rcm_multi.diff
	${MAKE} test2_compile
	@echo "test2_rundir..." >> test02_gm_multi.diff
	@echo "test2_rundir..." >> test02_ie.diff
	@echo "test2_rundir..." >> test02_im_rcm_multi.diff
	${MAKE} test2_rundir
	@echo "test2_run..." >> test02_gm_multi.diff
	@echo "test2_run..." >> test02_ie.diff
	@echo "test2_run..." >> test02_im_rcm_multi.diff
	${MAKE} test2_run
	@echo "test2_restart..." >> test02_gm_multi.diff
	@echo "test2_restart..." >> test02_ie.diff
	@echo "test2_restart..." >> test02_im_rcm_multi.diff
	${MAKE} test2_restart
	@echo "test2_check..." >> test02_gm_multi.diff
	@echo "test2_check..." >> test02_ie.diff
	@echo "test2_check..." >> test02_im_rcm_multi.diff
	${MAKE} test2_check

test2_compile:
	./Config.pl -v=Empty,GM/BATSRUS,IE/Ridley_serial,IM/RCM2
	./Config.pl -g=GM:8,8,8,IE:91,181 -o=GM:u=Default,e=MhdIons,ng=2
	${MAKE} SWMF
	make PIDL

test2_rundir:
	rm -rf ${TESTDIR}
	${MAKE} rundir RUNDIR=${DIR}/${TESTDIR}
	cp Param/PARAM.in.test.GMIERCM_Multi ${TESTDIR}/PARAM.in

test2_run:
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog
	cd ${TESTDIR}; ./Restart.pl

test2_restart:
	cd ${TESTDIR}; cp Param/PARAM.in.test.restart.GMIERCM_Multi PARAM.in
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog_restart
	cd ${TESTDIR}/IM/plots/; cp 2d__max_t00000020.dat t20.txt
	cd ${TESTDIR}; ./PostProc.pl -M -cat RESULTS; \
		mv runlog_restart RESULTS

test2_check:
	-@(${DIFFNUM} -b -r=1e-5 -a=1e-8 \
		${TESTDIR}/RESULTS/GM/log_n000001.log \
		output/test2/GM_log_n000001.log \
		> test02_gm_multi.diff)
	-@(${DIFFNUM} -b -r=1e-5 -a=1e-8 \
		${TESTDIR}/RESULTS/GM/magnetometers_n*.mag \
		output/test2/magnetometers.mag \
		>> test02_gm_multi.diff)
	-@(${DIFFNUM} -b -r=1e-5 -a=1e-8 \
		${TESTDIR}/RESULTS/GM/geoindex_n*.log \
		output/test2/GM_geoindex.log \
		>> test02_gm_multi.diff)
	-@(${DIFFNUM} -b -r=1e-5 -a=1e-4 \
		${TESTDIR}/RESULTS/RESTART/GM/x_geoindex.rst \
		output/test2/GM_restart_geoindex.txt \
		>> test02_gm_multi.diff)
	-@(${DIFFNUM} -b -r=1e-5 \
		${TESTDIR}/RESULTS/IE/IE_t000321_104500.log \
		output/test2/IE.log \
		> test02_ie.diff) 
	-@(${DIFFNUM} -b -r=1e-3 -a=1e-8 -p="grep -v 'AUXDATA SAVEDATE='" \
		${TESTDIR}/RESULTS/IM/t20.dat \
		output/test2/IM_2d__max_t00000020.dat.gz \
		> test02_im_rcm_multi.diff)
	ls -l test02_*.diff

### test_swpc_build and test_swpc: GM+IE+IM+RB ###

# Configure with 3 components: GM, IE, IM. Remove unused component versions.
# Run test_swpc in the reduced SWMF build SWPC_build.

BUILD=SWPC_build
test_swpc_build:
	rm -rf ${BUILD}
	Scripts/Configure.pl -d=${BUILD}
	cd ${BUILD}; rm -rf IM/HEIDI IM/CIMI IE/RIM util/HYPRE
	cd ${BUILD}; ./Config.pl -install \
	   	     	-compiler=${FORTRAN_COMPILER_NAME},${C_COMPILER_NAME}
	cd ${BUILD}; make test_swpc

test_swpc:
	@echo "test_swpc_compile..." > test_swpc_gm.diff
	@echo "test_swpc_compile..." > test_swpc_ie.diff
	@echo "test_swpc_compile..." > test_swpc_rb.diff
	${MAKE} test_swpc_compile
	@echo "test_swpc_rundir..." >> test_swpc_gm.diff
	@echo "test_swpc_rundir..." >> test_swpc_ie.diff
	@echo "test_swpc_rundir..." >> test_swpc_rb.diff
	${MAKE} test_swpc_rundir
	@echo "test_swpc_run..." >> test_swpc_gm.diff
	@echo "test_swpc_run..." >> test_swpc_ie.diff
	@echo "test_swpc_run..." >> test_swpc_rb.diff
	${MAKE} test_swpc_run
	@echo "test_swpc_restart..." >> test_swpc_gm.diff
	@echo "test_swpc_restart..." >> test_swpc_ie.diff
	@echo "test_swpc_restart..." >> test_swpc_rb.diff
	${MAKE} test_swpc_restart
	@echo "test_swpc_check..." >> test_swpc_gm.diff
	@echo "test_swpc_check..." >> test_swpc_ie.diff
	@echo "test_swpc_check..." >> test_swpc_rb.diff
	${MAKE} test_swpc_check

test_swpc_compile:
	./Config.pl -v=Empty,GM/BATSRUS,IE/Ridley_serial,IM/RCM2,RB/RBE
	./Config.pl -g=GM:8,8,8,IE:91,181 -o=GM:u=Default,e=Mhd,ng=2
	${MAKE} SWMF
	make PIDL

test_swpc_rundir:
	rm -rf ${TESTDIR}
	${MAKE} rundir RUNDIR=${DIR}/${TESTDIR}
	cp Param/SWPC/*.in* Param/SWPC/*.dat ${TESTDIR}/
	perl -pi -e 'if(/MaxIter|MaxBlock/){s/700/70/; s/1500/200/; s/5000/350/}; s/#BORIS/BORIS/' \
	     ${TESTDIR}/PARAM.in_SWPC_v2_init ${TESTDIR}/PARAM.in_SWPC_v2_restart
	cp ${TESTDIR}/PARAM.in_SWPC_v2_init ${TESTDIR}/PARAM.in

test_swpc_run:
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog
	cd ${TESTDIR}; ./Restart.pl -i SWMF_RESTART.20140410_000200

# Note: The RCM .dat file is copied to .txt to avoid conversion to .plt
test_swpc_restart:
	cd ${TESTDIR}; cp PARAM.in_SWPC_v2_restart PARAM.in
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog_restart
	cd ${TESTDIR}; ./PostProc.pl -noptec

test_swpc_check:
	-@(${DIFFNUM} -b -r=1e-5 -a=1e-8 \
		${TESTDIR}/GM/IO2/log_e20140410-000200.log \
		Param/SWPC/TestOutput/log_e20140410-000200.log \
		> test_swpc_gm.diff)
	-@(${DIFFNUM} -b -r=2e-4 -a=1e-5 \
		${TESTDIR}/GM/IO2/magnetometers_e20140410-000200.mag \
		Param/SWPC/TestOutput/magnetometers_e20140410-000200.mag \
		>> test_swpc_gm.diff)
	-@(${DIFFNUM} -b -r=2e-4 -a=1e-5 \
		${TESTDIR}/GM/IO2/mag_grid_e20140410-000300.out \
		Param/SWPC/TestOutput/mag_grid_e20140410-000300.out \
		>> test_swpc_gm.diff)
	-@(${DIFFNUM} -b -r=1e-5 -a=1e-8 \
		${TESTDIR}/GM/IO2/geoindex_e20140410-000200.log \
		Param/SWPC/TestOutput/geoindex_e20140410-000200.log \
		>> test_swpc_gm.diff)
	-@(${DIFFNUM} -b -r=1e-5 \
		${TESTDIR}/IE/ionosphere/IE_t140410_000200.log \
		Param/SWPC/TestOutput/IE_t140410_000200.log \
		> test_swpc_ie.diff)
	-@(${DIFFNUM} -b -r=1e-4 -a=5e-5 \
		${TESTDIR}/IE/ionosphere/it140410_000300_000.idl \
		Param/SWPC/TestOutput/it140410_000300_000.idl \
		>> test_swpc_ie.diff)
	-@(${DIFFNUM} -b -r=1e-3 \
                ${TESTDIR}/RB/plots/20140410_000300_e.fls \
		Param/SWPC/TestOutput/RB_20140410_000300_e.fls.gz \
		> test_swpc_rb.diff)
	ls -l test_swpc_??.diff

### test_swpc_multiion: GM+IE+IM ###

test_swpc_multiion:
	@echo "test_swpc_multiion_compile..." > test_swpc_multiion_gm.diff
	@echo "test_swpc_multiion_compile..." > test_swpc_multiion_ie.diff
	${MAKE} test_swpc_multiion_compile
	@echo "test_swpc_multiion_rundir..." >> test_swpc_multiion_gm.diff
	@echo "test_swpc_multiion_rundir..." >> test_swpc_multiion_ie.diff
	${MAKE} test_swpc_multiion_rundir
	@echo "test_swpc_multiion_run..." >> test_swpc_multiion_gm.diff
	@echo "test_swpc_multiion_run..." >> test_swpc_multiion_ie.diff
	${MAKE} test_swpc_multiion_run
	@echo "test_swpc_multiion_restart..." >> test_swpc_multiion_gm.diff
	@echo "test_swpc_multiion_restart..." >> test_swpc_multiion_ie.diff
	${MAKE} test_swpc_multiion_restart
	@echo "test_swpc_multiion_check..." >> test_swpc_multiion_gm.diff
	@echo "test_swpc_multiion_check..." >> test_swpc_multiion_ie.diff
	${MAKE} test_swpc_multiion_check

test_swpc_multiion_compile:
	./Config.pl -v=Empty,GM/BATSRUS,IE/Ridley_serial,IM/RCM2
	./Config.pl -g=GM:8,8,8,IE:91,181 -o=GM:u=Default,e=MultiIon,ng=2
	${MAKE} SWMF
	make PIDL

test_swpc_multiion_rundir:
	rm -rf ${TESTDIR}
	${MAKE} rundir RUNDIR=${DIR}/${TESTDIR}
	cp Param/SWPC/*.in* Param/SWPC/*.dat ${TESTDIR}/
	perl -pi -e 'if(/MaxIter|MaxBlock/){s/700/70/; s/1500/200/; s/5000/350/}; s/#BORIS/BORIS/' \
	     ${TESTDIR}/PARAM.in_multiion_v2_*
	cp ${TESTDIR}/PARAM.in_multiion_v2_init ${TESTDIR}/PARAM.in

test_swpc_multiion_run:
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog
	cd ${TESTDIR}; ./Restart.pl -i SWMF_RESTART.20140410_000200

test_swpc_multiion_restart:
	cd ${TESTDIR}; cp PARAM.in_multiion_v2_restart PARAM.in
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog_restart
	cd ${TESTDIR}; ./PostProc.pl -noptec

test_swpc_multiion_check:
	-@(${DIFFNUM} -b -r=1e-5 -a=1e-8 \
		${TESTDIR}/GM/IO2/log_e20140410-000200.log \
		Param/SWPC/TestOutputMultiIon/log_e20140410-000200.log \
		> test_swpc_multiion_gm.diff)
	-@(${DIFFNUM} -b -r=2e-4 -a=1e-5 \
		${TESTDIR}/GM/IO2/magnetometers_e20140410-000200.mag \
		Param/SWPC/TestOutputMultiIon/magnetometers_e20140410-000200.mag \
		>> test_swpc_multiion_gm.diff)
	-@(${DIFFNUM} -b -r=2e-4 -a=1e-5 \
		${TESTDIR}/GM/IO2/mag_grid_e20140410-000300.out \
		Param/SWPC/TestOutputMultiIon/mag_grid_e20140410-000300.out \
		>> test_swpc_multiion_gm.diff)
	-@(${DIFFNUM} -b -r=1e-5 -a=1e-8 \
		${TESTDIR}/GM/IO2/geoindex_e20140410-000200.log \
		Param/SWPC/TestOutputMultiIon/geoindex_e20140410-000200.log \
		>> test_swpc_multiion_gm.diff)
	-@(${DIFFNUM} -b -r=1e-5 \
		${TESTDIR}/IE/ionosphere/IE_t140410_000200.log \
		Param/SWPC/TestOutputMultiIon/IE_t140410_000200.log \
		> test_swpc_multiion_ie.diff)
	-@(${DIFFNUM} -b -r=1e-4 -a=5e-5 \
		${TESTDIR}/IE/ionosphere/it140410_000300_000.idl \
		Param/SWPC/TestOutputMultiIon/it140410_000300_000.idl \
		>> test_swpc_multiion_ie.diff)
	ls -l test_swpc_multiion_*.diff

### test_swpc_multispecies: GM+IE+IM ###

test_swpc_multispecies:
	@echo "test_swpc_multispecies_compile..." > test_swpc_multispecies_gm.diff
	@echo "test_swpc_multispecies_compile..." > test_swpc_multispecies_ie.diff
	${MAKE} test_swpc_multispecies_compile
	@echo "test_swpc_multispecies_rundir..." >> test_swpc_multispecies_gm.diff
	@echo "test_swpc_multispecies_rundir..." >> test_swpc_multispecies_ie.diff
	${MAKE} test_swpc_multispecies_rundir
	@echo "test_swpc_multispecies_run..." >> test_swpc_multispecies_gm.diff
	@echo "test_swpc_multispecies_run..." >> test_swpc_multispecies_ie.diff
	${MAKE} test_swpc_multispecies_run
	@echo "test_swpc_multispecies_restart..." >> test_swpc_multispecies_gm.diff
	@echo "test_swpc_multispecies_restart..." >> test_swpc_multispecies_ie.diff
	${MAKE} test_swpc_multispecies_restart
	@echo "test_swpc_multispecies_check..." >> test_swpc_multispecies_gm.diff
	@echo "test_swpc_multispecies_check..." >> test_swpc_multispecies_ie.diff
	${MAKE} test_swpc_multispecies_check

test_swpc_multispecies_compile:
	./Config.pl -v=Empty,GM/BATSRUS,IE/Ridley_serial,IM/RCM2
	./Config.pl -g=GM:8,8,8,IE:91,181 -o=GM:u=Default,e=MhdHpOp,ng=2
	${MAKE} SWMF
	make PIDL

test_swpc_multispecies_rundir:
	rm -rf ${TESTDIR}
	${MAKE} rundir RUNDIR=${DIR}/${TESTDIR}
	cp Param/SWPC/*.in* Param/SWPC/*.dat ${TESTDIR}/
	perl -pi -e 'if(/MaxIter|MaxBlock/){s/700/70/; s/1500/200/; s/5000/350/}; s/#BORIS/BORIS/' \
	     ${TESTDIR}/PARAM.in_multispecies_v2_*
	cp ${TESTDIR}/PARAM.in_multispecies_v2_init ${TESTDIR}/PARAM.in

test_swpc_multispecies_run:
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog
	cd ${TESTDIR}; ./Restart.pl -i SWMF_RESTART.20140410_000200

test_swpc_multispecies_restart:
	cd ${TESTDIR}; cp PARAM.in_multispecies_v2_restart PARAM.in
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog_restart
	cd ${TESTDIR}; ./PostProc.pl -noptec

test_swpc_multispecies_check:
	-@(${DIFFNUM} -b -r=1e-5 -a=1e-8 \
		${TESTDIR}/GM/IO2/log_e20140410-000200.log \
		Param/SWPC/TestOutputMultiSpecies/log_e20140410-000200.log \
		> test_swpc_multispecies_gm.diff)
	-@(${DIFFNUM} -b -r=2e-4 -a=1e-5 \
		${TESTDIR}/GM/IO2/magnetometers_e20140410-000200.mag \
		Param/SWPC/TestOutputMultiSpecies/magnetometers_e20140410-000200.mag \
		>> test_swpc_multispecies_gm.diff)
	-@(${DIFFNUM} -b -r=2e-4 -a=1e-5 \
		${TESTDIR}/GM/IO2/mag_grid_e20140410-000300.out \
		Param/SWPC/TestOutputMultiSpecies/mag_grid_e20140410-000300.out \
		>> test_swpc_multispecies_gm.diff)
	-@(${DIFFNUM} -b -r=1e-5 -a=1e-8 \
		${TESTDIR}/GM/IO2/geoindex_e20140410-000200.log \
		Param/SWPC/TestOutputMultiSpecies/geoindex_e20140410-000200.log \
		>> test_swpc_multispecies_gm.diff)
	-@(${DIFFNUM} -b -r=1e-5 \
		${TESTDIR}/IE/ionosphere/IE_t140410_000200.log \
		Param/SWPC/TestOutputMultiSpecies/IE_t140410_000200.log \
		> test_swpc_multispecies_ie.diff)
	-@(${DIFFNUM} -b -r=1e-4 -a=5e-5 \
		${TESTDIR}/IE/ionosphere/it140410_000300_000.idl \
		Param/SWPC/TestOutputMultiSpecies/it140410_000300_000.idl \
		>> test_swpc_multispecies_ie.diff)
	ls -l test_swpc_multispecies_*.diff

### test_swpc_cimi: GM+IE+IM/CIMI ###

test_swpc_cimi:
	@echo "test_swpc_cimi_compile..." > test_swpc_cimi_gm.diff
	@echo "test_swpc_cimi_compile..." > test_swpc_cimi_ie.diff
	${MAKE} test_swpc_cimi_compile
	@echo "test_swpc_cimi_rundir..." >> test_swpc_cimi_gm.diff
	@echo "test_swpc_cimi_rundir..." >> test_swpc_cimi_ie.diff
	${MAKE} test_swpc_cimi_rundir
	@echo "test_swpc_cimi_run..." >> test_swpc_cimi_gm.diff
	@echo "test_swpc_cimi_run..." >> test_swpc_cimi_ie.diff
	${MAKE} test_swpc_cimi_run
	@echo "test_swpc_cimi_restart..." >> test_swpc_cimi_gm.diff
	@echo "test_swpc_cimi_restart..." >> test_swpc_cimi_ie.diff
	${MAKE} test_swpc_cimi_restart
	@echo "test_swpc_cimi_check..." >> test_swpc_cimi_gm.diff
	@echo "test_swpc_cimi_check..." >> test_swpc_cimi_ie.diff
	${MAKE} test_swpc_cimi_check

test_swpc_cimi_compile:
	./Config.pl -v=Empty,GM/BATSRUS,IE/Ridley_serial,IM/CIMI
	./Config.pl -g=GM:8,8,8,IE:91,181 -o=GM:u=Default,e=MhdAnisoP,ng=2
	./Config.pl -o=IM:EarthHO,GridExpanded
	${MAKE} SWMF
	make PIDL

test_swpc_cimi_rundir:
	rm -rf ${TESTDIR}
	${MAKE} rundir RUNDIR=${DIR}/${TESTDIR}
	cp Param/SWPC/*.in* Param/SWPC/*.dat ${TESTDIR}/
	perl -pi -e 'if(/MaxIter|MaxBlock/){s/700/70/; s/1500/200/; s/5000/350/}; s/#BORIS/BORIS/' \
	     ${TESTDIR}/PARAM.in_cimi_v2_*
	cp ${TESTDIR}/PARAM.in_cimi_v2_init ${TESTDIR}/PARAM.in

test_swpc_cimi_run:
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog
	cd ${TESTDIR}; ./Restart.pl -i SWMF_RESTART.20140410_000200

test_swpc_cimi_restart:
	cd ${TESTDIR}; cp PARAM.in_cimi_v2_restart PARAM.in
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog_restart
	cd ${TESTDIR}; ./PostProc.pl -noptec

test_swpc_cimi_check:
	-@(${DIFFNUM} -b -r=1e-5 -a=1e-8 \
		${TESTDIR}/GM/IO2/log_e20140410-000200.log \
		Param/SWPC/TestOutputCimi/log_e20140410-000200.log \
		> test_swpc_cimi_gm.diff)
	-@(${DIFFNUM} -b -r=2e-4 -a=1e-5 \
		${TESTDIR}/GM/IO2/magnetometers_e20140410-000200.mag \
		Param/SWPC/TestOutputCimi/magnetometers_e20140410-000200.mag \
		>> test_swpc_cimi_gm.diff)
	-@(${DIFFNUM} -b -r=2e-4 -a=1e-5 \
		${TESTDIR}/GM/IO2/mag_grid_e20140410-000300.out \
		Param/SWPC/TestOutputCimi/mag_grid_e20140410-000300.out \
		>> test_swpc_cimi_gm.diff)
	-@(${DIFFNUM} -b -r=1e-5 -a=1e-8 \
		${TESTDIR}/GM/IO2/geoindex_e20140410-000200.log \
		Param/SWPC/TestOutputCimi/geoindex_e20140410-000200.log \
		>> test_swpc_cimi_gm.diff)
	-@(${DIFFNUM} -b -r=1e-5 \
		${TESTDIR}/IE/ionosphere/IE_t140410_000200.log \
		Param/SWPC/TestOutputCimi/IE_t140410_000200.log \
		> test_swpc_cimi_ie.diff)
	-@(${DIFFNUM} -b -r=1e-4 -a=5e-5 \
		${TESTDIR}/IE/ionosphere/it140410_000300_000.idl \
		Param/SWPC/TestOutputCimi/it140410_000300_000.idl \
		>> test_swpc_cimi_ie.diff)
	ls -l test_swpc_cimi_*.diff

### test_swpc_amps

test_swpc_amps_build:
	rm -rf ${BUILD}
	Scripts/Configure.pl -d=${BUILD} -on=PT
	cd ${BUILD}; rm -rf IM/HEIDI IM/CIMI IE/RIM util/HYPRE
	cd ${BUILD}; ./Config.pl -install \
	   	     	-compiler=${FORTRAN_COMPILER_NAME},${C_COMPILER_NAME}
	cd ${BUILD}; make test_swpc_amps

test_swpc_amps:
	@echo "test_swpc_amps_compile..." > test_swpc_amps_gm.diff
	@echo "test_swpc_amps_compile..." > test_swpc_amps_ie.diff
	@echo "test_swpc_amps_compile..." > test_swpc_amps_rb.diff
	${MAKE} test_swpc_amps_compile
	@echo "test_swpc_amps_rundir..." >> test_swpc_amps_gm.diff
	@echo "test_swpc_amps_rundir..." >> test_swpc_amps_ie.diff
	@echo "test_swpc_amps_rundir..." >> test_swpc_amps_rb.diff
	${MAKE} test_swpc_amps_rundir
	@echo "test_swpc_amps_run..." >> test_swpc_amps_gm.diff
	@echo "test_swpc_amps_run..." >> test_swpc_amps_ie.diff
	@echo "test_swpc_amps_run..." >> test_swpc_amps_rb.diff
	${MAKE} test_swpc_amps_run
	@echo "test_swpc_amps_restart..." >> test_swpc_amps_gm.diff
	@echo "test_swpc_amps_restart..." >> test_swpc_amps_ie.diff
	@echo "test_swpc_amps_restart..." >> test_swpc_amps_rb.diff
	${MAKE} test_swpc_amps_restart
	@echo "test_swpc_amps_check..." >> test_swpc_amps_gm.diff
	@echo "test_swpc_amps_check..." >> test_swpc_amps_ie.diff
	@echo "test_swpc_amps_check..." >> test_swpc_amps_rb.diff
	${MAKE} test_swpc_amps_check

test_swpc_amps_compile:
	./Config.pl -v=Empty,GM/BATSRUS,IE/Ridley_serial,IM/RCM2,RB/RBE,PT/AMPS
	./Config.pl -g=GM:8,8,8,IE:91,181 -o=GM:u=Default,e=Mhd,ng=2
	./Config.pl -o=PT:application=test/earth-test-swmf,spice-path=nospice,amps-test=on 
	${MAKE} SWMF
	make PIDL

test_swpc_amps_rundir:
	rm -rf ${TESTDIR}
	${MAKE} rundir RUNDIR=${DIR}/${TESTDIR}
	cp Param/SWPC/*.in* Param/SWPC/*.dat ${TESTDIR}/
	perl -pi -e 'if(/MaxIter/){s/700/70/; s/1500/200/}; s/#BORIS/BORIS/' \
	     ${TESTDIR}/PARAM.in_amps_init
	cp ${TESTDIR}/PARAM.in_amps_init ${TESTDIR}/PARAM.in
	perl -pi -e 's/#BORIS/BORIS/' ${TESTDIR}/PARAM.in_amps_restart

test_swpc_amps_run:
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog
	cd ${TESTDIR}; ./Restart.pl -i SWMF_RESTART.20140410_000200

# Note: The RCM .dat file is copied to .txt to avoid conversion to .plt
test_swpc_amps_restart:
	cd ${TESTDIR}; cp PARAM.in_amps_restart PARAM.in
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog_restart
	cd ${TESTDIR}; ./PostProc.pl -noptec

test_swpc_amps_check:
	-@(${DIFFNUM} -b -r=1e-5 -a=1e-8 \
		${TESTDIR}/GM/IO2/log_e20140410-000200.log \
		Param/SWPC/TestOutput/log_e20140410-000200.log \
		> test_swpc__amps_gm.diff)
	-@(${DIFFNUM} -b -r=2e-4 -a=1e-8 \
		${TESTDIR}/GM/IO2/magnetometers_e20140410-000200.mag \
		Param/SWPC/TestOutput/magnetometers_e20140410-000200.mag \
		>> test_swpc_amps_gm.diff)
	-@(${DIFFNUM} -b -r=2e-4 -a=1e-8 \
		${TESTDIR}/GM/IO2/mag_grid_e20140410-000300.out \
		Param/SWPC/TestOutput/mag_grid_e20140410-000300.out \
		>> test_swpc_amps_gm.diff)
	-@(${DIFFNUM} -b -r=1e-5 -a=1e-8 \
		${TESTDIR}/GM/IO2/geoindex_e20140410-000200.log \
		Param/SWPC/TestOutput/geoindex_e20140410-000200.log \
		>> test_swpc_amps_gm.diff)
	-@(${DIFFNUM} -b -r=1e-5 \
		${TESTDIR}/IE/ionosphere/IE_t140410_000200.log \
		Param/SWPC/TestOutput/IE_t140410_000200.log \
		> test_swpc_amps_ie.diff)
	-@(${DIFFNUM} -b -r=1e-4 -a=5e-5 \
		${TESTDIR}/IE/ionosphere/it140410_000300_000.idl \
		Param/SWPC/TestOutput/it140410_000300_000.idl \
		>> test_swpc_amps_ie.diff)
	-@(${DIFFNUM} -b -r=1e-3 \
                ${TESTDIR}/RB/plots/20140410_000300_e.fls \
		Param/SWPC/TestOutput/RB_20140410_000300_e.fls.gz \
		> test_swpc_amps_rb.diff)
	ls -l test_swpc_amps_??.diff

### Test4: GM+IE+HEIDI ###############

test4:
	@echo "test4_compile..." > test04_gm.diff
	@echo "test4_compile..." > test04_ie.diff
	@echo "test4_compile..." > test04_im_heidi.diff
	${MAKE} test4_compile
	@echo "test4_rundir..." >> test04_gm.diff
	@echo "test4_rundir..." >> test04_ie.diff
	@echo "test4_rundir..." >> test04_im_heidi.diff
	${MAKE} test4_rundir
	@echo "test4_run..." >> test04_gm.diff
	@echo "test4_run..." >> test04_ie.diff
	@echo "test4_run..." >> test04_im_heidi.diff
	${MAKE} test4_run
	@echo "test4_check..." >> test04_gm.diff
	@echo "test4_check..." >> test04_ie.diff
	@echo "test4_check..." >> test04_im_heidi.diff
	${MAKE} test4_check

test4_compile:
	./Config.pl -v=Empty,GM/BATSRUS,IE/Ridley_serial,IM/HEIDI
	./Config.pl -g=GM:8,8,8,IE:91,181 -o=GM:u=Default,e=Mhd,ng=2
	${MAKE} SWMF
	make PIDL

test4_rundir:
	rm -rf ${TESTDIR}
	${MAKE} rundir RUNDIR=${DIR}/${TESTDIR}
	cp Param/PARAM.in.test.GMIEHEIDI ${TESTDIR}/PARAM.in

test4_run:
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M RESULTS

test4_check:
	-@(${DIFFNUM} -b -r=1e-3 -a=1e-8 \
		${TESTDIR}/RESULTS/GM/log_n000000.log \
		output/test4/GM_log_n000000.log \
		> test04_gm.diff)
	-@(${DIFFNUM} -b -t -r=1e-5 \
		${TESTDIR}/RESULTS/IE/IE*.log \
		output/test4/IE.log \
		> test04_ie.diff)
	-@(${DIFFNUM} -b -t -a=re-3 -a=1e-30 \
                ${TESTDIR}/RESULTS/IM/hydrogen/test1_h_prs.002 \
                output/test4/IM_test1_h_prs.002\
                > test04_im_heidi.diff)
	ls -l test04_*.diff

### test5: Eruptive Event generator coupled to the corona ###
test5:
	@echo "test5_compile..." > test05_ee.diff
	${MAKE} test5_compile
	@echo "test_rundir..." >> test05_ee.diff
	${MAKE} test5_rundir
	@echo "test5_run..." >> test05_ee.diff
	${MAKE} test5_run
	@echo "test5_check..." >> test05_ee.diff
	${MAKE} test5_check

test5_compile:
	./Config.pl -v=Empty,EE/BATSRUS,SC/BATSRUS
	./Config.pl -o=EE:u=Swarm,e=MhdEos,ng=2
	./Config.pl -o=SC:u=ScChromo,e=MhdWavesPe,ng=2
	./Config.pl -g=EE:10,10,10,SC:4,4,4
	${MAKE} SWMF
	make PIDL

test5_rundir:
	rm -rf ${TESTDIR}
	${MAKE} rundir RUNDIR=${DIR}/${TESTDIR}
	cd ${TESTDIR}; cp ../GM/BATSRUS/data/FLUXEMERGENCE/*Sph.dat .
	cd ${TESTDIR}; cp ../GM/BATSRUS/data/FLUXEMERGENCE/EOS.* .
	cd ${TESTDIR}; gunzip *.gz

test5_run:
	cd ${TESTDIR}; cp Param/PARAM.in.test.EE.3D PARAM.in
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog_3d
	cd ${TESTDIR}; ./Restart.pl
	cd ${TESTDIR}; ./PostProc.pl -M RESULTS/run_3d
	cd ${TESTDIR}; cp Param/PARAM.in.test.EE PARAM.in
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog_restart
	cd ${TESTDIR}; ./PostProc.pl -M -cat RESULTS/run_restart; \
	               mv runlog_restart RESULTS/run_restart
	cd ${TESTDIR}; cp Param/PARAM.in.test.SC PARAM.in
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog
	cd ${TESTDIR}; ./Restart.pl
	cd ${TESTDIR}; ./PostProc.pl -M -cat RESULTS/run_SC
	cd ${TESTDIR}; cp Param/PARAM.in.test.EESC PARAM.in
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M -cat RESULTS/coupled

test5_check:
	-(${DIFFNUM} -b -a=1e-15 \
		${TESTDIR}/RESULTS/coupled/EE/log_n000010.log \
		output/test5/EE.log \
		> test05_ee.diff)
	-(${DIFFNUM} -b \
		${TESTDIR}/RESULTS/coupled/SC/log_n000070.log \
		output/test5/SC.log \
		> test05_sc.diff)
	ls -l test05_*.diff

test5_update:
	cp -f ${TESTDIR}/RESULTS/coupled/EE/log_n000010.log \
		output/test5/EE.log 	
	cp -f ${TESTDIR}/RESULTS/coupled/SC/log_n000070.log \
		output/test5/SC.log 
	${MAKE} test5_check

### test7: IH+OH test ###

test7:
	@echo "test7_compile..." > test07_ih.diff
	@echo "test7_compile..." > test07_oh.diff
	${MAKE} test7_compile
	@echo "test7_rundir..." >> test07_ih.diff
	@echo "test7_rundir..." >> test07_oh.diff
	${MAKE} test7_rundir
	@echo "test7_run..." >> test07_ih.diff
	@echo "test7_run..." >> test07_oh.diff
	${MAKE} test7_run
	@echo "test7_check..." >> test07_ih.diff
	@echo "test7_check..." >> test07_oh.diff
	${MAKE} test7_check

test7_compile:
	./Config.pl -v=Empty,IH/BATSRUS,OH/BATSRUS
	./Config.pl -g=IH:4,4,4,OH:4,4,4
	./Config.pl -o=IH:u=Waves,e=Mhd,ng=2 -o=OH:u=Waves,e=Mhd,ng=2
	${MAKE} SWMF
	make PIDL

test7_rundir:
	rm -rf ${TESTDIR}
	${MAKE} rundir RUNDIR=${DIR}/${TESTDIR}
	cp Param/PARAM.in.test.IHOH.CoupleSphToXyz ${TESTDIR}/PARAM.in

test7_run:
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M RESULTS

test7_check:
	-(${DIFFNUM} -b -r=1e-5 -a=2e-29\
		${TESTDIR}/RESULTS/IH/log_n000000.log \
		output/test7/Sph_IH_log_n000000.log \
		> test07_ih.diff)
	-(${DIFFNUM} -b -r=1e-5 -a=1e-29\
		${TESTDIR}/RESULTS/OH/log_n000000.log \
		output/test7/Xyz_OH_log_n000000.log \
		> test07_oh.diff)
	ls -l test07_*.diff


### test8: SC + IH with Threaded-Field-Line boundary condition test ###

test8:
	@echo "test8_compile..." > test08_sc_thread.diff
	@echo "test8_compile..." > test08_ih.diff
	${MAKE} test8_compile
	@echo "test8_rundir..." >> test08_sc_thread.diff
	@echo "test8_rundir..." >> test08_ih.diff
	${MAKE} test8_rundir
	@echo "test8_run..." >> test08_sc_thread.diff
	@echo "test8_run..." >> test08_ih.diff
	${MAKE} test8_run
	@echo "test8_restart..." >> test08_sc_thread.diff
	@echo "test8_restart..." >> test08_ih.diff
	${MAKE} test8_restart
	@echo "test8_check..." >> test08_sc_thread.diff
	@echo "test8_check..." >> test08_ih.diff
	${MAKE} test8_check

test8_compile:
	./Config.pl -v=Empty,SC/BATSRUS,IH/BATSRUS
	./Config.pl -o=SC:u=ScChromo,e=MhdWavesPe,ng=2
	./Config.pl -o=IH:u=ScChromo,e=MhdWavesPeSignB,ng=2
	./Config.pl -g=SC:4,4,4,IH:4,4,4
	${MAKE} SWMF
	make PIDL

test8_rundir:
	rm -rf ${TESTDIR}
	${MAKE} rundir RUNDIR=${DIR}/${TESTDIR}
	cp Param/PARAM.in.test.SCIH_threadbc ${TESTDIR}/PARAM.in
	cp GM/BATSRUS/Param/CORONA/RadCoolCorona.dat ${TESTDIR}/RadCoolCorona.dat

test8_run:
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog
	cd ${TESTDIR}; ./Restart.pl

test8_restart:
	cd ${TESTDIR}; cp Param/PARAM.in.test.restart.SCIH_threadbc PARAM.in
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog_restart
	cd ${TESTDIR}; ./PostProc.pl -M -cat RESULTS

test8_check:
	-(${DIFFNUM} -b -r=1e-5 -a=1e-26 \
		${TESTDIR}/RESULTS/SC/log_n000000.log \
		output/test8/SC_log_n000000.log \
		> test08_sc_thread.diff)
	-(${DIFFNUM} -b -r=1e-5 -a=1e-26 \
		${TESTDIR}/RESULTS/SC/rfr_rwi_4_*.outs \
		output/test8/SC_rfr.ref \
		>> test08_sc_thread.diff)
	-(${DIFFNUM} -b -r=1e-5 \
		${TESTDIR}/RESULTS/IH/log_n000000.log \
		output/test8/IH_log_n000000.log \
		> test08_ih.diff)
	ls -l test08_*.diff

test8_update:
	cp -f ${TESTDIR}/RESULTS/SC/log_n000000.log \
		output/test8/SC_log_n000000.log 
	cp -f ${TESTDIR}/RESULTS/IH/log_n000000.log \
		output/test8/IH_log_n000000.log
	${MAKE} test8_check

### test9: SC + IH with new AWSoM updates. Restarting SC and running IH in 2nd and 5th order schemes ### 

test9:
	@echo "test9_compile..." > test09_sc_chromo.diff
	@echo "test9_compile..." > test09_ih.diff
	${MAKE} test9_compile
	@echo "test9_rundir..." >> test09_sc_chromo.diff
	@echo "test9_rundir..." >> test09_ih.diff
	${MAKE} test9_rundir
	@echo "test9_run..." >> test09_sc_chromo.diff
	@echo "test9_run..." >> test09_ih.diff
	${MAKE} test9_run
	@echo "test9_restart..." >> test09_sc_chromo.diff
	@echo "test9_restart..." >> test09_ih.diff
	${MAKE} test9_restart
	@echo "test9_check..." >> test09_sc_chromo.diff
	@echo "test9_check..." >> test09_ih.diff
	${MAKE} test9_check

test9_compile:
	./Config.pl -v=Empty,SC/BATSRUS,IH/BATSRUS
	./Config.pl -g=SC:6,8,8,IH:8,8,8
	./Config.pl -o=SC:u=AwsomFluids,e=MhdWavesPeAnisoPi,ng=2
	./Config.pl -o=IH:u=AwsomFluids,e=MhdWavesPeAnisoPiSignB,ng=3
	${MAKE} SWMF
	make PIDL
	make FDIPS

test9_rundir:
	rm -rf ${TESTDIR}
	${MAKE} rundir RUNDIR=${DIR}/${TESTDIR}
	cp Param/PARAM.in.test.start.SCIH ${TESTDIR}/PARAM.in
	cp GM/BATSRUS/Param/CORONA/RadCoolCorona_8.0.dat ${TESTDIR}/RadCoolCorona_8.0.dat
	cp Param/map_1.out ${TESTDIR}/SC/
	cp -f ${MAGNETOGRAMDIR}/FDIPS.in.orig ${TESTDIR}/SC/FDIPS.in
	perl -i -pe 's/dipole11.out/map_1.out/' ${TESTDIR}/SC/FDIPS.in
	perl -i -pe 's/#(CHANGEPOLARFIELD)/$$1/; s/20/90/ if /n(Theta|Phi)/' ${TESTDIR}/SC/FDIPS.in
	cd ${TESTDIR}/SC; ${PARALLEL} ${NPFLAG} 4 ./FDIPS.exe > runlog_fdips
	cd ${TESTDIR}/SC; ${MAGNETOGRAMDIR}/redistribute.pl fdips_bxyz_np010202.out fdips_bxyz.out
	cd ${TESTDIR}/SC; rm -rf fdips_*_np*.out

test9_run:
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -m RESULTS/run_start
	cd ${TESTDIR}; ./Restart.pl -i RESULTS/run_start/RESTART
	
test9_restart:
	cd ${TESTDIR}; cp Param/PARAM.in.test.restart.SCIH PARAM.in
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -m RESULTS/run_restart

test9_check:
	-(${DIFFNUM} -b -r=1e-5 -a=1e-27 \
		${TESTDIR}/RESULTS/run_start/SC/log_n000001.log \
		output/test9/SC_log_n000001.log \
		> test09_sc_chromo.diff)
	-(${DIFFNUM} -b -r=1e-5 \
		${TESTDIR}/RESULTS/run_restart/IH/log_n000005.log \
		output/test9/IH_log_n000005.log \
		> test09_ih.diff)
	-(${DIFFNUM} -b -r=1e-5 -a=1e-27 \
		${TESTDIR}/RESULTS/run_restart/IH/trj_earth_n00000007.sat \
		output/test9/IH_trj_earth_n00000007.sat \
		> test09_ih_trj_earth.diff)
	ls -l test09_*.diff

### test10: Global Solar Wind Model with three temperatures and Alfven waves

test10:
	@echo "test10_compile..." > test10_sc.diff
	@echo "test10_compile..." > test10_ih.diff
	${MAKE} test10_compile
	@echo "test10_rundir..." >> test10_sc.diff
	@echo "test10_rundir..." >> test10_ih.diff
	${MAKE} test10_rundir
	@echo "test10_run..." >> test10_sc.diff
	@echo "test10_run..." >> test10_ih.diff
	${MAKE} test10_run
	@echo "test10_check..." >> test10_sc.diff
	@echo "test10_check..." >> test10_ih.diff
	${MAKE} test10_check

test10_compile:
	./Config.pl -v=Empty,SC/BATSRUS,IH/BATSRUS
	./Config.pl -o=SC:u=ScChromo,e=MhdWavesPeAnisoPi,ng=2
	./Config.pl -o=IH:u=ScChromo,e=MhdWavesPeAnisoPiSignB,ng=2
	./Config.pl -g=SC:6,4,4,IH:4,4,4
	${MAKE} SWMF
	make PIDL

test10_rundir:
	rm -rf ${TESTDIR}
	${MAKE} rundir RUNDIR=${DIR}/${TESTDIR}
	cp Param/PARAM.in.test.SCIH_3T ${TESTDIR}/PARAM.in

test10_run:
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M RESULTS


test10_check:
	-(${DIFFNUM} -b -r=1e-5 -a=1e-27 \
	        ${TESTDIR}/RESULTS/SC/log_n000000.log \
		output/test10/SC_log_n000000.log \
		> test10_sc.diff)
	-(${DIFFNUM} -b -r=1e-5 \
	        ${TESTDIR}/RESULTS/IH/log_n000000.log \
		output/test10/IH_log_n000000.log \
                > test10_ih.diff)
		ls -l test10*.diff

### test11: Dipole field with solar wind coupled with an exosphere model, to test the GM/PT coupler

test11:
	@echo "test11_compile..." > test11_gm.diff
	@echo "test11_compile..." > test11_pt.diff
	${MAKE} test11_compile
	@echo "test11_rundir..." >> test11_gm.diff
	@echo "test11_rundir..." >> test11_pt.diff
	${MAKE} test11_rundir
	@echo "test11_run..." >> test11_gm.diff
	@echo "test11_run..." >> test11_pt.diff
	${MAKE} test11_run
	@echo "test11_check..." >> test11_gm.diff
	@echo "test11_check..." >> test11_pt.diff
	${MAKE} test11_check

test11_compile:
	./Config.pl -v=Empty,GM/BATSRUS,PT/AMPS
	./Config.pl -g=GM:8,8,8 -o=GM:u=Default,e=Mhd,ng=2
	./Config.pl -o=PT:spice-path=nospice,application=coupler-test
	${MAKE} SWMF
	make PIDL

test11_rundir:
	rm -rf ${TESTDIR}
	${MAKE} rundir RUNDIR=${DIR}/${TESTDIR}
	cp Param/PARAM.in.test.GMPT ${TESTDIR}/PARAM.in

test11_run:
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M RESULTS

# Note: skip columns that depend on number of processors
#       multiply density column by 1e20 to make it order unity
test11_check:
	-(${DIFFNUM} -b -a=1e-27 \
	        ${TESTDIR}/RESULTS/GM/log_n000001.log \
		output/test11/log_n000001.log \
		> test11_gm.diff)
	gunzip -c output/test11/pic.NA.s=0.out=19.dat.gz \
	       	> ${TESTDIR}/RESULTS/PT/pic.NA.ref
	cd ${TESTDIR}/RESULTS/PT; \
	        cp -f pic.NA.s=0.out=19.dat pic.NA.dat; \
	        perl -ai -ne 'print "@F[0..3] @F[6..14] ",1e20*$$F[15]," @F[16..$$#F]\n"' \
			pic.NA.ref pic.NA.dat 
	-(${DIFFNUM} -a=1e-19 -r=1e-6 -b \
	        ${TESTDIR}/RESULTS/PT/pic.NA.dat \
		${TESTDIR}/RESULTS/PT/pic.NA.ref \
                > test11_pt.diff)
		ls -l test11*.diff

### test13: Europa's exosphere model with coupled Gm and PT components

test13:
	@echo "test13_compile..." > test13_pt.diff
	${MAKE} test13_compile
	@echo "test13_rundir..." >> test13_pt.diff
	${MAKE} test13_rundir
	@echo "test13_run..." >> test13_pt.diff
	${MAKE} test13_run
	@echo "test13_check..." >> test13_pt.diff
	${MAKE} test13_check

test13_compile:
	./Config.pl -v=Empty,GM/BATSRUS,PT/AMPS
	./Config.pl -g=GM:8,8,8 -o=GM:u=EuropaSingleMHDPe,e=MhdPe,ng=2
	./Config.pl -o=PT:spice-path=nospice,spice-kernels=nospice,application=europa-test,amps-test=on 
	${MAKE} SWMF

test13_rundir:
	rm -rf ${TESTDIR}
	${MAKE} rundir RUNDIR=${DIR}/${TESTDIR}
	cp Param/PARAM.in.test.GMPT.Europa ${TESTDIR}/PARAM.in
	cp -r PT/AMPS/data/input/Europa/TestCase/RESTART_n003000 ${TESTDIR}/

test13_run:
	cd ${TESTDIR}; ./Restart.pl -i RESTART_n003000
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog

test13_check:
	cp output/test13/amps.ref_np`ls ${TESTDIR}/PT/thread* | wc -l | tr -d ' '` \
	${TESTDIR}/PT/plots/amps.ref
	-(${DIFFNUM} -b \
		${TESTDIR}/PT/plots/amps.dat \
		${TESTDIR}/PT/plots/amps.ref \
		> test13_pt.diff)
		ls -l test13*.diff

### test14: OH/BATSRUS (single-ion) coupled with PT/AMPS

test14:
	@echo "test14_compile..." > test14_ohpt.diff
	${MAKE} test14_compile
	@echo "test14_rundir..." >> test14_ohpt.diff
	${MAKE} test14_rundir
	@echo "test14_run..." >> test14_ohpt.diff
	${MAKE} test14_run
	@echo "test14_check..." >> test14_ohpt.diff
	${MAKE} test14_check

test14_compile:
	./Config.pl -v=Empty,OH/BATSRUS,PT/AMPS
	./Config.pl -g=OH:4,4,4 -o=OH:u=OuterHelio,e=Mhd,ng=2
	./Config.pl -o=PT:spice-path=nospice,spice-kernels=nospice,application=oh,amps-test=on 
	${MAKE} SWMF
	make PIDL

test14_rundir:
	rm -rf ${TESTDIR}
	${MAKE} rundir RUNDIR=${DIR}/${TESTDIR}
	cp Param/PARAM.in.test.OHPT ${TESTDIR}/PARAM.in

test14_run:
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog
	cd ${TESTDIR}; rm -rf RESULTS; ./PostProc.pl -M RESULTS

test14_check:
	-(${DIFFNUM} -b -r=1e-5 -a=1e-29\
		${TESTDIR}/RESULTS/OH/log_n000000.log \
		output/test14/OH_log_n000000.log \
		> test14_ohpt.diff)
	cp output/test14/amps.ref_np`ls ${TESTDIR}/PT/thread* | wc -l | tr -d ' '` \
	${TESTDIR}//RESULTS/PT/amps.ref
	-(${DIFFNUM} -b \
		${TESTDIR}/RESULTS/PT/amps.dat \
		${TESTDIR}/RESULTS/PT/amps.ref \
		>> test14_ohpt.diff)
	ls -l test14*.diff


### test14pui: OH/BATSRUS with PUI (multi-ion) coupled with PT/AMPS

test14pui:
	@echo "test14pui_compile..." > test14pui_ohpt.diff
	${MAKE} test14pui_compile
	@echo "test14pui_rundir..." >> test14pui_ohpt.diff
	${MAKE} test14pui_rundir
	@echo "test14pui_run..." >> test14pui_ohpt.diff
	${MAKE} test14pui_run
	@echo "test14pui_check..." >> test14pui_ohpt.diff
	${MAKE} test14pui_check

test14pui_compile:
	./Config.pl -v=Empty,OH/BATSRUS,PT/AMPS
	./Config.pl -g=OH:4,4,4 -o=OH:u=OuterHelioPUI,e=SwhPui,ng=2
	./Config.pl -o=PT:spice-path=nospice,spice-kernels=nospice,application=oh,amps-test=on 
	${MAKE} SWMF
	make PIDL

test14pui_rundir:
	rm -rf ${TESTDIR}
	${MAKE} rundir RUNDIR=${DIR}/${TESTDIR}
	cp Param/PARAM.in.test.OHPTpui ${TESTDIR}/PARAM.in

test14pui_run:
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog
	cd ${TESTDIR}; rm -rf RESULTS; ./PostProc.pl -M RESULTS

test14pui_check:
	-(${DIFFNUM} -b -r=1e-5 -a=1e-21 \
		${TESTDIR}/RESULTS/OH/log_n000000.log \
		output/test14pui/OH_log_n000000.log \
		> test14pui_ohpt.diff)
	cp output/test14pui/amps.ref_np`ls ${TESTDIR}/PT/thread* | wc -l | tr -d ' '` \
	${TESTDIR}/RESULTS/PT/amps.ref
	-(${DIFFNUM} -b \
		${TESTDIR}/RESULTS/PT/amps.dat \
		${TESTDIR}/RESULTS/PT/amps.ref \
		>> test14pui_ohpt.diff)
		ls -l test14pui*.diff

### test15: SP/MFLAMPA model coupled with SC and IH models
test15_build:
	rm -rf SP_build
	Scripts/Configure.pl -on=SP,SC,IH -off=IM,IE,RB -d=SP_build
	cd SP_build; ./Config.pl -install \
	   	     	-compiler=${FORTRAN_COMPILER_NAME},${C_COMPILER_NAME}
	cd SP_build; make test15

test15:
	rm -f test15*.diff
	${MAKE} test15_scihsp
	${MAKE} test15_sp

test15_scihsp:
	@echo "test15_scihsp_compile..." > test15_scihsp.diff
	${MAKE} test15_scihsp_compile
	@echo "test15_scihsp_rundir..." >> test15_scihsp.diff
	${MAKE} test15_scihsp_rundir
	@echo "test15_scihsp_run..." >> test15_scihsp.diff
	${MAKE} test15_scihsp_run
	@echo "test15_scihsp_restart..." >> test15_scihsp.diff
	${MAKE} test15_scihsp_restart
	@echo "test15_scihsp_check..." >> test15_scihsp.diff
	${MAKE} test15_scihsp_check

test15_sp:
	@echo "test15_sp_compile..." > test15_sp.diff
	${MAKE} test15_sp_compile
	@echo "test15_sp_rundir..." >> test15_sp.diff
	${MAKE} test15_sp_rundir
	@echo "test15_sp_run..." >> test15_sp.diff
	${MAKE} test15_sp_run
	@echo "test15_sp_check..." >> test15_sp.diff
	${MAKE} test15_sp_check

test15_scihsp_compile:
	./Config.pl -v=Empty,SC/BATSRUS,IH/BATSRUS,SP/MFLAMPA
	./Config.pl -o=SC:u=ScChromo,e=MhdWavesPe,ng=2
	./Config.pl -o=IH:u=ScChromo,e=MhdWavesPe,ng=2
	./Config.pl -g=SC:4,4,4,IH:4,4,4,SP:2000
	${MAKE} SWMF
	make PIDL

test15_scihsp_rundir:
	rm -rf ${TESTDIR}
	${MAKE} rundir RUNDIR=${DIR}/${TESTDIR}
	cp Param/PARAM.in.test.SCIHSP ${TESTDIR}/PARAM.in
	cp GM/BATSRUS/Param/CORONA/RadCoolCorona.dat ${TESTDIR}/RadCoolCorona.dat
	cp -r SP/MFLAMPA/data/input/test15/RESTART_t0020.0000s ${TESTDIR}/

test15_scihsp_run:
	cp Param/PARAM.in.test.SCIHSP ${TESTDIR}/PARAM.in
	cd ${TESTDIR}; ./Restart.pl -i RESTART_t0020.0000s
	cd ${TESTDIR}; rm -rf RESTART_t0025.0000s
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog
	cd ${TESTDIR}; ./Restart.pl

test15_scihsp_restart:
	cd ${TESTDIR}; cp Param/PARAM.in.test.restart.SCIHSP PARAM.in
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog_restart
	cd ${TESTDIR}; ./PostProc.pl -M RESULTS

test15_scihsp_check:
	-(${DIFFNUM} -a=1e-6 -r=1e-6 -b \
		${TESTDIR}/RESULTS/SP/MH_data_*_*_t00000030_n000010.out \
		output/test15/MH_data.ref \
		> test15_scihsp.diff)
	ls -l test15*.diff
	rm -rf SP/MFLAMPA/data/input/test15/MH_data/
	mkdir SP/MFLAMPA/data/input/test15/MH_data/
	cp ${TESTDIR}/RESULTS/SP/MH_data.lst \
	SP/MFLAMPA/data/input/test15/MH_data/.
	cp ${TESTDIR}/RESULTS/SP/MH_data.H \
	SP/MFLAMPA/data/input/test15/MH_data/.
	cp ${TESTDIR}/RESULTS/SP/MH_data*n*.out \
	SP/MFLAMPA/data/input/test15/MH_data/.

test15_sp_compile:
	./Config.pl -v=Empty,SP/MFLAMPA
	./Config.pl -g=SP:2000
	${MAKE} SWMF
	make PIDL

test15_sp_rundir:
	rm -rf ${TESTDIR}
	${MAKE} rundir RUNDIR=${DIR}/${TESTDIR}
	mkdir ${TESTDIR}/MH_data/
	cp Param/PARAM.in.test.SP ${TESTDIR}/PARAM.in
	cp -r SP/MFLAMPA/data/input/test15/MH_data/*.* ${TESTDIR}/MH_data/.

test15_sp_run:
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M RESULTS

test15_sp_check:
	cp output/test15/MH_data.ref ${TESTDIR}/RESULTS/SP/MH_data.ref
	cat ${TESTDIR}/RESULTS/SP/MH_data_*_*_t00000030_n000010.out > \
	    ${TESTDIR}/RESULTS/SP/MH_data.out
	-(${DIFFNUM} -a=1e-6 -r=1e-6 -b \
		${TESTDIR}/RESULTS/SP/MH_data.out \
		${TESTDIR}/RESULTS/SP/MH_data.ref \
		> test15_sp.diff)
		rm -rf SP/MFLAMPA/data/input/test15/MH_data/
		ls -l test15*.diff


### test16: GM/BATSRUS+PC/FLEKS. BATSRUS only provides the initial condition.
###         FLEKS runs with periodic boundary conditions.

test16:
	@echo "test16_compile..." > test16.diff
	$(MAKE) test16_compile
	@echo "test16_rundir..." > test16.diff
	$(MAKE) test16_rundir
	@echo "test16_run..." > test16.diff
	$(MAKE) test16_run
	@echo "test16_check..." > test16.diff
	$(MAKE) test16_check

test16_compile:
	./Config.pl -v=Empty,PC/FLEKS,GM/BATSRUS -amrex
	./Config.pl -g=GM:8,8,1 -o=GM:u=Waves,e=MultiIonPe,ng=2
	$(MAKE) SWMF
	$(MAKE) PIDL
	
test16_rundir:
	rm -rf ${TESTDIR}
	$(MAKE) rundir RUNDIR=${DIR}/${TESTDIR} COMPDIR=GM,PC
	cp Param/PARAM.in.test.GMPC.FLEKS.periodic  ${TESTDIR}/PARAM.in

test16_run:
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl RESULTS

test16_check:
	-@(${DIFFNUM} -b -r=1e-12 \
	   ${TESTDIR}/RESULTS/PC/z=0_fluid_region0_0_t00000002_n00000007.out \
	   output/test16/z=0.ref.gz \
		> test16.diff)
	-@(${DIFFNUM} -b -r=1e-12 \
	   ${TESTDIR}/RESULTS/PC/log_n00000000.log \
	   output/test16/PC.log \
		>> test16.diff)		
	ls -l test16.diff


### test17: GM/BATSRUS+PC/FLEKS. 2D Alfven wave

test17:
	@echo "test17_compile..." > test17.diff
	$(MAKE) test17_compile
	@echo "test17_rundir..." > test17.diff
	$(MAKE) test17_rundir
	@echo "test17_run..." > test17.diff
	$(MAKE) test17_run
	@echo "test17_check..." > test17.diff
	$(MAKE) test17_check

test17_compile:
	./Config.pl -v=Empty,PC/FLEKS,GM/BATSRUS -amrex
	./Config.pl -g=GM:8,8,1 -o=GM:u=Waves,e=MhdAnisoP,ng=2
	$(MAKE) SWMF
	$(MAKE) PIDL
	
test17_rundir:
	rm -rf ${TESTDIR}
	$(MAKE) rundir RUNDIR=${DIR}/${TESTDIR} COMPDIR=GM,PC
	cp Param/PARAM.in.test.GMPC.FLEKS.2D.2steps  ${TESTDIR}/PARAM.in

test17_run:
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl RESULTS/2step
	cd ${TESTDIR}; ./Restart.pl -v -i RESULTS/2step/RESTART
	cp Param/PARAM.in.test.GMPC.FLEKS.2D.restart ${TESTDIR}/PARAM.in
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl RESULTS/2restart
	cp Param/PARAM.in.test.GMPC.FLEKS.2D.4steps  ${TESTDIR}/PARAM.in
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl RESULTS/4steps
	

test17_check:
	-@(${DIFFNUM} -b -r=1e-7 \
	   ${TESTDIR}/RESULTS/2restart/PC/z=0_fluid_region0_0_t00000005_n00000004.out \
	   output/test17/z=0_FLEKS0.ref.gz \
		> test17.diff)
	-@(${DIFFNUM} -b -r=1e-7 \
	   ${TESTDIR}/RESULTS/2restart/PC/z=0_fluid_region1_0_t00000004_n00000007.out \
	   output/test17/z=0_FLEKS1.ref.gz \
		>> test17.diff)
	-@(${DIFFNUM} -b -r=1e-7 \
	   ${TESTDIR}/RESULTS/4steps/PC/z=0_fluid_region0_0_t00000005_n00000004.out \
	   output/test17/z=0_FLEKS0.ref.gz \
		>> test17.diff)
	-@(${DIFFNUM} -b -r=1e-7 \
	   ${TESTDIR}/RESULTS/4steps/PC/z=0_fluid_region1_0_t00000004_n00000007.out \
	   output/test17/z=0_FLEKS1.ref.gz \
		>> test17.diff)					
	-@(${DIFFNUM} -b -r=1e-7 \
	   ${TESTDIR}/RESULTS/2restart/GM/z=0_var_1_t00000005_n00000004.out \
	   output/test17/z=0_GM.ref.gz \
		>> test17.diff)
	-@(${DIFFNUM} -b -r=1e-7 \
	   ${TESTDIR}/RESULTS/4steps/GM/z=0_var_1_t00000005_n00000004.out \
	   output/test17/z=0_GM.ref.gz \
		>> test17.diff)

	ls -l test17.diff


### test18: BATSRUS+FLEKS. 3D reconnection

test18:
	@echo "test18_compile..." > test18.diff
	$(MAKE) test18_compile
	@echo "test18_rundir..." > test18.diff
	$(MAKE) test18_rundir
	@echo "test18_run..." > test18.diff
	$(MAKE) test18_run
	@echo "test18_check..." > test18.diff
	$(MAKE) test18_check

test18_compile:
	./Config.pl -v=Empty,PC/FLEKS,GM/BATSRUS -amrex
	./Config.pl -g=GM:4,4,4 -o=GM:u=GemReconnect,e=MhdHyp,ng=2
	$(MAKE) SWMF
	$(MAKE) PIDL
	
test18_rundir:
	rm -rf ${TESTDIR}
	$(MAKE) rundir RUNDIR=${DIR}/${TESTDIR} COMPDIR=GM,PC
	cp Param/PARAM.in.test.GMPC.FLEKS.3D  ${TESTDIR}/PARAM.in

test18_run:
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl RESULTS

test18_check:
	-@(${DIFFNUM} -b -r=1e-6 \
		${TESTDIR}/RESULTS/PC/3d_var_region0_0_t00000004_n00000004.out \
		output/test18/3d.ref.gz \
		> test18.diff)
	ls -l test18.diff


### test_ramscb: GM+IE+IM/RAMSCB ###

test_ramscb:
	@echo "test_ramscb_compile..." > test_ramscb_gm.diff
	@echo "test_ramscb_compile..." > test_ramscb_ie.diff
	@echo "test_ramscb_compile..." > test_ramscb_im.diff
	${MAKE} test_ramscb_compile
	@echo "test_ramscb_rundir..." >> test_ramscb_gm.diff
	@echo "test_ramscb_rundir..." >> test_ramscb_ie.diff
	@echo "test_ramscb_rundir..." >> test_ramscb_im.diff
	${MAKE} test_ramscb_rundir
	@echo "test_ramscb_run..." >> test_ramscb_gm.diff
	@echo "test_ramscb_run..." >> test_ramscb_ie.diff
	@echo "test_ramscb_run..." >> test_ramscb_im.diff
	${MAKE} test_ramscb_run
	@echo "test_ramscb_check..." >> test_ramscb_gm.diff
	@echo "test_ramscb_check..." >> test_ramscb_ie.diff
	@echo "test_ramscb_check..." >> test_ramscb_im.diff
	${MAKE} test_ramscb_check

test_ramscb_compile:
	./Config.pl -v=Empty,GM/BATSRUS,IE/Ridley_serial,IM/RAM_SCB
	./Config.pl -g=GM:8,8,8,IE:91,181 -o=GM:u=Default,e=Mhd,ng=2
	${MAKE} SWMF
	make PIDL

test_ramscb_rundir:
	rm -rf ${TESTDIR}
	${MAKE} rundir RUNDIR=${DIR}/${TESTDIR}
	cp ${IMDIR}/input/PARAM.in.test.gmieim.simple ${TESTDIR}/PARAM.in

test_ramscb_run:
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -M RESULTS

test_ramscb_check:
	-@(${DIFFNUM} -b -r=1e-3 -a=1e-8 \
		${TESTDIR}/RESULTS/GM/log_n000001.log \
		${IMDIR}/output/test9/GM_log_n000001.log \
		> test_ramscb_gm.diff)
	-@(${DIFFNUM} -b -r=1e-3 -a=1e-8 \
		${TESTDIR}/RESULTS/IM/ram/log_n000001.log \
		${IMDIR}/output/test9/IM_log_n000001.log \
		> test_ramscb_im.diff)
	-@(${DIFFNUM} -b -r=1e-6 \
		${TESTDIR}/RESULTS/IE/IE*.log \
		${IMDIR}/output/test9/IE.log \
		> test_ramscb_ie.diff)
	ls -l test_ramscb*.diff

######## test PC/IPIC3D and PC/AMPS coupled with GM/BATSRUS #########

.NOTPARALLEL: test12

test12:
	-$(MAKE) test12_aniso_AMPS           TESTDIR=run_test12_aniso_AMPS
	-$(MAKE) test12_aniso_AMPS_divE_corr TESTDIR=run_test12_aniso_AMPS_divE_corr
	-$(MAKE) test12_aniso_AMPS_dynamic   TESTDIR=run_test12_aniso_AMPS_dynamic
	-$(MAKE) test12_aniso_AMPS_openmp    TESTDIR=run_test12_aniso_AMPS_openmp
	./Config.pl -noopenmp -o=PC:openmp=off
	-$(MAKE) test12_aniso TESTDIR=run_test12_aniso
	-$(MAKE) test12_iso   TESTDIR=run_test12_iso
	-$(MAKE) test12_3d    TESTDIR=run_test12_3d

######## test PC coupled with GM/BATSRUS #########

test12_aniso_AMPS:
	@echo "test12_aniso_AMPS_compile..." > test12_aniso_AMPS_gmpc.diff
	$(MAKE) test12_aniso_AMPS_compile
	@echo "test12_aniso_AMPS_rundir..." > test12_aniso_AMPS_gmpc.diff
	$(MAKE) test12_aniso_AMPS_rundir
	@echo "test12_aniso_AMPS_run..." > test12_aniso_AMPS_gmpc.diff
	$(MAKE) test12_aniso_AMPS_run
	@echo "test12_aniso_AMPS_check..." > test12_aniso_AMPS_gmpc.diff
	$(MAKE) test12_aniso_AMPS_check

test12_aniso_AMPS_compile:
	./Config.pl -v=Empty,GM/BATSRUS,PC/AMPS
	./Config.pl -g=GM:8,8,8 -o=GM:u=Waves,e=MhdAnisoP,ng=2
	./Config.pl -o=PC:spice-path=nospice,spice-kernels=nospice,application=fluid-pic-coupler,amps-test=on 
	$(MAKE) SWMF
	$(MAKE) PIDL
	
test12_aniso_AMPS_rundir:
	rm -rf ${TESTDIR}
	$(MAKE) rundir RUNDIR=${DIR}/${TESTDIR} COMPDIR=GM,PC
	cp Param/PARAM.in.test.GMPC.aniso.AMPS  ${TESTDIR}/PARAM.in

test12_aniso_AMPS_run:
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -m RESULTS/5step
	cp Param/PARAM.in.test.GMPC.aniso.AMPS.2step  ${TESTDIR}/PARAM.in
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -m RESULTS/2step
	cd ${TESTDIR}; ./Restart.pl -v -i RESULTS/2step/RESTART
	cp Param/PARAM.in.test.GMPC.aniso.AMPS.2step.restart ${TESTDIR}/PARAM.in
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -m RESULTS/2restart	

test12_aniso_AMPS_check:
	-@(${DIFFNUM} -b -a=2.0e-3 \
	   ${TESTDIR}/RESULTS/5step/PC/3d_fluid_region0_0_t00000005_n00000005.out \
	   output/test12/3d_aniso.out.gz \
		> test12_aniso_AMPS_gmpc.diff)
	-@(${DIFFNUM} -b -a=2.0e-3 \
	   ${TESTDIR}/RESULTS/2restart/PC/3d_fluid_region0_0_t00000005_n00000005.out \
	   output/test12/3d_aniso.out.gz \
		>> test12_aniso_AMPS_gmpc.diff)
	ls -l test12_aniso_AMPS_gmpc.diff

#########################################################

test12_aniso_AMPS_divE_corr:
	@echo "test12_aniso_AMPS_divE_corr_compile..." > test12_aniso_AMPS_divE_corr_gmpc.diff
	$(MAKE) test12_aniso_AMPS_divE_corr_compile
	@echo "test12_aniso_AMPS_divE_corr_rundir..." > test12_aniso_AMPS_divE_corr_gmpc.diff
	$(MAKE) test12_aniso_AMPS_divE_corr_rundir
	@echo "test12_aniso_AMPS_divE_corr_run..." > test12_aniso_AMPS_divE_corr_gmpc.diff
	$(MAKE) test12_aniso_AMPS_divE_corr_run
	@echo "test12_aniso_AMPS_divE_corr_check..." > test12_aniso_AMPS_divE_corr_gmpc.diff
	$(MAKE) test12_aniso_AMPS_divE_corr_check

test12_aniso_AMPS_divE_corr_compile:
	./Config.pl -v=Empty,GM/BATSRUS,PC/AMPS
	./Config.pl -g=GM:8,8,8 -o=GM:u=Waves,e=MhdAnisoP,ng=2
	./Config.pl -o=PC:spice-path=nospice,spice-kernels=nospice,application=fluid-pic-coupler-with-correction,amps-test=on 
	$(MAKE) SWMF
	$(MAKE) PIDL
	
test12_aniso_AMPS_divE_corr_rundir:
	rm -rf ${TESTDIR}
	$(MAKE) rundir RUNDIR=${DIR}/${TESTDIR} COMPDIR=GM,PC
	cp Param/PARAM.in.test.GMPC.aniso.AMPS.corr  ${TESTDIR}/PARAM.in

test12_aniso_AMPS_divE_corr_run:
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -m RESULTS/5step_corr

test12_aniso_AMPS_divE_corr_check:
	-@(${DIFFNUM} -b -a=2.0e-3 \
	   ${TESTDIR}/RESULTS/5step_corr/PC/3d_fluid_region0_0_t00000005_n00000005.out \
	   output/test12/3d_aniso_divE.out.gz \
		> test12_aniso_AMPS_divE_corr_gmpc.diff)
	ls -l test12_aniso_AMPS_divE_corr_gmpc.diff

#########################################################

test12_aniso_AMPS_openmp:
	@echo "test12_aniso_AMPS_openmp_compile..." > test12_aniso_AMPS_openmp_gmpc.diff
	$(MAKE) test12_aniso_AMPS_openmp_compile
	@echo "test12_aniso_AMPS_openmp_rundir..." > test12_aniso_AMPS_openmp_gmpc.diff
	$(MAKE) test12_aniso_AMPS_openmp_rundir
	@echo "test12_aniso_AMPS_openmp_run..." > test12_aniso_AMPS_openmp_gmpc.diff
	$(MAKE) test12_aniso_AMPS_openmp_run
	@echo "test12_aniso_AMPS_openmp_check..." > test12_aniso_AMPS_openmp_gmpc.diff
	$(MAKE) test12_aniso_AMPS_openmp_check

test12_aniso_AMPS_openmp_compile:
	./Config.pl -v=Empty,GM/BATSRUS,PC/AMPS
	./Config.pl -g=GM:8,8,8 -o=GM:u=Waves,e=MhdAnisoP,ng=2
	./Config.pl -openmp -o=PC:spice-path=nospice,spice-kernels=nospice,application=fluid-pic-coupler,amps-test=on,openmp=on 
	$(MAKE) SWMF
	$(MAKE) PIDL
	
test12_aniso_AMPS_openmp_rundir:
	rm -rf ${TESTDIR}
	$(MAKE) rundir RUNDIR=${DIR}/${TESTDIR} COMPDIR=GM,PC
	cp Param/PARAM.in.test.GMPC.aniso.AMPS  ${TESTDIR}/PARAM.in

test12_aniso_AMPS_openmp_run:
	cd ${TESTDIR}; ${OMPIRUN} ./SWMF.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -m RESULTS

test12_aniso_AMPS_openmp_check:
	-@(${DIFFNUM} -b -a=2.0e-3 \
	   ${TESTDIR}/RESULTS/PC/3d_fluid_region0_0_t00000005_n00000005.out \
	   output/test12/3d_aniso.out.gz \
		> test12_aniso_AMPS_openmp_gmpc.diff)
	ls -l test12_aniso_AMPS_openmp_gmpc.diff

#########################################################
test12_aniso_AMPS_dynamic:
	@echo "test12_aniso_AMPS_dynamic_compile..." > test12_aniso_AMPS_dynamic_gmpc.diff
	$(MAKE) test12_aniso_AMPS_dynamic_compile
	@echo "test12_aniso_AMPS_dynamic_rundir..." > test12_aniso_AMPS_dynamic_gmpc.diff
	$(MAKE) test12_aniso_AMPS_dynamic_rundir
	@echo "test12_aniso_AMPS_dynamic_run..." > test12_aniso_AMPS_dynamic_gmpc.diff
	$(MAKE) test12_aniso_AMPS_dynamic_run
	@echo "test12_aniso_AMPS_dynamic_check..." > test12_aniso_AMPS_dynamic_gmpc.diff
	$(MAKE) test12_aniso_AMPS_dynamic_check

test12_aniso_AMPS_dynamic_compile:
	./Config.pl -v=Empty,GM/BATSRUS,PC/AMPS
	./Config.pl -g=GM:8,8,8 -o=GM:u=Waves,e=MhdAnisoP,ng=2
	./Config.pl -o=PC:spice-path=nospice,spice-kernels=nospice,application=fluid-pic-coupler-dynamic,amps-test=on 
	$(MAKE) SWMF
	$(MAKE) PIDL
	
test12_aniso_AMPS_dynamic_rundir:
	rm -rf ${TESTDIR}
	$(MAKE) rundir RUNDIR=${DIR}/${TESTDIR} COMPDIR=GM,PC
	cp Param/PARAM.in.test.GMPC.aniso.AMPS.dynamic  ${TESTDIR}/PARAM.in

test12_aniso_AMPS_dynamic_run:
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -m RESULTS

test12_aniso_AMPS_dynamic_check:
	-@(${DIFFNUM} -b -a=2.0e-3 \
	   ${TESTDIR}/RESULTS/PC/3d_fluid_region0_0_t00000010_n00000010.out \
	   output/test12/3d_AMPS_aniso_dynamic_gmpc.out.gz \
		> test12_aniso_AMPS_dynamic_gmpc.diff)
	ls -l test12_aniso_AMPS_dynamic_gmpc.diff

#########################################################
test12_aniso:
	@echo "test12_aniso_compile..." > test12_aniso_gmpc.diff
	$(MAKE) test12_aniso_compile
	@echo "test12_aniso_rundir..." > test12_aniso_gmpc.diff
	$(MAKE) test12_aniso_rundir
	@echo "test12_aniso_run..." > test12_aniso_gmpc.diff
	$(MAKE) test12_aniso_run
	@echo "test12_aniso_check..." > test12_aniso_gmpc.diff
	$(MAKE) test12_aniso_check

test12_aniso_compile:
	./Config.pl -v=Empty,PC/IPIC3D2,GM/BATSRUS
	./Config.pl -g=GM:8,8,1 -o=GM:u=Waves,e=MhdAnisoP,ng=2
	$(MAKE) SWMF
	$(MAKE) PIDL
	
test12_aniso_rundir:
	rm -rf ${TESTDIR}
	$(MAKE) rundir RUNDIR=${DIR}/${TESTDIR} COMPDIR=GM,PC
	cp Param/PARAM.in.test.GMPC.start.aniso  ${TESTDIR}/PARAM.in

test12_aniso_run:
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -m RESULTS/4step
	cp Param/PARAM.in.test.GMPC.start.2step.aniso ${TESTDIR}/PARAM.in
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -m RESULTS/2step
	cd ${TESTDIR}; ./Restart.pl -v -i RESULTS/2step/RESTART
	cp Param/PARAM.in.test.GMPC.restart.2step.aniso ${TESTDIR}/PARAM.in
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -m RESULTS/2restart	

test12_aniso_check:
	-@(${DIFFNUM} -b -a=2.0e-3 \
	   ${TESTDIR}/RESULTS/4step/GM/z=0_var_1_t00000005_n00000004.out \
	   output/test12/z=0_var.out.ref.aniso.gz \
		> test12_aniso_gmpc.diff)
	-@(${DIFFNUM} -b -a=2.0e-3 \
	   ${TESTDIR}/RESULTS/2restart/GM/z=0_var_1_t00000005_n00000004.out \
	   output/test12/z=0_var.out.ref.aniso.gz \
		>> test12_aniso_gmpc.diff)
	ls -l test12_aniso_gmpc.diff

#### test IPIC3D.exe coupled with GM/BATSRUS using 3D reconetion #########

test12_3d:
	@echo "test12_3d_compile..." > test12_3d_gm.diff
	$(MAKE) test12_3d_compile
	@echo "test12_3d_rundir..." > test12_3d_gm.diff
	$(MAKE) test12_3d_rundir
	@echo "test12_3d_run..." > test12_3d_gm.diff
	$(MAKE) test12_3d_run
	@echo "test12_3d_check..." > test12_3d_gm.diff
	$(MAKE) test12_3d_check

test12_3d_compile:
	./Config.pl -v=Empty,PC/IPIC3D2,GM/BATSRUS
	./Config.pl -g=GM:4,4,4 -o=GM:u=GemReconnect,e=MhdHyp,ng=2
	$(MAKE) SWMF
	$(MAKE) PIDL
	
test12_3d_rundir:
	rm -rf ${TESTDIR}
	$(MAKE) rundir RUNDIR=${DIR}/${TESTDIR} COMPDIR=GM,PC
	cp Param/PARAM.in.test.GMPC.3D.start  ${TESTDIR}/PARAM.in

test12_3d_run:
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl RESULTS/4step

test12_3d_check:
	-@(${DIFFNUM} -b -a=1e-9 \
	   ${TESTDIR}/RESULTS/4step/GM/x=0_var_1_t00000000_n00000004.out \
	   output/test12/x=0_var.out.ref.3d.gz \
		> test12_3d_gm.diff)
	-@(${DIFFNUM} -b -a=1e-9 \
	   ${TESTDIR}/RESULTS/4step/GM/y=0_var_2_t00000000_n00000004.out \
	   output/test12/y=0_var.out.ref.3d.gz \
		>> test12_3d_gm.diff)
	-@(${DIFFNUM} -b -a=1e-9 \
	   ${TESTDIR}/RESULTS/4step/GM/z=0_var_3_t00000000_n00000004.out \
	   output/test12/z=0_var.out.ref.3d.gz \
		>> test12_3d_gm.diff)
	-@(${DIFFNUM} -b -a=1e-7 -r=1e-7 \
	   ${TESTDIR}/RESULTS/4step/PC/cut_all_region0_0_t00000000_n00000004.out \
	   output/test12/cut_all.out.ref.3d.gz \
		> test12_3d_pc.diff)
	ls -l test12_3d_*.diff

#### test IPIC3D.exe coupled with GM/BATSRUS using isotropic MHD #########

test12_iso:
	@echo "test12_iso_compile..." > test12_iso_gm.diff
	$(MAKE) test12_iso_compile
	@echo "test12_iso_rundir..." > test12_iso_gm.diff
	$(MAKE) test12_iso_rundir
	@echo "test12_iso_run..." > test12_iso_gm.diff
	$(MAKE) test12_iso_run
	@echo "test12_iso_check..." > test12_iso_gm.diff
	$(MAKE) test12_iso_check

test12_iso_compile:
	./Config.pl -v=Empty,PC/IPIC3D2,GM/BATSRUS
	./Config.pl -g=GM:8,8,1 -o=GM:u=Waves,e=MultiIonPe,ng=2
	$(MAKE) SWMF
	$(MAKE) PIDL
	
test12_iso_rundir:
	rm -rf ${TESTDIR}
	$(MAKE) rundir RUNDIR=${DIR}/${TESTDIR} COMPDIR=GM,PC
	cp Param/PARAM.in.test.GMPC.start  ${TESTDIR}/PARAM.in

test12_iso_run:
	cd ${TESTDIR}; ${MPIRUN} ./SWMF.exe > runlog
	cd ${TESTDIR}; ./PostProc.pl -m RESULTS

test12_iso_check:
	-@(${DIFFNUM} -t -a=1e-9 \
	   ${TESTDIR}/RESULTS/GM/z=0_all_1_t00000002_n00000004.out \
	   output/test12/z=0_all.out.ref.iso.gz \
		> test12_iso_gm.diff)
	-@(${DIFFNUM} -b -a=1e-8 \
	   ${TESTDIR}/RESULTS/PC/z=0_fluid_region0_0_t00000002_n00000004.out \
	   output/test12/z=0_fluid.out.ref.iso.gz \
		> test12_iso_pc.diff)
	-@(${DIFFNUM} -b -a=1e-9 \
	   ${TESTDIR}/RESULTS/PC/cut_particles1_region0_1_t00000002_n00000004.out \
	   output/test12/cut_particles1.out.ref.iso.gz \
		>> test12_iso_pc.diff)
	ls -l test12_iso*.diff


