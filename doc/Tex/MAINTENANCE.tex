%^CFG COPYRIGHT UM
\documentclass[twoside,10pt]{article}

\title{Space Weather Modeling Framework Maintenance Manual \\ 
       \hfill \\
       \large Code Version \SWMFVERSION}
\author{Center for Space Environment Modeling\\
       {\it The University of Michigan}}

\input HEADER

%%%
% Maintenance manual
%%%
\section{CVS}

Physics module and framework code is all maintained and developed
through a CVS repository at the University of Michigan.  A developer
can check out either the whole framework and all physics modules, or
any individual physics module and necessary common support code.  All
code changes must be tested (see TESTING.pdf) before committing back
into the CVS repository.  A complete description of changes must be
entered into the CVS logs when committing any change.

%%%
% New Modules
%%%
\section{How to Add a New Component}

\subsection{Requirements to Physics Modules and Components}

The SWMF compliance definitions, both for physics modules and components 
created from them, were formulated in the SWMF Interoperability Document. 
The minimal set of requirements regarding the source code of a physics 
module only, which is the part of the physics module compliance definition, 
is briefly repeated below:

\begin{itemize}
\item The parallelization mechanism must employ the MPI standard only
\item A module must have the structure permitting the following two 
      modes of execution:

   \begin{itemize}
   \item As a stand-alone executable
   \item As a library which could be linked to another executable
   \end{itemize}

\item A module must successfully run the test suite provided by its
developers at least  on SGI Origin 2000 and
Compaq ES45 machines, and
on Linux Beowulf clusters with the NAG F95 compiler.

\item The module must adhere to the following Input/Output requirements:

    \begin{itemize}
    \item Read input data from files only;
    \item Write output data to files only.
    \item The path to these files should be externally set
    \end{itemize}

\item A module must be implemented in the following languages only: Fortran 77, Fortran 90, and C/C++.

\item The following is not permitted in the source code of the module:

    \begin{itemize}
    \item Lack of modularity and absence of point entry 
          for other software tools
    \item Input-output that cannot be turned off or redirected
    \item Absence of error handling in the code
    \item Pointers that do not return error conditions
\end{itemize}

\item The source code of the module should be documented 
      at least through appropriate comments in source files.
\end{itemize}

The physics module should be converted to a SWMF component by constructing 
standard interfaces from programming blocks provided by the SWMF.
The first standard interface is a wrapper. 
In addition to that for each link with another component
the coupling interface must be constructed.
The standard interfaces must at least enable the following 
features of a component:
\begin{itemize}
\item To be registered by the Control Module;
\item To be initialized in parallel configuration;
\item To accept and check input parameters obtained from the Control Module;
\item To initialize for session execution and provide grid description to 
      Control Module;
\item To execute a time step, provide simulation time which cannot exceed
      a specified maximum simulation time
\item To receive and provide data to other components via the coupler in 
      the Control Module;
\item To write its state into a restart file when requested;
\item To finalize at the end of the execution;
\end{itemize}
There are restrictions regarding I/O operations and error handling:
\begin{itemize}
\item Input data must be read from the subdirectory with the component name
      in the directory \textbf{run};
\item Output data must be written into files in the subdirectory 
      with the component name in the directory \textbf{run};
\item Errors should call the {\tt CON\_stop} methods with an appropriate
      error message. No {\tt stop} statements are allowed;
\item Standard output should be prefixed with a string identifying the
      component and/or redirected into a file defined by the 
      Control Module.
\end{itemize}

The inclusion of a new physics code as  an alternative component 
for the physics domain, which is already covered by the SWMF, 
is a relatively simple task. The inclusion of the first component of 
the new physics domain is slightly more demanding task.

\subsection{New Physics Code as an Alternative Component}

To add new physics code as an alternative component which is already part of 
the SWMF, a user should perform the following steps:

\begin{itemize}
\item Add a subdirectory for this code in the directory of the 
appropriate physics model (i.e. in one of the GM, IH, IE etc.
directories).

\item Create a subdirectory \textbf{src} and put the physics code into 
      this directory.
 
\item Write the code top-level Makefile (you may use any of the
      existing component Makefile-s as an example),
      which should have the targets:

\begin{itemize}
\item install - creates Makefile.DEPEND and does the fine 
                tuning of the build scripts 
                for the component, for instance, sets the specific 
                compilation rules for files which 
                could not be compiled with the generic rules 
\item LIB - builds the component library
\item clean - cleans the \textbf{src} subdirectory
\item distclean - discards all the files created since installation
\item rundir - copies files and directories that are needed to run the 
               component into the directory \textbf{run}
\end{itemize}

\item Include the top level Makefile.conf into the top-level Makefile

\item Write a wrapper file for the new component. 
      This can be placed into src or a separate srcInterface directory.
      The wrapper is constructed as 
      a set of external subroutines which we will call methods below. 
      The method names must have the prefix 
      of the physics domain with underscore, for example GM\_, IE\_ and etc. 
      The following methods are required for a new version of the
      SP component, for example:

\begin{itemize}
\item SP\_set\_param
\item SP\_set\_grid
\item SP\_init\_session
\item SP\_run
\item SP\_save\_restart
\item SP\_finalize
\end{itemize}

\item Write a set of put and get routines for each component, 
      with which your component should be coupled.

\item Extend the couplers in {\tt CON/Interface/src} as necessary.

\item Provide a PARAM.XML file in the component version directory
      to describe all the input commands.

\item Provide a GridSize.pl script in the component version directory
      to show and change the grid size of the component.

\item Add the new component version in the main {\tt Makefile} and
      in {\tt CON/Makefile.def}

\end{itemize}

\subsection{Adding a new Physics Component}

To include a new physics component which covers a new physics domain
(for example Radiation Belt), it is necessary to perform the following steps:
\begin{itemize}
\item Create the subdirectory for this physics domain (e.g. RB/) 

\item Create version subdirectories
      for an empty and at least one working version 
      (e.g. RB/Rice/ and RB/Empty/)

\item Add entries for this physics domain to the 
      {\tt CON\_wrapper.f90} and {\tt CON\_couple\_all.f90}
      files in {\tt CON/Interface/src}.

\item Add the new component with all versions in the main {\tt Makefile}, in 
      {\tt CON/Makefile.def} and link it as a library in
      {\tt CON/Control/src/Makefile}.

\item Create the new coupling interfaces in {\tt CON/Interface/src}

\item Add the new component and the new couplings in all 
      input command definitions 
      which list the components or couplings explicitly in Param/PARAM.XML.

\item Add the new component into the \$ValidComp variable in
      SetSWMF.pl and in share/Scripts/CheckParam.pl

\item List the new component and the new couplings in a few 
      commands in Param/PARAM.XML

\item Do all the steps described in the previous section.
\end{itemize}
The files {\tt CON/Interface/src/CON\_wrapper.f90} and 
{\tt CON\_couple\_all.f90} play the role 
of switchboards for all wrappers and coupling interfaces, respectively. 
In other words these two files emulate dynamic dispatching or run-time 
polymorphism in Fortran 90 written code. They allow to use a single
subroutine name for a component method and resolve at run-time which 
particular component method was called.

%%%
% Bug Reporting
%%%
\section{Reporting Bugs}

Bugzilla is the Center for Space Environment Modeling (CSEM)
bug-tracking system and is used to submit and review defects that have
been found in the Space Weather Modeling Framework (SWMF) and other
CSEM projects. Bugzilla is not an avenue for technical assistance or
support, but simply a bug tracking system. If you submit a defect,
please provide detailed information in your submission after you have
queried Bugzilla to ensure the defect has not been reported yet. 

\begin{itemize}
\item
Community members can use this system to file bugs and to perform
searches on the bug database. 
\item
Developers can use the system to obtain details of bugs assigned to
them, and to prioritize bug-fixing activities. 
\end{itemize}

The Bugzilla system is available here:

\begin{verbatim}
      http://csem.engin.umich.edu/bugzilla/
\end{verbatim}

%%%
% Known Issues
%%%
\section{Known Issues}
\input{../RELEASENOTES}


\end{document}
